<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SolarSanchay ‚Äì Haryana</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f4f6fb; }

/* Header */
.header {
  background:#fff;
  border-bottom:3px solid #0b5ed7;
  padding:12px;
}
.header-title { font-weight:700; }

/* Intent cards */
.intent-card {
  border:2px solid #ddd;
  border-radius:12px;
  padding:16px;
  cursor:pointer;
  transition:0.2s;
  background:#fff;
}
.intent-card:hover { border-color:#0b5ed7; }
.intent-card.active {
  border-color:#0b5ed7;
  background:#eef4ff;
}
.intent-card h6 { font-weight:700; }

/* Forms */
label { font-weight:600; }
input::placeholder { color:#aaa; }

/* Result */
.result-box {
  background:#fff;
  border-radius:12px;
  padding:16px;
  margin-bottom:14px;
  box-shadow:0 2px 8px rgba(0,0,0,0.06);
}

/* Bill Card */
.bill-card {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  cursor: pointer;
  transition: all 0.3s;
}
.bill-card:hover {
  border-color: #0b5ed7;
  box-shadow: 0 4px 12px rgba(11, 94, 215, 0.1);
}
.bill-card.selected {
  border-color: #0b5ed7;
  background: #eef4ff;
}

/* Stat Cards */
.stat-card {
  padding: 1.5rem;
  border-radius: 12px;
  text-align: center;
  color: white;
  margin-bottom: 1rem;
}

/* Modal */
.custom-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.custom-modal.show {
  display: flex;
}
.modal-content-custom {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

/* Spinner */
.spinner {
  border: 3px solid #f3f4f6;
  border-top: 3px solid #0b5ed7;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Validation */
.is-invalid { border-color:#dc3545; }
.invalid-feedback { display:block; }

/* Mobile */
@media (max-width:768px){
  .govt-text { display:none; }
}
.helper-wrapper {
  background: #f3f7ff;
  border: 2px dashed #6c8cff;
}

.helper-card {
  border: 2px solid #6c8cff;
  background: #ffffff;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="container d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <img src="assests/haryana-logo.jpg" style="height:55px;margin-right:12px">
      <div>
        <div class="header-title">SolarSanchay ‚Äì Haryana</div>
        <small class="text-muted">Solar Savings Estimation Tool</small>
      </div>
    </div>
    <div class="govt-text text-muted">NIC, Kurukshetra</div>
  </div>
</div>

<div class="container my-3">

<!-- INTENT SELECTION -->
<div id="intentSection">
  <h6 class="mb-2">What do you want to do?</h6>

  <div class="intent-card mb-2" id="intentOne"
       onclick="selectIntent('one')">
    <h6>‚ö° One-time Saving Check</h6>
    <small class="text-muted">Quick calculation, no data saved</small>
  </div>

  <div class="intent-card mb-2" id="intentSave"
       onclick="selectIntent('save')">
    <h6>üíæ Save for Future Reference</h6>
    <small class="text-muted">Maintain bill history & analysis</small>
  </div>

  <div class="intent-card" id="intentDashboard"
       onclick="selectIntent('dashboard')">
    <h6>üìä My Dashboard</h6>
    <small class="text-muted">View, edit & manage saved bills</small>
  </div>
</div>

<!-- HELPFUL LINKS -->
<div id="helperCards"
     class="mt-4 p-3 rounded helper-wrapper">

  <div class="mb-2 text-muted small">
    <h5>Helpful resources before you start</h5>
  </div>

  <div class="row g-3">
  <!-- DOWNLOAD BILL -->
  <div class="col-md-4">
   <div class="card helper-card h-100 shadow-sm">
      <div class="card-body">
        <h6 class="card-title">üìÑ Download Electricity Bill</h6>
        <a href="https://www.uhbvn.org.in/web/portal/auth?lastPage=/view-bill"
           target="_blank"
           class="btn btn-outline-primary btn-sm">
          Open Bill Portal
        </a>
      </div>
    </div>
  </div>

  <!-- HELP / TERMINOLOGY -->
  <div class="col-md-4">
    <div class="card helper-card h-100 shadow-sm">
      <div class="card-body">
        <h6 class="card-title">‚ÑπÔ∏è Understanding Bill Terms</h6>
        <button class="btn btn-outline-secondary btn-sm"
                onclick="openHelpModal()">
          View Explanation
        </button>
      </div>
    </div>
  </div>

  <!-- WHY THIS TOOL -->
  <div class="col-md-4">
    <div class="card helper-card h-100 shadow-sm">
      <div class="card-body">
        <h6 class="card-title">‚òÄÔ∏è Why use SolarSaving?</h6>
        <span class="badge bg-success">No login ‚Ä¢ Secure data</span>
      </div>
    </div>
  </div>
  </div>
</div>
    

<!-- INTENT SUMMARY -->
<div id="intentSummary" class="alert alert-info d-none">
  <span id="intentText"></span>
  <button class="btn btn-sm btn-link" onclick="resetIntent()">Change</button>
</div>

<!-- AUTHENTICATION SECTION (for Dashboard) -->
<div class="card p-3 mb-3 d-none" id="authSection">
  <h6>üîê Login to Dashboard</h6>
  <label>Meter Number</label>
  <input id="authMeter" class="form-control mb-2" placeholder="Enter meter number">
  <label>Account Number</label>
  <input id="authAccount" class="form-control mb-2" placeholder="Enter account number">
  <button class="btn btn-primary w-100" onclick="authenticateUser()">Login</button>
  <button class="btn btn-secondary w-100 mt-2" onclick="resetIntent()">Back</button>
</div>

<!-- DASHBOARD SECTION -->
<div class="d-none" id="dashboardSection">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="mb-0">üìä My Dashboard</h6>
    <div id="userInfo" class="text-muted small"></div>
  </div>
  <div id="billsList"></div>
  <button class="btn btn-secondary w-100 mt-3" onclick="logout()">Logout</button>
</div>

<!-- IDENTITY -->
<div class="card p-3 mb-3 d-none" id="identitySection">
  <h6>Consumer Identification</h6>
  <label>Bill Number (e.g. 123456)</label>
  <input id="billNumber" class="form-control mb-2" placeholder="Enter bill number">
  <label>Meter Number (e.g. 24600455)</label>
  <input id="meter" class="form-control mb-2" placeholder="Enter meter number">
  <label>Account Number (e.g. ACC12345)</label>
  <input id="accountNum" class="form-control" placeholder="Enter account number">
</div>

<!-- BILL PERIOD -->
<div class="card p-3 mb-3 d-none" id="billPeriodSection">
  <h6>Bill Period</h6>
  <label>From</label>
  <input type="date" id="billFrom" class="form-control mb-2">
  <label>To</label>
  <input type="date" id="billTo" class="form-control">
</div>

<!-- CONSUMPTION -->
<div class="card p-3 mb-3 d-none" id="consumptionSection">
  <h6>Consumption & Charges</h6>
  <label>Gross Units (e.g. 1354)</label>
 <div class="input-group mb-2">
  <input id="gross"
    type="text"
    inputmode="numeric"
    class="form-control"
    placeholder="Enter value"
 oninput="handleNumericInput(this)">

  <button class="btn btn-outline-secondary"
          type="button"
          onclick="appendPlus('gross')">
    +
  </button>
</div>


  <label>Import Units (e.g. 1114)</label>
 <div class="input-group mb-2">
  <input id="importU"
    type="text"
    inputmode="numeric"
    class="form-control"
    placeholder="Enter value"
oninput="handleNumericInput(this)"
onblur="validateUnits()">

  <button class="btn btn-outline-secondary"
          type="button"
          onclick="appendPlus('importU')">
    +
  </button>
</div>

  <label>Export Units (e.g. 944)</label>
 <div class="input-group mb-2">
  <input id="exportU"
    type="text"
    inputmode="numeric"
    class="form-control"
    placeholder="Enter value"
oninput="handleNumericInput(this)"
onblur="validateUnits()">

  <button class="btn btn-outline-secondary"
          type="button"
          onclick="appendPlus('exportU')">
    +
  </button>
</div>

  
  <label>Fixed Charges ‚Çπ (e.g. 1605)</label>
 <div class="input-group mb-2">
  <input id="fixed"
    type="text"
    inputmode="numeric"
    class="form-control"
    placeholder="Enter amount"
oninput="handleNumericInput(this)">

  <button class="btn btn-outline-secondary"
          type="button"
          onclick="appendPlus('fixed')">
    +
  </button>
</div>


  <label>Total Bill Amount ‚Çπ (e.g. 2700)</label>
 <div class="input-group mb-2">
  <input id="totalBill"
    type="text"
    inputmode="numeric"
    class="form-control"
    placeholder="Enter amount"
oninput="handleNumericInput(this)">

  <button class="btn btn-outline-secondary"
          type="button"
          onclick="appendPlus('totalBill')">
    +
  </button>
</div>


 
    <label>Arrears ‚Çπ (if any)</label>
 <div class="input-group mb-2">
  <input id="arrears"
    type="text"
    inputmode="numeric"
    class="form-control"
    placeholder="Enter amount"
oninput="handleNumericInput(this)">

  <button class="btn btn-outline-secondary"
          type="button"
          onclick="appendPlus('arrears')">
    +
  </button>
</div>

</div>
<button id="actionBtn"
        class="btn btn-primary w-100 d-none"
        onclick="calculate()">
  Calculate Solar Saving
</button>

<div id="result" class="mt-4"></div>

</div>

<!-- Custom Modal -->
<div id="customModal" class="custom-modal">
  <div class="modal-content-custom">
    <div style="text-align: center; font-size: 3rem;" id="modalIcon">‚úÖ</div>
    <h4 style="text-align: center; margin: 1rem 0;" id="modalTitle">Success</h4>
    <div id="modalMessage" style="color: #64748b;"></div>
    <div id="modalButtons" style="display: flex; gap: 1rem; margin-top: 1.5rem;"></div>
  </div>
</div>

<footer class="mt-5 py-3 text-center"
        style="background:#f8f9fa;border-top:1px solid #dee2e6;">
  <small class="text-muted">
    Developed by <b>National Informatics Centre (NIC), Kurukshetra</b><br>
    for <b>District Administration, Kurukshetra</b><br><br>
  </small>
  Last Updated: <span id="lastModified"></span>
</footer>

<script>
// ==========================================
// GLOBAL VARIABLES
// ==========================================
let entryMode = "one";
let currentUser = null;
let userBills = [];
let selectedBillIndex = null;

// Elements
const gross = document.getElementById("gross");
const importU = document.getElementById("importU");
const exportU = document.getElementById("exportU");
const fixed = document.getElementById("fixed");
const totalBill = document.getElementById("totalBill");
const arrears = document.getElementById("arrears");
const result = document.getElementById("result");

// ==========================================
// INTENT SELECTION
// ==========================================
function selectIntent(type){
  entryMode = type;

  const intentSection = document.getElementById("intentSection");
  const helper = document.getElementById("helperCards");
  const intentSummary = document.getElementById("intentSummary");
  const intentText = document.getElementById("intentText");

  // Sections
  const consumption = document.getElementById("consumptionSection");
  const identity = document.getElementById("identitySection");
  const billPeriod = document.getElementById("billPeriodSection");
  const authSection = document.getElementById("authSection");
  const dashboardSection = document.getElementById("dashboardSection");

  // Button
  const actionBtn = document.getElementById("actionBtn");

  // Hide intent selector cards
  if (intentSection) intentSection.classList.add("d-none");
  if (helper) helper.classList.add("d-none");

  if (type === "dashboard") {
    // Show authentication for dashboard
    authSection.classList.remove("d-none");
    consumption.classList.add("d-none");
    identity.classList.add("d-none");
    billPeriod.classList.add("d-none");
    actionBtn.classList.add("d-none");
    dashboardSection.classList.add("d-none");
    if (intentSummary) intentSummary.classList.add("d-none");
  } else {
    // Show intent summary
    if (intentSummary && intentText) {
      intentSummary.classList.remove("d-none");
      intentText.innerHTML =
        type === "one"
          ? "‚úî <b>One-time Analysis:</b> No data will be saved"
          : "‚úî <b>Save for Future:</b> Bill details will be stored";
    }

    // Show main sections
    consumption.classList.remove("d-none");
    billPeriod.classList.remove("d-none");
    authSection.classList.add("d-none");
    dashboardSection.classList.add("d-none");

    // Mode-specific sections
    if (type === "save") {
      identity.classList.remove("d-none");
      actionBtn.innerText = "üíæ Save & Submit";
    } else {
      identity.classList.add("d-none");
      actionBtn.innerText = "üîç Calculate Saving";
    }

    actionBtn.classList.remove("d-none");
  }
}

// ==========================================
// AUTHENTICATION & DASHBOARD
// ==========================================
async function authenticateUser() {
  const meter = document.getElementById('authMeter').value.trim();
  const account = document.getElementById('authAccount').value.trim();
  
  if (!meter || !account) {
    showErrorModal('‚ö†Ô∏è Please enter both Meter and Account Number');
    return;
  }
  
  const authSection = document.getElementById('authSection');
  authSection.innerHTML += '<div id="authLoading" style="text-align: center; margin-top: 1rem;"><div class="spinner"></div></div>';
  
  try {
    const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-authenticate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ meterNumber: meter, accountNumber: account })
    });
    
    let data = await response.json();
    
    // Handle array-wrapped response
    if (Array.isArray(data)) {
      data = data[0];
    }
    
    document.getElementById('authLoading')?.remove();
    
    if (data.status === 'success' && data.authenticated) {
      currentUser = { meter, account };
      userBills = Array.isArray(data.bills) ? data.bills : [];
      
      showSuccessModal(`‚úÖ Login Successful!<br><br>Found ${data.billCount} bill(s).`);
      
      setTimeout(() => {
        closeModal();
        showDashboard();
      }, 1500);
      
    } else {
      if (data.billCount === 0 || data.message.includes('No records')) {
        showModal('‚ÑπÔ∏è', 'No Bills Found', `
          <p>You haven't saved any bills yet.</p>
          <p><strong>First time user?</strong></p>
          <p>Save a bill using "Save for Future Reference" option.</p>
        `, [
          { text: 'Save First Bill', type: 'primary', action: () => { closeModal(); selectIntent('save'); } },
          { text: 'Cancel', type: 'secondary', action: closeModal }
        ]);
      } else {
        showErrorModal('‚ùå Authentication Failed<br><br>Invalid credentials.');
      }
    }
  } catch (error) {
    document.getElementById('authLoading')?.remove();
    console.error(error);
    showErrorModal('‚ùå Connection error. Please try again.');
  }
}

async function authenticateUserSilent() {
  const meter = currentUser.meter;
  const account = currentUser.account;
  
  try {
    const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-authenticate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ meterNumber: meter, accountNumber: account })
    });
    
    let data = await response.json();
    if (Array.isArray(data)) data = data[0];
    
    if (data.status === 'success' && data.authenticated) {
      currentUser = { meter, account };
      userBills = Array.isArray(data.bills) ? data.bills : [];
      displayBillsList();
    } else {
      showErrorModal('Failed to refresh dashboard');
    }
  } catch (error) {
    console.error(error);
    showErrorModal('‚ùå Failed to refresh');
  }
}

function showDashboard() {
  document.getElementById('authSection').classList.add('d-none');
  document.getElementById('dashboardSection').classList.remove('d-none');
  document.getElementById('userInfo').textContent = `Meter: ${currentUser.meter} | Account: ${currentUser.account}`;
  displayBillsList();
}

function displayBillsList() {
  const billsList = document.getElementById('billsList');
  
  if (!userBills || userBills.length === 0) {
    billsList.innerHTML = `
      <div style="text-align: center; padding: 3rem; color: #64748b;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
        <p style="font-size: 1.2rem; font-weight: 600;">No Bills Found</p>
      </div>
    `;
    return;
  }
  
  const totalSavings = userBills.reduce((sum, bill) => sum + parseFloat(bill['Solar Saving Amount'] || 0), 0);
  const avgSaving = totalSavings / userBills.length;
  
  billsList.innerHTML = `
    <div class="row g-2 mb-3">
      <div class="col-md-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Total Bills</div>
          <div style="font-size: 2rem; font-weight: 700;">${userBills.length}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Total Savings</div>
          <div style="font-size: 2rem; font-weight: 700;">‚Çπ${totalSavings.toFixed(0)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Avg Saving</div>
          <div style="font-size: 2rem; font-weight: 700;">‚Çπ${avgSaving.toFixed(0)}</div>
        </div>
      </div>
    </div>

    <div class="row g-2 mb-3">
      <div class="col-md-4">
        <button class="btn btn-primary w-100" onclick="viewSelectedBill()" id="viewBtn" disabled>
          üìÑ View
        </button>
      </div>
      <div class="col-md-4">
        <button class="btn btn-warning w-100" onclick="editSelectedBill()" id="editBtn" disabled>
          ‚úèÔ∏è Edit
        </button>
      </div>
      <div class="col-md-4">
        <button class="btn btn-danger w-100" onclick="deleteSelectedBill()" id="deleteBtn" disabled>
          üóëÔ∏è Delete
        </button>
      </div>
    </div>

    <div id="billCards">
      ${userBills.map((bill, index) => createBillCard(bill, index)).join('')}
    </div>
  `;
}

function createBillCard(bill, index) {
  const billDate = bill['Entry DateTime'] ? new Date(bill['Entry DateTime']).toLocaleDateString('en-IN') : 'N/A';
  const saving = parseFloat(bill['Solar Saving Amount'] || 0);
  const savingPercent = parseFloat(bill['Saving Percentage'] || 0);
  const billAmount = parseFloat(bill['Total Bill Amount'] || 0);
  
  return `
    <div class="bill-card" onclick="selectBill(${index})">
      <div class="d-flex align-items-center gap-3">
        <input type="radio" name="billSelection" value="${index}" 
               style="width: 20px; height: 20px; cursor: pointer;"
               onchange="selectBill(${index})">
        
        <div class="flex-grow-1">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <div style="font-weight: 700; font-size: 1.1rem; color: #1e3a8a;">
                Bill #${bill['Bill Number'] || 'N/A'}
              </div>
              <div style="font-size: 0.85rem; color: #64748b;">
                üìÖ ${billDate}
              </div>
            </div>
            <div class="text-end">
              <div style="font-size: 0.85rem; color: #64748b;">Bill Amount</div>
              <div style="font-weight: 600; color: #1e3a8a;">‚Çπ${billAmount.toFixed(0)}</div>
            </div>
          </div>
          
          <div class="row g-2 pt-2" style="border-top: 1px solid #e2e8f0;">
            <div class="col-6">
              <div style="font-size: 0.75rem; color: #64748b;">Solar Saving</div>
              <div style="font-weight: 700; font-size: 1.3rem; color: #10b981;">‚Çπ${saving.toFixed(0)}</div>
            </div>
            <div class="col-6">
              <div style="font-size: 0.75rem; color: #64748b;">Saving %</div>
              <div style="font-weight: 700; font-size: 1.3rem; color: #3b82f6;">${savingPercent.toFixed(1)}%</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function selectBill(index) {
  selectedBillIndex = index;
  
  document.getElementById('viewBtn').disabled = false;
  document.getElementById('editBtn').disabled = false;
  document.getElementById('deleteBtn').disabled = false;
  
  document.querySelectorAll('input[name="billSelection"]').forEach((radio, i) => {
    radio.checked = (i === index);
  });
  
  document.querySelectorAll('.bill-card').forEach((card, i) => {
    if (i === index) {
      card.classList.add('selected');
    } else {
      card.classList.remove('selected');
    }
  });
}

function viewSelectedBill() {
  if (selectedBillIndex === null) {
    showErrorModal('Please select a bill first');
    return;
  }
  
  const bill = userBills[selectedBillIndex];
  
  const modalContent = `
    <div style="text-align: left;">
      <h5 style="color: #1e3a8a; margin-bottom: 1.5rem;">Bill Details</h5>
      
      <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <table class="table table-sm">
          <tr>
            <td><strong>Bill Number:</strong></td>
            <td>${bill['Bill Number'] || 'N/A'}</td>
          </tr>
          <tr>
            <td><strong>Meter Number:</strong></td>
            <td>${bill['Meter Number'] || 'N/A'}</td>
          </tr>
          <tr>
            <td><strong>Entry Date:</strong></td>
            <td>${bill['Entry DateTime'] ? new Date(bill['Entry DateTime']).toLocaleString('en-IN') : 'N/A'}</td>
          </tr>
        </table>
      </div>
      
      <h6 style="color: #1e3a8a; margin: 1rem 0;">Consumption</h6>
      <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <table class="table table-sm">
          <tr><td>Gross Units:</td><td>${bill['Gross Units'] || 0}</td></tr>
          <tr><td>Import Units:</td><td>${bill['Import Units'] || 0}</td></tr>
          <tr><td>Export Units:</td><td>${bill['Export Units'] || 0}</td></tr>
        </table>
      </div>
      
      <h6 style="color: #1e3a8a; margin: 1rem 0;">Charges & Savings</h6>
      <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
        <table class="table table-sm">
          <tr><td>Fixed Charges:</td><td>‚Çπ${bill['Fixed Charges'] || 0}</td></tr>
          <tr><td>Total Bill:</td><td>‚Çπ${bill['Total Bill Amount'] || 0}</td></tr>
          <tr class="table-success"><td><strong>Solar Saving:</strong></td><td><strong>‚Çπ${bill['Solar Saving Amount'] || 0}</strong></td></tr>
          <tr class="table-info"><td><strong>Saving %:</strong></td><td><strong>${bill['Saving Percentage'] || 0}%</strong></td></tr>
        </table>
      </div>
    </div>
  `;
  
  showModal('üìÑ', 'Bill Details', modalContent, [
    { text: 'Close', type: 'secondary', action: closeModal }
  ]);
}

function editSelectedBill() {
  if (selectedBillIndex === null) {
    showErrorModal('Please select a bill first');
    return;
  }
  
  const bill = userBills[selectedBillIndex];
  
  const modalContent = `
    <div style="text-align: left;">
      <h5 style="color: #1e3a8a; margin-bottom: 1rem;">Edit Bill</h5>
      <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 1.5rem;">
        Editing: Bill #${bill['Bill Number']}
      </p>
      
      <div class="mb-3">
        <label class="form-label">Gross Units *</label>
        <input type="number" class="form-control" id="editGross" value="${bill['Gross Units'] || ''}">
      </div>
      <div class="mb-3">
        <label class="form-label">Import Units *</label>
        <input type="number" class="form-control" id="editImport" value="${bill['Import Units'] || ''}">
      </div>
      <div class="mb-3">
        <label class="form-label">Export Units *</label>
        <input type="number" class="form-control" id="editExport" value="${bill['Export Units'] || ''}">
      </div>
      <div class="mb-3">
        <label class="form-label">Fixed Charges (‚Çπ) *</label>
        <input type="number" class="form-control" id="editFixed" value="${bill['Fixed Charges'] || ''}">
      </div>
      <div class="mb-3">
        <label class="form-label">Total Bill (‚Çπ) *</label>
        <input type="number" class="form-control" id="editTotal" value="${bill['Total Bill Amount'] || ''}">
      </div>
      <div class="mb-3">
        <label class="form-label">Revision Reason</label>
        <input type="text" class="form-control" id="editReason" placeholder="Why are you updating this?">
      </div>
    </div>
  `;
  
  showModal('‚úèÔ∏è', 'Edit Bill', modalContent, [
    { text: 'Cancel', type: 'secondary', action: closeModal },
    { text: 'Save Changes', type: 'primary', action: saveEditedBill }
  ]);
}

async function saveEditedBill() {
  const bill = userBills[selectedBillIndex];
  
  const updatedData = {
    billNumber: bill['Bill Number'],
    meterNumber: bill['Meter Number'],
    accountNumber: bill['Account Number'],
    entryType: 'EDIT',
    revisionReason: document.getElementById('editReason').value || 'Updated by user',
    grossUnits: parseFloat(document.getElementById('editGross').value),
    importUnits: parseFloat(document.getElementById('editImport').value),
    exportUnits: parseFloat(document.getElementById('editExport').value),
    fixedCharges: parseFloat(document.getElementById('editFixed').value),
    totalBillAmount: parseFloat(document.getElementById('editTotal').value)
  };
  
  closeModal();
  
  const billsList = document.getElementById('billsList');
  billsList.innerHTML = '<div style="text-align: center; padding: 3rem;"><div class="spinner"></div><p style="margin-top: 1rem; color: #64748b;">Updating bill...</p></div>';
  
  try {
    const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedData)
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      selectedBillIndex = null;
      await authenticateUserSilent();
    } else {
      showErrorModal('Failed to update: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error(error);
    showErrorModal('‚ùå Connection error');
  }
}

function deleteSelectedBill() {
  if (selectedBillIndex === null) {
    showErrorModal('Please select a bill first');
    return;
  }
  
  const bill = userBills[selectedBillIndex];
  
  showModal('‚ö†Ô∏è', 'Confirm Deletion', `
    <p>Are you sure you want to delete this bill?</p>
    <div class="alert alert-danger">
      <div><strong>Bill #${bill['Bill Number']}</strong></div>
      <div class="small mt-2">Entered on: ${bill['Entry DateTime'] ? new Date(bill['Entry DateTime']).toLocaleDateString('en-IN') : 'N/A'}</div>
    </div>
    <p class="small text-muted">This will mark the bill as inactive.</p>
  `, [
    { text: 'Cancel', type: 'secondary', action: closeModal },
    { text: 'Yes, Delete', type: 'primary', action: confirmDeleteBill }
  ]);
}

async function confirmDeleteBill() {
  const bill = userBills[selectedBillIndex];
  
  closeModal();
  
  const billsList = document.getElementById('billsList');
  billsList.innerHTML = '<div style="text-align: center; padding: 3rem;"><div class="spinner"></div><p style="margin-top: 1rem; color: #64748b;">Deleting bill...</p></div>';
  
  try {
    const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        billNumber: bill['Bill Number'],
        meterNumber: bill['Meter Number'],
        accountNumber: bill['Account Number']
      })
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      selectedBillIndex = null;
      await authenticateUserSilent();
    } else {
      showErrorModal('Failed to delete: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error(error);
    showErrorModal('‚ùå Connection error');
  }
}

function logout() {
  currentUser = null;
  userBills = [];
  selectedBillIndex = null;
  resetIntent();
}

// ==========================================
// MODAL FUNCTIONS
// ==========================================
function showModal(icon, title, message, buttons) {
  document.getElementById('modalIcon').textContent = icon;
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalMessage').innerHTML = message;
  
  const btnContainer = document.getElementById('modalButtons');
  btnContainer.innerHTML = '';
  buttons.forEach(btn => {
    const button = document.createElement('button');
    button.className = `btn btn-${btn.type} flex-fill`;
    button.textContent = btn.text;
    button.onclick = btn.action;
    btnContainer.appendChild(button);
  });
  
  document.getElementById('customModal').classList.add('show');
}

function closeModal() {
  document.getElementById('customModal').classList.remove('show');
}

function showSuccessModal(msg) {
  showModal('‚úÖ', 'Success', msg, [{ text: 'OK', type: 'primary', action: closeModal }]);
}

function showErrorModal(msg) {
  showModal('‚ùå', 'Error', msg, [{ text: 'OK', type: 'primary', action: closeModal }]);
}

// ==========================================
// HELPERS
// ==========================================
function openHelpModal() {
  alert("Help content will be shown here");
}

function handleNumericInput(el){
  // Allow +, digits, spaces
  el.value = el.value.replace(/[^0-9+\s]/g,"");
}

function appendPlus(id){
  const el=document.getElementById(id);
  if(!el.value.endsWith("+")) el.value+= el.value ? "+" : "";
  el.focus();
}

function clearErrors(){
  document.querySelectorAll(".invalid-feedback").forEach(e => e.remove());
  document.querySelectorAll(".is-invalid").forEach(e => e.classList.remove("is-invalid"));
}

function parsePlusExpression(input, fieldName) {
  if (!input || !input.trim()) return 0;

  if (!/^[0-9+\s]+$/.test(input)) {
    throw new Error(fieldName + " can contain only numbers and '+' sign");
  }

  let cleaned = input.trim().replace(/\+\s*$/, "");
  const parts = cleaned.split("+");
  let sum = 0;

  for (let part of parts) {
    const val = part.trim();
    if (val === "") continue;
    sum += Number(val);
  }

  return sum;
}

function resetIntent(){
  entryMode = "one";
  currentUser = null;
  userBills = [];
  selectedBillIndex = null;

  document.getElementById("intentSection")?.classList.remove("d-none");
  document.getElementById("helperCards")?.classList.remove("d-none");
  document.getElementById("intentSummary")?.classList.add("d-none");
  document.getElementById("consumptionSection")?.classList.add("d-none");
  document.getElementById("identitySection")?.classList.add("d-none");
  document.getElementById("billPeriodSection")?.classList.add("d-none");
  document.getElementById("authSection")?.classList.add("d-none");
  document.getElementById("dashboardSection")?.classList.add("d-none");
  document.getElementById("actionBtn")?.classList.add("d-none");
  document.getElementById("result").innerHTML = "";
}

function validateUnits(){
  clearErrors();

  let g, i, e;

  try {
    g = entryMode === "save" ? Number(gross.value) : parsePlusExpression(gross.value, "Gross Units");
    i = entryMode === "save" ? Number(importU.value) : parsePlusExpression(importU.value, "Import Units");
    e = entryMode === "save" ? Number(exportU.value) : parsePlusExpression(exportU.value, "Export Units");
  } catch(err) {
    return;
  }

  if (i > g) {
    markError(importU, "Import cannot exceed Gross");
  }

  if (e > i) {
    markError(exportU, "Export cannot exceed Import");
  }
}

function markError(el,msg){
  el.classList.add("is-invalid");
  const d=document.createElement("div");
  d.className="invalid-feedback";
  d.innerText=msg;
  el.parentNode.appendChild(d);
}

// ==========================================
// CALCULATION (Save Mode Integration)
// ==========================================
async function calculate(){
  if(document.querySelector(".is-invalid")){
    alert("Please correct highlighted fields");
    return;
  }

  let g=0, i=0, e=0, f=0, t=0, a=0;

  try {
    g = entryMode === "save" ? Number(gross.value) : parsePlusExpression(gross.value, "Gross Units");
    i = entryMode === "save" ? Number(importU.value) : parsePlusExpression(importU.value, "Import Units");
    e = entryMode === "save" ? Number(exportU.value) : parsePlusExpression(exportU.value, "Export Units");
    f = entryMode === "save" ? Number(fixed.value) : parsePlusExpression(fixed.value, "Fixed Charges");
    t = entryMode === "save" ? Number(totalBill.value) : parsePlusExpression(totalBill.value, "Total Bill Amount");
    a = entryMode === "save" ? Number(arrears.value) : parsePlusExpression(arrears.value, "Arrears");
  } catch (err) {
    alert(err.message);
    return;
  }

  const net=i-e;
  const direct=g-i;
  const unitRate=(t-f)/net;
  const without=(g*unitRate)+f;
  const saving = without - t;
  const savingPercent = (saving / without) * 100;

  const billFromEl = document.getElementById("billFrom");
  const billToEl   = document.getElementById("billTo");

  let days = null;
  let from = null;
  let to = null;

  if (billFromEl && billToEl && billFromEl.value && billToEl.value) {
    from = new Date(billFromEl.value);
    to = new Date(billToEl.value);
    const diffMs = to - from;
    if (diffMs > 0) {
      days = Math.round(diffMs / (1000 * 60 * 60 * 24));
    }
  }

  let savingPerDay = null;
  if (days && days > 0) {
    savingPerDay = saving / days;
  }

  let annualSaving = null;
  if (savingPerDay !== null) {
    annualSaving = savingPerDay * 365;
  }

  // If save mode, send to n8n
  if (entryMode === "save") {
    const billNum = document.getElementById("billNumber").value;
    const meter = document.getElementById("meter").value;
    const accountNum = document.getElementById("accountNum").value;

    if (!billNum || !meter || !accountNum) {
      alert("Please fill Bill Number, Meter Number, and Account Number");
      return;
    }

    const webhookData = {
      billNumber: billNum,
      meterNumber: meter,
      accountNumber: accountNum,
      billPeriod: {
        from: billFromEl.value,
        to: billToEl.value,
        days: days
      },
      consumption: {
        grossUnits: g,
        importUnits: i,
        exportUnits: e,
        directSolarUsed: direct
      },
      charges: {
        fixedCharges: f,
        totalBillAmount: t,
        arrears: a,
        perUnitRate: parseFloat(unitRate.toFixed(2))
      },
      calculation: {
        billWithSolar: t,
        billWithoutSolar: parseFloat(without.toFixed(2)),
        totalSaving: parseFloat(saving.toFixed(2)),
        savingPercentage: parseFloat(savingPercent.toFixed(2)),
        savingPerDay: savingPerDay ? parseFloat(savingPerDay.toFixed(2)) : null,
        annualSaving: annualSaving ? parseFloat(annualSaving.toFixed(2)) : null
      }
    };

    try {
      const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-saving', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(webhookData)
      });

      if (response.ok) {
        const data = await response.json().catch(() => ({ status: 'success' }));

        if (data.status === 'error' && data.code === 'DUPLICATE_FOUND') {
          alert('‚ö†Ô∏è Duplicate bill found! This bill already exists.');
        } else {
          alert('‚úÖ Bill saved successfully!');
        }
      } else {
        throw new Error('Server error');
      }
    } catch (error) {
      console.error(error);
      alert('‚ö†Ô∏è Failed to save. Showing results anyway.');
    }
  }

  // Display results
  result.innerHTML = `
  <div class="result-box">
    <h6>üì• Input Summary</h6>
   <b>Bill Period:</b>
${from ? from.toLocaleDateString("en-IN") : "‚Äî"}
&nbsp; to &nbsp;
${to ? to.toLocaleDateString("en-IN") : "‚Äî"}  |  <b>Total Days:</b> ${days ?? "‚Äî"}<br>

    <b>Gross Units:</b> ${g} <br>
    <b>Import Units:</b> ${i} &nbsp; | &nbsp;
    <b>Export Units:</b> ${e} <br>

    <b>Direct Solar Used:</b> ${direct} units  
    <i class="text-muted">
      (Gross ‚àí Import ‚Üí electricity used directly from solar during daytime)
    </i>
    <hr>

    <b>Fixed Charges:</b> ‚Çπ${f} <br>
    <b>Total Bill Amount:</b> ‚Çπ${t} <br>

    <b>Per-Unit Rate:</b> ‚Çπ${unitRate.toFixed(2)}  
    <i class="text-muted">
      = (Total Bill ‚àí Fixed Charges) √∑ (Import ‚àí Export)
    </i>
  </div>

  <div class="result-box row text-center">
    <h5 class="text-success">
      üí∞ Comparison (Bill)
    </h5>
    <div class="col-6 border-end">
      <h6>‚ùå Without Solar</h6>
      <b class="fs-5">‚Çπ${without.toFixed(0)}</b><br>

      <i class="text-muted">
        (${g} √ó ‚Çπ${unitRate.toFixed(2)}) + ‚Çπ${f}
      </i><br>

      ${days
        ? `<b>Per Day:</b> ‚Çπ${(without/days).toFixed(0)} / day`
        : `<span class="text-muted">Per-day not calculated</span>`
      }
    </div>

    <div class="col-6">
      <h6>‚òÄÔ∏è With Solar</h6>
      <b class="fs-5">‚Çπ${t}</b><br>

      <i class="text-muted">(Actual bill amount)</i><br>

      ${days ? `<b>Per Day:</b> ‚Çπ${(t/days).toFixed(0)} / day` : `<span class="text-muted">Per-day not calculated</span>`}
    </div>
  </div>

  <div class="result-box text-center">
    <h5 class="text-success">
      üí∞ Total Saving: ‚Çπ${saving.toFixed(0)} | ${`<i class="text-muted"> = (‚Çπ${without.toFixed(0)} ‚àí ‚Çπ${t})</i>`}<br>
    </h5>

  ${days && savingPerDay !== null ? `<b>Saving (Per Day):</b> ‚Çπ${savingPerDay.toFixed(0)}<i class="text-muted">
       (‚Çπ${without.toFixed(0)} ‚àí ‚Çπ${t}) √∑ ${days} days </i>` : `<span class="text-muted">Per-day saving not calculated</span>`}<br>
  ${days && annualSaving !== null ? `<b>Estimated Yearly Saving:</b> ‚Çπ${annualSaving.toFixed(0)} / year<b><i class="text-muted">
       Based on current bill's daily saving x 365 days </i>` : ``}

  </div>

  <button class="btn btn-success w-100 mt-2"
    onclick='shareWhatsApp({
      gross:${g},
      importU:${i},
      exportU:${e},
      direct:${direct},
      withSolar:${t},
      withoutSolar:${without.toFixed(0)},
      saving:${saving.toFixed(0)}
    })'>
    üì§ Share Result on WhatsApp
  </button>
`;
}

function shareWhatsApp(data){
  const msg = encodeURIComponent(
`‚òÄÔ∏è SolarSanchay ‚Äì Solar Saving Result

Gross Units: ${data.gross}
Import Units: ${data.importU}
Export Units: ${data.exportU}
Direct Solar Used: ${data.direct} units

Bill With Solar: ‚Çπ${data.withSolar}
Estimated Bill Without Solar: ‚Çπ${data.withoutSolar}

üí∞ Saving: ‚Çπ${data.saving}`
  );
  window.open(`https://wa.me/?text=${msg}`);
}

document.getElementById("lastModified").innerText =
  new Date(document.lastModified).toLocaleString("en-IN");
</script>

</body>
</html>
