<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SolarSanchay ‚Äì Haryana</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* ========================================
   GLOBAL STYLES
   ======================================== */
body {
     background: linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
     background-attachment: fixed;
   }

/* ========================================
   STANDARD CONTAINER FOR ALL SECTIONS
   ======================================== */
.section-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

@media (max-width: 768px) {
  .section-container {
    padding: 0 0.875rem;
  }
}

@media (max-width: 480px) {
  .section-container {
    padding: 0 0.75rem;
  }
}

/* ========================================
   HEADER - PROFESSIONAL STYLING
   ======================================== */
.header {
  background: #fff;
  border-bottom: 3px solid #1e40af;
  padding: 12px;
  margin: 16px 16px 0 16px;
  border-radius: 12px 12px 0 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.header-title { 
  font-weight: 700; 
  font-size: clamp(1.5rem, 4vw, 2.2rem);
  color: #1e3a8a;
  letter-spacing: 0.5px;
  margin: 0;
}

.header-title small {
  display: block;
  font-size: 0.6em;
  font-weight: 400;
  margin-top: 0.25rem;
  opacity: 0.7;
  color: #4b5563;
}

@media (max-width: 768px) {
  .header {
    margin: 12px 12px 0 12px;
    padding: 10px;
    border-radius: 8px 8px 0 0;
  }
  
  .header-title small {
    opacity: 0.6;
    font-size: 0.55em;
  }
}

/* ========================================
   SECTION HEADING
   ======================================== */
.intent-section-heading {
  font-size: 1.4rem;
  color: #1e3a8a;
  font-weight: 700;
  text-align: center;
  margin-bottom: 1.5rem;
}

@media (max-width: 768px) {
  .intent-section-heading {
    font-size: 1rem !important;
    margin-bottom: 0.75rem !important;
  }
}

@media (max-width: 576px) {
  .intent-section-heading {
    font-size: 0.95rem !important;
  }
}

/* ========================================
   INTENT CARDS - CONSOLIDATED
   ======================================== */
.intent-card-modern {
  position: relative;
  background: white;
  border-radius: 12px;
  padding: 1rem 0.875rem;
  cursor: pointer;
  transition: all 0.3s ease;
  overflow: hidden;
  border: 2px solid #e5e7eb;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
  text-align: center;
  min-height: 120px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.intent-card-modern:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
  border-color: #1e40af;
}

.intent-card-modern:active {
  transform: translateY(-2px) scale(0.98);
}

.intent-card-modern:focus {
  outline: 3px solid #fbbf24;
  outline-offset: 3px;
}

/* Icon */
.intent-icon {
  font-size: 2.5rem;
  margin-bottom: 0.625rem;
  animation: float 3s ease-in-out infinite;
  filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.1));
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-7.5px); }
}

/* Title */
.intent-title {
  font-size: 0.95rem;
  font-weight: 700;
  margin-bottom: 0.25rem;
  color: inherit;
  position: relative;
  z-index: 1;
  line-height: 1.2;
}

/* Description */
.intent-desc {
  font-size: 0.7rem;
  opacity: 0.85;
  margin-bottom: 0.5rem;
  position: relative;
  z-index: 1;
  line-height: 1.3;
}

/* Badge */
.intent-badge {
  display: inline-block;
  padding: 0.3rem 0.75rem;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 15px;
  font-size: 0.5625rem;
  font-weight: 600;
  box-shadow: 0 1.5px 3px rgba(0, 0, 0, 0.1);
  position: relative;
  z-index: 1;
}

/* Hover effect */
.intent-hover-effect {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.3));
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}

.intent-card-modern:hover .intent-hover-effect {
  opacity: 1;
}

/* Color Variants */
.intent-card-blue {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.intent-card-blue:hover {
  background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%);
}

.intent-card-blue .intent-badge {
  color: #667eea;
}

.intent-card-green {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  color: white;
}

.intent-card-green:hover {
  background: linear-gradient(135deg, #0e8278 0%, #2ed96c 100%);
}

.intent-card-green .intent-badge {
  color: #11998e;
}

.intent-card-purple {
  background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
  color: white;
}

.intent-card-purple:hover {
  background: linear-gradient(135deg, #d60868 0%, #e65f00 100%);
}

.intent-card-purple .intent-badge {
  color: #ee0979;
}

.intent-card-modern.active {
  border-color: white;
  box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3), 0 9px 18px rgba(0, 0, 0, 0.15);
}

/* ========================================
   MOBILE RESPONSIVENESS - CONSOLIDATED
   ======================================== */

/* Tablet */
@media (min-width: 769px) and (max-width: 1024px) {
  .intent-card-modern {
    min-height: 110px;
    padding: 0.875rem 0.75rem;
  }
  
  .intent-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }
}

/* Mobile */
@media (max-width: 768px) {
  .intent-card-modern {
    min-height: 95px !important;
    padding: 0.875rem 0.625rem !important;
    margin-bottom: 0.5rem;
    border-radius: 10px;
  }
  
  .intent-icon {
    font-size: 1.75rem !important;
    margin-bottom: 0.3rem !important;
    animation: none;
  }
  
  .intent-title {
    font-size: 0.95rem !important;
    margin-bottom: 0.2rem !important;
    font-weight: 600;
  }
  
  .intent-desc {
    font-size: 0.75rem !important;
    margin-bottom: 0 !important;
    line-height: 1.3;
    opacity: 0.9;
  }
  
  .intent-badge {
    display: none !important;
  }
  /* ========================================
   CARD INPUT STYLES - BEAUTIFUL FORM FIELDS
   ======================================== */

/* Card Wrapper */
.card-input-wrapper {
  margin-bottom: 1rem;
}

/* Card Container - Modern Design */
.card-input-container {
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.card-input-container:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
}

/* Top Bar Accent */
.card-top-bar {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: currentColor;
  opacity: 0.7;
}

/* Card Content */
.card-content {
  position: relative;
  z-index: 1;
}

/* Title Row */
.card-title-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

/* Card Title */
.card-input-title {
  font-size: 1rem;
  font-weight: 700;
  margin: 0;
  color: #1e3a8a;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* Card Icon (in title) */
.card-icon {
  font-size: 1.25rem;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}

/* Hint Text */
.card-hint {
  font-size: 0.75rem;
  color: #64748b;
  font-style: italic;
}

/* Input Field Container */
.card-input-field {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

/* The Actual Input Field */
.card-input {
  flex: 1;
  padding: 0.75rem 1rem;
  border: 2px solid rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  background: white;
  transition: all 0.3s ease;
  outline: none;
}

.card-input:focus {
  border-color: #1e40af;
  box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
  transform: scale(1.02);
}

.card-input:hover {
  border-color: rgba(30, 64, 175, 0.3);
}

.card-input::placeholder {
  color: #94a3b8;
  font-weight: 400;
}

/* Action Button (+ button next to input) */
.card-action-btn {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  border: none;
  color: white;
  font-size: 1.25rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.card-action-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.card-action-btn:active {
  transform: scale(0.95);
}

/* Color Variants for Different Cards */
.card-color-blue {
  background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
  border: 2px solid #3b82f6;
}

.card-color-teal {
  background: linear-gradient(135deg, #ccfbf1 0%, #f0fdfa 100%);
  border: 2px solid #14b8a6;
}

.card-color-purple {
  background: linear-gradient(135deg, #e9d5ff 0%, #f3e8ff 100%);
  border: 2px solid #a855f7;
}

.card-color-yellow {
  background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
  border: 2px solid #f59e0b;
}

.card-color-green {
  background: linear-gradient(135deg, #d9f99d 0%, #ecfccb 100%);
  border: 2px solid #84cc16;
}

.card-color-pink {
  background: linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);
  border: 2px solid #ec4899;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .card-input-container {
    padding: 0.875rem;
  }
  
  .card-input-title {
    font-size: 0.9rem;
  }
  
  .card-icon {
    font-size: 1.1rem;
  }
  
  .card-hint {
    font-size: 0.7rem;
  }
  
  .card-input {
    padding: 0.625rem 0.75rem;
    font-size: 0.9rem;
  }
  
  .card-action-btn {
    width: 36px;
    height: 36px;
    font-size: 1.1rem;
  }
}

@media (max-width: 480px) {
  .card-input-wrapper {
    margin-bottom: 0.75rem;
  }
  
  .card-input-container {
    padding: 0.75rem;
  }
  
  .card-input-title {
    font-size: 0.85rem;
  }
  
  .card-input {
    font-size: 0.85rem;
  }
}
  /* Row spacing */
@media (max-width: 768px) {
  #intentSection .row {
    margin-left: -0.375rem;        /* ‚Üê REDUCED */
    margin-right: -0.375rem;
  }
  
  #intentSection .row > [class*='col-'] {
    padding-left: 0.375rem;        /* ‚Üê REDUCED */
    padding-right: 0.375rem;
  }
}
  
  /* Container spacing */
  .container {
    padding-left: 12px !important;
    padding-right: 12px !important;
  }
}

/* Extra small phones */
@media (max-width: 576px) {
  .intent-card-modern {
    min-height: 90px !important;
    padding: 0.75rem 0.5rem !important;
  }
  
  .intent-icon {
    font-size: 1.5rem !important;
    margin-bottom: 0.25rem !important;
  }
  
  .intent-title {
    font-size: 0.9rem !important;
  }
  
  .intent-desc {
    font-size: 0.7rem !important;
  }
}

/* ========================================
   VERIFICATION MODAL
   ======================================== */
.verification-modal {
  display: none;
  position: fixed;
  z-index: 10000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  overflow: auto;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.verification-content {
  background-color: #fff;
  margin: 2% auto;
  padding: 0;
  width: 95%;
  max-width: 1200px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  animation: slideIn 0.3s;
}

@keyframes slideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.verification-header {
  background: linear-gradient(135deg, #166534 0%, #10b981 100%);
  color: white;
  padding: 20px 25px;
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.verification-header h2 {
  margin: 0;
  font-size: 24px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.close-verification {
  color: white;
  font-size: 32px;
  font-weight: bold;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.close-verification:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.verification-body {
  padding: 25px;
}

.guide-image {
  width: 100%;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.guide-warning {
  background: #fff3cd;
  border-left: 4px solid #ffc107;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 6px;
}

.guide-checklist {
  background: #e3f2fd;
  border-left: 4px solid #2196F3;
  padding: 15px;
  border-radius: 6px;
  margin-bottom: 20px;
}

.guide-checklist h3 {
  color: #1565c0;
  margin-top: 0;
  margin-bottom: 12px;
}

.guide-checklist ul {
  color: #1565c0;
  line-height: 1.8;
  margin: 0;
  padding-left: 25px;
}

.guide-checklist ul li {
  margin-bottom: 8px;
}

.guide-checklist strong {
  color: #0d47a1;
}

.got-it-btn {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  display: block;
  margin: 0 auto;
}

.got-it-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

@media (max-width: 768px) {
  .verification-content {
    width: 98%;
    margin: 1% auto;
  }
  
  .verification-header h2 {
    font-size: 18px;
  }
  
  .verification-body {
    padding: 15px;
  }
}
@media (max-width: 768px) {
  a[href*="SolarSanchay-Guide"] { flex: 1; min-width: 120px; text-align: center; }
}
a[href*="SolarSanchay-Guide"]:hover { transform: translateY(-2px); }

/* ========================================
   LEGACY INTENT CARDS (Keep for compatibility)
   ======================================== */
.intent-card {
  border: 2px solid #ddd;
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: 0.2s;
  background: #fff;
}

.intent-card:hover { 
  border-color: #0b5ed7; 
}

.intent-card.active {
  border-color: #0b5ed7;
  background: #eef4ff;
}

.intent-card h6 { 
  font-weight: 700; 
}

/* ========================================
   FORMS
   ======================================== */
label { 
  font-weight: 600; 
}

input::placeholder { 
  color: #aaa; 
}

.is-invalid { 
  border-color: #dc3545; 
}

.invalid-feedback { 
  display: block; 
}

/* ========================================
   RESULT BOX
   ======================================== */
.result-box {
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

/* ========================================
   BILL CARD
   ======================================== */
.bill-card {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  cursor: pointer;
  transition: all 0.3s;
}

.bill-card:hover {
  border-color: #0b5ed7;
  box-shadow: 0 4px 12px rgba(11, 94, 215, 0.1);
}

.bill-card.selected {
  border-color: #0b5ed7;
  background: #eef4ff;
}

/* ========================================
   STAT CARDS
   ======================================== */
.stat-card {
  padding: 1.5rem;
  border-radius: 12px;
  text-align: center;
  color: white;
  margin-bottom: 1rem;
}

/* ========================================
   MODALS
   ======================================== */
.custom-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.custom-modal.show {
  display: flex;
}

.modal-content-custom {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

/* ========================================
   SPINNER
   ======================================== */
.spinner {
  border: 3px solid #f3f4f6;
  border-top: 3px solid #0b5ed7;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ========================================
   HOME BUTTON
   ======================================== */
#simpleHomeBtn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(0,0,0,0.4);
}

#simpleHomeBtn:active {
  transform: scale(0.95);
}

/* ========================================
   CARRY FORWARD WARNING
   ======================================== */
.carry-warning {
  padding: 0.5rem;
  border-radius: 8px;
  margin-top: 0.5rem;
  font-size: 0.9rem;
  border-left: 4px solid;
  animation: slideInWarning 0.3s ease-out;
}

@keyframes slideInWarning {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.carry-warning-info {
  background-color: #cff4fc;
  border-color: #0dcaf0;
  color: #055160;
}

.carry-warning-april {
  background-color: #fff3cd;
  border-color: #ffc107;
  color: #664d03;
}

.carry-warning-success {
  background-color: #d1e7dd;
  border-color: #198754;
  color: #0f5132;
}

/* ========================================
   PRINT STYLES
   ======================================== */
@media print {
  .intent-card-modern {
    break-inside: avoid;
    page-break-inside: avoid;
    box-shadow: none;
    border: 2px solid #333;
  }
  
  .intent-icon {
    animation: none;
  }
}
/* Banner Container */
.doc-banner-wrapper {
  background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
  border-radius: 12px;
  border-left: 6px solid #1e40af;
  padding: 1.25rem;
  box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}

/* Text Section */
.doc-banner-text {
  flex: 1;
  min-width: 200px;
}

/* Button Container */
.doc-banner-buttons {
  display: flex;
  gap: 0.75rem;
  flex-shrink: 0;
}

/* Button Styles */
.doc-btn {
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 700;
  font-size: 0.9rem;
  display: inline-block;
  text-align: center;
  transition: transform 0.2s, box-shadow 0.2s;
  white-space: nowrap;
}

.doc-btn-pdf {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.doc-btn-word {
  background: linear-gradient(135deg, #2563eb, #1e40af);
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.doc-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
}

/* TABLET (768px and below) */
@media (max-width: 768px) {
  .doc-banner-wrapper {
    flex-direction: column;
    text-align: center;
    padding: 1.5rem 1rem;
  }
  
  .doc-banner-text {
    width: 100%;
    margin-bottom: 0.5rem;
  }
  
  .doc-banner-buttons {
    width: 100%;
    justify-content: center;
  }
}

/* MOBILE (480px and below) */
@media (max-width: 480px) {
  .doc-banner-buttons {
    flex-direction: column;
    width: 100%;
  }
  
  .doc-btn {
    width: 100%;
    padding: 0.875rem 1rem;
    font-size: 0.95rem;
  }
}   
/* ========================================
   CARD INPUT STYLES
   ======================================== */

.card-input-wrapper {
  margin-bottom: 1rem;
}

.card-input-container {
  border-radius: 12px;
  padding: 1.25rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.card-input-container:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
}

.card-top-bar {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: currentColor;
  opacity: 0.7;
}

.card-content {
  position: relative;
  z-index: 1;
}

.card-title-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.card-input-title {
  font-size: 1.1rem;
  font-weight: 700;
  margin: 0;
  color: #1e3a8a;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.card-icon {
  font-size: 1.5rem;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}

.card-hint {
  font-size: 0.85rem;
  color: #64748b;
  font-style: italic;
}

.card-input-field {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.card-input {
  flex: 1;
  padding: 0.875rem 1rem;
  border: 2px solid rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  font-size: 1.05rem;
  font-weight: 600;
  background: white;
  transition: all 0.3s ease;
  outline: none;
}

.card-input:focus {
  border-color: #1e40af;
  box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
  transform: scale(1.01);
}

.card-input:hover {
  border-color: rgba(30, 64, 175, 0.3);
}

.card-input::placeholder {
  color: #94a3b8;
  font-weight: 400;
}

.card-action-btn {
  width: 45px;
  height: 45px;
  border-radius: 8px;
  border: none;
  color: white;
  font-size: 1.5rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.card-action-btn:hover {
  transform: scale(1.15);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

.card-action-btn:active {
  transform: scale(0.95);
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .card-input-container {
    padding: 1rem;
  }
  
  .card-input-title {
    font-size: 0.95rem;
  }
  
  .card-icon {
    font-size: 1.25rem;
  }
  
  .card-hint {
    font-size: 0.75rem;
  }
  
  .card-input {
    padding: 0.75rem;
    font-size: 0.95rem;
  }
  
  .card-action-btn {
    width: 38px;
    height: 38px;
    font-size: 1.25rem;
  }
}

@media (max-width: 480px) {
  .card-input-container {
    padding: 0.875rem;
  }
  
  .card-input-title {
    font-size: 0.9rem;
  }
  
  .card-input {
    padding: 0.625rem 0.75rem;
    font-size: 0.9rem;
  }
  
  .card-action-btn {
    width: 36px;
    height: 36px;
    font-size: 1.15rem;
  }
}   
/* ========================================
   CONTAINER CONSISTENCY FIX
   ======================================== */

/* Ensure all containers have same max-width and padding */
.container {
  max-width: 1200px;
  padding-left: 1rem;
  padding-right: 1rem;
  margin-left: auto;
  margin-right: auto;
}

/* Intent section specific */
#intentSection {
  width: 100%;
}

#intentSection .row {
  margin-left: 0;
  margin-right: 0;
}

/* Document banner - match container width */
.doc-banner-wrapper {
  max-width: 100%;
}

/* Quotes section - match container width */
div[style*="background: linear-gradient(135deg, #e0f2fe"] {
  max-width: 100%;
}

/* Responsive padding */
@media (max-width: 768px) {
  .container {
    padding-left: 0.875rem;
    padding-right: 0.875rem;
  }
}

@media (max-width: 576px) {
  .container {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
  }
}
/* ========================================
   SECTION HEADER STYLES
   ======================================== */

/* Section Container */
.section-container {
  margin-bottom: 1.5rem;
}

.section-identity {
  /* Specific styles for identity section if needed */
}

/* Section Header - Main Container */
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
  border: 2px solid #e2e8f0;
  border-left: 6px solid #3b82f6;
  border-radius: 12px;
  padding: 1rem 1.25rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  transition: all 0.3s ease;
}

.section-header:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

/* Section Title Container (Icon + Text) */
.section-title {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex: 1;
}

/* Section Icon */
.section-icon {
  font-size: 2.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 60px;
  height: 60px;
  border-radius: 12px;
  background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
  border: 2px solid #3b82f6;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
  flex-shrink: 0;
}

.section-icon-identity {
  /* Specific styling for identity icon */
  background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
  border-color: #3b82f6;
}

/* Section Title Text */
.section-title-text {
  font-size: 1.25rem;
  font-weight: 700;
  color: #1e3a8a;
  margin: 0;
  line-height: 1.2;
}

/* Section Subtitle */
.section-subtitle {
  display: block;
  font-size: 0.875rem;
  color: #64748b;
  margin-top: 0.25rem;
  font-weight: 400;
}

/* Section Badge */
.section-badge {
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  flex-shrink: 0;
}

.badge-required {
  background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
  color: #92400e;
  border: 2px solid #f59e0b;
}

.badge-optional {
  background: linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%);
  color: #3730a3;
  border: 2px solid #818cf8;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .section-header {
    padding: 0.875rem 1rem;
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }
  
  .section-title {
    gap: 0.75rem;
  }
  
  .section-icon {
    width: 50px;
    height: 50px;
    font-size: 2rem;
  }
  
  .section-title-text {
    font-size: 1.1rem;
  }
  
  .section-subtitle {
    font-size: 0.8rem;
  }
  
  .section-badge {
    align-self: flex-end;
    padding: 0.4rem 0.875rem;
    font-size: 0.75rem;
  }
}

@media (max-width: 480px) {
  .section-header {
    padding: 0.75rem 0.875rem;
  }
  
  .section-icon {
    width: 45px;
    height: 45px;
    font-size: 1.75rem;
  }
  
  .section-title-text {
    font-size: 1rem;
  }
  
  .section-subtitle {
    font-size: 0.75rem;
  }
  
  .section-badge {
    padding: 0.35rem 0.75rem;
    font-size: 0.7rem;
  }
}
.bill-helper-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

.bill-helper-btn:active {
  transform: translateY(0);
}

/* Mobile: Stack vertically */
@media (max-width: 640px) {
  .bill-helper-btn {
    width: 100% !important;
    flex: none !important;
  }
}
</style>
</head>
<body>
<button id="simpleHomeBtn" 
        onclick="goToHome()" 
        style="position: fixed; 
               bottom: 15px; 
               right: 15px; 
               width: 55px; 
               height: 55px; 
               border-radius: 50%; 
               background: linear-gradient(135deg, #0d6efd, #0b5ed7); 
               color: white; 
               border: none; 
               font-size: 1.3rem; 
               box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
               cursor: pointer; 
               z-index: 9999;
               display: none;">
  üè†
</button>
  <div class="container">  
<!-- HEADER -->
<!-- CLEAN PROFESSIONAL HEADER -->
<div class="header" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding: 1.5rem 0;">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between">
      
      <!-- Left: Title with Sun Icon -->
      <div class="d-flex align-items-center gap-3">
        <div style="font-size: 2.5rem;">üåû</div>
        <div>
          <h1 style="color: #ffffff; font-size: 2.2rem; font-weight: 800; margin: 0; text-shadow: 0 2px 8px rgba(0,0,0,0.2);">
            SolarSanchay
          </h1>
<small class="d-none d-md-block" style="color: #ffffff; opacity: 0.95; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.2);">From Units to ‚Çπ Savings ‚Äì Making Solar Benefits Visible</small>
    <small class="d-block d-md-none" style="color: #ffffff; opacity: 0.95; font-weight: 500;">Solar Savings Calculator</small>              </div>
      </div>
      
      <!-- Right: Haryana Logo -->
      <div>
        <img src="assests/haryana-logo.jpg" style="height: 80px; border-radius: 12px; border: 3px solid #fbbf24; box-shadow: 0 4px 16px rgba(251, 191, 36, 0.3);" alt="Haryana">
      </div>
      
    </div>
  </div>
</div>

<div class="container my-3">

<!-- UPDATED HTML -->
<div id="intentSection">
<h6 class="mb-3 text-center intent-section-heading">
  üöÄ How would you like to proceed?
</h6>  
  <div class="row g-3">
    <!-- Card 1: One-time Check -->
<div class="col-md-4">
  <div class="intent-card-modern intent-card-blue" id="intentOne" onclick="selectIntent('one')">
    <div class="intent-icon">‚ö°</div>
    <h6 class="intent-title">Quick Check</h6>
    <p class="intent-desc">Instant estimate</p>
    <div class="intent-hover-effect"></div>
  </div>
</div>

    <!-- Card 2: Save for Future -->
<div class="col-md-4">
  <div class="intent-card-modern intent-card-green" id="intentSave" onclick="selectIntent('save')">
    <div class="intent-icon">üíæ</div>
    <h6 class="intent-title">Save Bills</h6>
    <p class="intent-desc">Track history</p>
    <div class="intent-hover-effect"></div>
  </div>
</div>

    <!-- Card 3: Dashboard -->
<div class="col-md-4">
  <div class="intent-card-modern intent-card-purple" id="intentDashboard" onclick="selectIntent('dashboard')">
    <div class="intent-icon">üìä</div>
    <h6 class="intent-title">Dashboard</h6>
    <p class="intent-desc">View records</p>
    <div class="intent-hover-effect"></div>
  </div>
</div>
  </div>
</div>
<div class="container my-3 d-none" id="billHelpers">
  <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); 
              border: 2px solid #0ea5e9; 
              border-radius: 12px; 
              padding: 1rem 1.25rem;
              box-shadow: 0 2px 8px rgba(14, 165, 233, 0.15);">
    
    <!-- Title -->
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
      <span style="font-size: 1.25rem;">üí°</span>
      <strong style="color: #0c4a6e; font-size: 1rem;">Bill Entry Helpers</strong>
    </div>
    
    <!-- Three Helper Buttons in One Row -->
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
      
      <!-- Scan Button -->
      <button id="openScannerBtn" 
              onclick="openBillScanner()"
              class="bill-helper-btn"
              style="flex: 1; 
                     min-width: 140px;
                     padding: 0.625rem 1rem; 
                     background: linear-gradient(135deg, #10b981, #059669); 
                     color: white; 
                     border: none; 
                     border-radius: 8px; 
                     font-weight: 700; 
                     font-size: 0.875rem;
                     cursor: pointer;
                     box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
                     transition: all 0.3s;
                     white-space: nowrap;">
        üì∑ Scan Bill
      </button>
      
      <!-- Download Link -->
      <a href="https://uhbvn.org.in/web/portal/view-bill" 
         target="_blank"
         class="bill-helper-btn"
         style="flex: 1; 
                min-width: 140px;
                padding: 0.625rem 1rem; 
                background: linear-gradient(135deg, #3b82f6, #2563eb); 
                color: white; 
                border: none; 
                border-radius: 8px; 
                font-weight: 700; 
                font-size: 0.875rem;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
                transition: all 0.3s;
                white-space: nowrap;">
        üìÑ Download Bill
      </a>
      
      <!-- Verify Guide -->
      <button onclick="openVerificationGuide()" 
              class="bill-helper-btn"
              style="flex: 1; 
                     min-width: 140px;
                     padding: 0.625rem 1rem; 
                     background: linear-gradient(135deg, #f59e0b, #d97706); 
                     color: white; 
                     border: none; 
                     border-radius: 8px; 
                     font-weight: 700; 
                     font-size: 0.875rem;
                     cursor: pointer;
                     box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
                     transition: all 0.3s;
                     white-space: nowrap;">
        üìö Verify Guide
      </button>
      
    </div>
    
    <!-- Small hint text -->
    <div style="margin-top: 0.75rem; text-align: center;">
      <small style="color: #64748b; font-size: 0.8rem;">
        Need your bill? Download from 
        <a href="https://uhbvn.org.in/web/portal/view-bill" target="_blank" style="color: #0ea5e9; text-decoration: underline;">UHBVN</a> or 
        <a href="https://dhbvn.org.in/web/portal/view-bill" target="_blank" style="color: #0ea5e9; text-decoration: underline;">DHBVN</a>
      </small>
    </div>
    
  </div>
</div>


<!-- SCANNER MODAL CONTAINER -->
<div id="scannerModal" style="display: none; 
                              position: fixed; 
                              top: 0; 
                              left: 0; 
                              width: 100%; 
                              height: 100%; 
                              background: rgba(0,0,0,0.5); 
                              z-index: 10000;
                              overflow: auto;">
 <button onclick="closeBillScanner()" 
          style="position: fixed; 
                 top: 20px; 
                 right: 20px; 
                 z-index: 10001;
                 width: 50px; 
                 height: 50px; 
                 border-radius: 50%; 
                 background: white; 
                 border: 2px solid #dc2626; 
                 color: #dc2626; 
                 font-size: 28px; 
                 font-weight: bold; 
                 cursor: pointer; 
                 box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                 transition: all 0.3s;
                 display: flex;
                 align-items: center;
                 justify-content: center;
                 line-height: 1;"
          onmouseover="this.style.background='#dc2626'; this.style.color='white'; this.style.transform='rotate(90deg)';"
          onmouseout="this.style.background='white'; this.style.color='#dc2626'; this.style.transform='rotate(0deg)';"
          title="Close Scanner">
    √ó
  </button>
  <div style="min-height: 100vh; 
              display: flex; 
              align-items: center; 
              justify-content: center; 
              padding: 1rem;">
    <iframe id="scannerFrame" 
            src="bill-scanner.html" 
            style="width: 100%; 
                   max-width: 800px; 
                   height: 90vh; 
                   border: none; 
                   border-radius: 16px; 
                   background: white;
                   box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    </iframe>
  </div>
</div>

  <!-- Decorative left accent -->
  <div class="absolute left-0 top-0 h-full w-1 bg-gradient-to-b from-emerald-500 to-blue-500"></div>

 <!-- INTENT SUMMARY -->
<div id="intentSummary" class="alert alert-info d-none">
  <span id="intentText"></span>
 </div>
<!-- AUTHENTICATION SECTION (for Dashboard) -->
<div class="card p-3 mb-3 d-none" id="authSection">
  <h6>üîê Login to Dashboard</h6>
  <label>Meter Number</label>
  <input id="authMeter" class="form-control mb-2" placeholder="Enter meter number">
  <label>Account Number</label>
  <input id="authAccount" class="form-control mb-2" placeholder="Enter account number">
  <button class="btn btn-primary w-100" onclick="authenticateUser()">Login</button>
  <button class="btn btn-secondary w-100 mt-2" onclick="resetIntent()">Back</button>
</div>

<!-- DASHBOARD SECTION -->
<div class="d-none" id="dashboardSection">
 <div class="section-header mb-4">
  <div class="section-title">
    <div class="section-icon section-icon-identity">
      üìä
    </div>
    <div class="section-title-text">
      My Dashboard
      <small class="section-subtitle">Manage and track your solar bills</small>
    </div>
  </div>
  
  <div id="userInfo" class="section-badge bg-light border text-primary small">
    </div>
</div>
  <!-- Mode Selection -->
<div class="mb-3 d-flex gap-2">
  <button id="singleModeBtn" class="btn btn-primary" onclick="switchMode('single')">
    üìä Single Selection
  </button>
  <button id="summaryModeBtn" class="btn btn-outline-primary" onclick="switchMode('summary')">
    üìà Multi-Bill Summary
  </button>
</div>
<!-- Mode Info Alert -->
<div id="modeInfo" class="alert alert-info py-2 mb-3" style="font-size: 0.9rem;">
  <strong>Single Selection Mode:</strong> Select one bill to View, Edit, or Delete.
</div>
<!-- Single Mode Buttons (Current) -->
<!-- Dynamic Action Buttons -->
<div class="mb-3">
  <!-- Single Mode Actions (Current) -->
  <div id="singleModeActions" class="gap-2" style="display: flex;">
    <button id="viewBtn" class="btn btn-primary" disabled onclick="viewBill()">
      üìÑ View
    </button>
    <button id="editBtn" class="btn btn-warning" disabled onclick="editBill()">
      ‚úèÔ∏è Edit
    </button>
    <button id="deleteBtn" class="btn btn-danger" disabled onclick="deleteBill()">
      üóëÔ∏è Delete
    </button>
  </div>
  
  <!-- Summary Mode Actions (NEW) -->
 <div id="summaryModeActions" class="gap-2" style="display: none;">
    <button id="showSummaryBtn" class="btn btn-success" onclick="showMultiBillSummary()">
      üìä Show Summary (<span id="selectedCount">0</span> bills)
    </button>
    <button class="btn btn-secondary" onclick="clearAllSelections()">
      ‚úï Clear All
    </button>
    <button class="btn btn-primary" onclick="selectAllBills()">
      ‚òë Select All
    </button>
  </div>
</div>


<!-- Summary Mode Buttons (NEW) -->
 <div id="billsList"></div>
  <button class="btn btn-secondary w-100 mt-3" onclick="logout()">Logout</button>
</div>

<!-- IDENTITY SECTION WITH CONTAINER -->
<div class="d-none" id="identitySection">
  <div class="section-container section-identity">
    
    <!-- Section Header -->
    <div class="section-header">
      <div class="section-title">
        <div class="section-icon section-icon-identity">
          üë§
        </div>
        <div>
          <h6 class="section-title-text">Consumer Identification</h6>
          <small class="section-subtitle">Enter your bill details for secure storage</small>
        </div>
      </div>
      <span class="section-badge badge-required">Required</span>
    </div>

    <!-- Bill Number - Indigo Card -->
    <div class="card-input-wrapper">
      <div class="card-input-container" style="background: linear-gradient(135deg, #e0e7ff, #eef2ff); border: 2px solid #818cf8;">
        <div class="card-top-bar"></div>
        <div class="card-content">
          <div class="card-title-row">
            <h6 class="card-input-title">
              <span class="card-icon">üìÑ</span>
              Bill Number
            </h6>
            <span class="card-hint">e.g. 123456</span>
          </div>
          <div class="card-input-field">
            <input id="billNumber"
                   type="text"
                   inputmode="numeric"
                   class="card-input"
                   placeholder="Enter bill number">
          </div>
        </div>
      </div>
    </div>

    <!-- Meter Number - Teal Card -->
    <div class="card-input-wrapper">
      <div class="card-input-container" style="background: linear-gradient(135deg, #ccfbf1, #f0fdfa); border: 2px solid #2dd4bf;">
        <div class="card-top-bar"></div>
        <div class="card-content">
          <div class="card-title-row">
            <h6 class="card-input-title">
              <span class="card-icon">üìü</span>
              Meter Number
            </h6>
            <span class="card-hint">e.g. 24600455</span>
          </div>
          <div class="card-input-field">
            <input id="meter"
                   type="text"
                   inputmode="numeric"
                   class="card-input"
                   placeholder="Enter meter number">
          </div>
        </div>
      </div>
    </div>

    <!-- Account Number - Pink Card -->
    <div class="card-input-wrapper">
      <div class="card-input-container" style="background: linear-gradient(135deg, #fce7f3, #fdf2f8); border: 2px solid #f472b6;">
        <div class="card-top-bar"></div>
        <div class="card-content">
          <div class="card-title-row">
            <h6 class="card-input-title">
              <span class="card-icon">üîë</span>
              Account Number
            </h6>
            <span class="card-hint">e.g. ACC12345</span>
          </div>
          <div class="card-input-field">
            <input id="accountNum"
                   type="text"
                   class="card-input"
                   placeholder="Enter account number">
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- BILL PERIOD SECTION WITH CONTAINER -->
<div class="d-none" id="billPeriodSection">
  <div class="section-container section-period">
    
    <!-- Section Header -->
    <div class="section-header">
      <div class="section-title">
        <div class="section-icon section-icon-period">
          üìÖ
        </div>
        <div>
          <h6 class="section-title-text">Bill Period</h6>
          <small class="section-subtitle">Select billing start and end dates</small>
        </div>
      </div>
      <span class="section-badge badge-required">Required</span>
    </div>

    <!-- From Date - Amber Card -->
    <div class="card-input-wrapper">
      <div class="card-input-container" style="background: linear-gradient(135deg, #fef3c7, #fffbeb); border: 2px solid #fbbf24;">
        <div class="card-top-bar"></div>
        <div class="card-content">
          <div class="card-title-row">
            <h6 class="card-input-title">
              <span class="card-icon">üìÜ</span>
              From Date
            </h6>
            <span class="card-hint">Start date</span>
          </div>
          <div class="card-input-field">
            <input id="billFrom"
                   type="date"
                   class="card-input"
                   style="cursor: pointer;">
          </div>
        </div>
      </div>
    </div>

    <!-- To Date - Lime Card -->
    <div class="card-input-wrapper">
      <div class="card-input-container" style="background: linear-gradient(135deg, #d9f99d, #ecfccb); border: 2px solid #a3e635;">
        <div class="card-top-bar"></div>
        <div class="card-content">
          <div class="card-title-row">
            <h6 class="card-input-title">
              <span class="card-icon">üìÜ</span>
              To Date
            </h6>
            <span class="card-hint">End date</span>
          </div>
          <div class="card-input-field">
            <input id="billTo"
                   type="date"
                   class="card-input"
                   style="cursor: pointer;">
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- CONSUMPTION SECTION WITH CONTAINER -->
<div class="d-none" id="consumptionSection">
  <div class="section-container section-consumption">
    
    <!-- Section Header -->
    <div class="section-header">
      <div class="section-title">
        <div class="section-icon section-icon-consumption">
          ‚ö°
        </div>
        <div>
          <h6 class="section-title-text">Before Solar vs After Solar Analysis</h6>
          <small class="section-subtitle">Enter units and billing amounts</small>
        </div>
      </div>
      <span class="section-badge badge-required">Required</span>
    </div>
<!-- Gross Units - Blue Card -->
<div class="card-input-wrapper">
  <div class="card-input-container card-color-blue">
    <div class="card-top-bar"></div>
    <div class="card-content">
      <div class="card-title-row">
        <h6 class="card-input-title">
          <span class="card-icon">‚ö°</span>
          Total Consumed Units (Gross Units)
        </h6>
        <span class="card-hint">e.g. 1354</span>
      </div>
      <div class="card-input-field">
        <input id="gross"
               type="text"
               inputmode="numeric"
               class="card-input"
               placeholder="Enter value"
               oninput="handleNumericInput(this)">
        <button class="card-action-btn" 
                type="button"
                onclick="appendPlus('gross')">
          +
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Import Units - Green Card -->
<div class="card-input-wrapper">
  <div class="card-input-container card-color-green">
    <div class="card-top-bar"></div>
    <div class="card-content">
      <div class="card-title-row">
        <h6 class="card-input-title">
          <span class="card-icon">üì•</span>
          Import Units (KWHI)
        </h6>
        <span class="card-hint">e.g. 1114</span>
      </div>
      <div class="card-input-field">
        <input id="importU"
               type="text"
               inputmode="numeric"
               class="card-input"
               placeholder="Enter value"
               oninput="handleNumericInput(this)"
               onblur="validateUnits()">
        <button class="card-action-btn" 
                type="button"
                onclick="appendPlus('importU')"
                style="background: linear-gradient(135deg, #10b981, #059669);">
          +
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Export Units - Purple Card -->
<div class="card-input-wrapper">
  <div class="card-input-container card-color-purple">
    <div class="card-top-bar"></div>
    <div class="card-content">
      <div class="card-title-row">
        <h6 class="card-input-title">
          <span class="card-icon">üì§</span>
          Export Units (KWHE)
        </h6>
        <span class="card-hint">e.g. 944</span>
      </div>
      <div class="card-input-field">
        <input id="exportU"
               type="text"
               inputmode="numeric"
               class="card-input"
               placeholder="Enter value"
               oninput="handleNumericInput(this)"
               onblur="validateUnits()">
        <button class="card-action-btn" 
                type="button"
                onclick="appendPlus('exportU')"
                style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
          +
        </button>
      </div>
    </div>
  </div>
</div>
<!-- ==========================================
     ENHANCED OPENING CARRY FORWARD FIELD
     With Smart Hints, Tooltips, and Warnings
     Replace lines 615-627 in your HTML
     ========================================== -->

<div id="carryForwardSection" class="mb-2 d-none">
  <label style="display: flex; align-items: center; gap: 0.5rem;">
    Opening Carry Forward Units
    <small class="text-muted">(from previous bill)</small>
    <!-- Info icon with tooltip -->
    <span style="cursor: help; color: #0d6efd;" 
          title="Enter the 'Closing Carry Forward' from your previous month's bill. This will reduce your current month's billing."
          onclick="showCarryForwardHelp()">
      ‚ÑπÔ∏è
    </span>
  </label>
  
  <input id="openingCarry"
         class="form-control"
         inputmode="numeric"
         oninput="handleNumericInput(this); checkCarryForwardWarnings()">
  
  <!-- Dynamic hint based on month -->
  <div id="carryForwardHint" style="margin-top: 0.5rem;">
    <!-- This will be populated by JavaScript -->
  </div>
  
  <!-- Static help text (always visible) -->
  <small class="text-muted d-block" style="margin-top: 0.25rem;">
    üí° <strong>Tip:</strong> Find this value in previous bill's "Closing Carry Forward"
  </small>
</div>

  
 <!-- Fixed Charges - Orange Card -->
<div class="card-input-wrapper">
  <div class="card-input-container card-color-orange">
    <div class="card-top-bar"></div>
    <div class="card-content">
      <div class="card-title-row">
        <h6 class="card-input-title">
          <span class="card-icon">‚Çπ</span>
          Fixed Charges
        </h6>
        <span class="card-hint">e.g. 1605</span>
      </div>
      <div class="card-input-field">
        <input id="fixed"
               type="text"
               inputmode="numeric"
               class="card-input"
               placeholder="Enter amount"
               oninput="handleNumericInput(this)">
        <button class="card-action-btn" 
                type="button"
                onclick="appendPlus('fixed')"
                style="background: linear-gradient(135deg, #f59e0b, #d97706);">
          +
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Total Bill Amount - Red Card -->
<div class="card-input-wrapper">
  <div class="card-input-container card-color-red">
    <div class="card-top-bar"></div>
    <div class="card-content">
      <div class="card-title-row">
        <h6 class="card-input-title">
          <span class="card-icon">üí∞</span>
          Total Current Cycle Charges
        </h6>
        <span class="card-hint">e.g. 2700</span>
      </div>
      <div class="card-input-field">
        <input id="totalBill"
               type="text"
               inputmode="numeric"
               class="card-input"
               placeholder="Enter amount"
               oninput="handleNumericInput(this)">
        <button class="card-action-btn" 
                type="button"
                onclick="appendPlus('totalBill')"
                style="background: linear-gradient(135deg, #ef4444, #dc2626);">
          +
        </button>
      </div>
    </div>
  </div>
</div>

 <!-- Arrears - Cyan Card -->
<div class="card-input-wrapper">
  <div class="card-input-container card-color-cyan">
    <div class="card-top-bar"></div>
    <div class="card-content">
      <div class="card-title-row">
        <h6 class="card-input-title">
          <span class="card-icon">üìä</span>
          Arrears
        </h6>
        <span class="card-hint">if any</span>
      </div>
      <div class="card-input-field">
        <input id="arrears"
               type="text"
               inputmode="numeric"
               class="card-input"
               placeholder="Enter amount"
               oninput="handleNumericInput(this)">
        <button class="card-action-btn" 
                type="button"
                onclick="appendPlus('arrears')"
                style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
          +
        </button>
      </div>
    </div>
  </div> <!-- Close section-container -->
</div> <!-- Close consumptionSection -->
<!-- ‚úÖ ADD THIS BUTTON AFTER FORM FIELDS -->
    
<button id="actionBtn"
        class="btn btn-primary w-100 d-none"
        onclick="calculate()">
  Calculate Solar Benefit
</button>
<!-- Cancel Edit Button -->
<button id="cancelEditBtn"
        class="btn btn-secondary w-100 mt-3"
        style="display: none;"
        onclick="cancelEdit()">
  ‚ùå Cancel Edit
</button>

<div id="result" class="mt-4"></div>
<div id="awardSummary" class="result-box d-none"
     style="border-left:6px solid #198754;background:#f0fdf4;">
  
  <h6 style="font-weight:800;color:#14532d;">
    üåû Solar Benefit Summary (This Bill)
  </h6>

  <p>üí∏ <b>Estimated Saving:</b> ‚Çπ <span id="awardSaving">‚Äî</span></p>
  <p>‚ö° <b>Solar Units Offset:</b> <span id="awardUnits">‚Äî</span> kWh</p>
  <p>üìâ <b>Bill Reduction:</b> <span id="awardPercent">‚Äî</span>%</p>
  <p>üßæ <b>Net Payable With Solar:</b> ‚Çπ <span id="awardPayable">‚Äî</span></p>

  <hr>

  <p class="fw-bold text-success">
    ‚úÖ Without solar, your bill would have been approx ‚Çπ
    <span id="awardWithoutSolar">‚Äî</span>
  </p>
</div>

</div>
</div>
<!-- Custom Modal -->
<div id="customModal" class="custom-modal">
  <div class="modal-content-custom">
    <div style="text-align: center; font-size: 3rem;" id="modalIcon">‚úÖ</div>
    <h4 style="text-align: center; margin: 1rem 0;" id="modalTitle">Success</h4>
    <div id="modalMessage" style="color: #64748b;"></div>
    <div id="modalButtons" style="display: flex; gap: 1rem; margin-top: 1.5rem;"></div>
  </div>
</div>
<!-- Quote Section - Place BEFORE Last Updated line -->
      
<!-- DIV 1: Shows selected mode (One-time or Save) -->
<div id="intentSummary" class="d-none" style="text-align: center; margin: 0.5rem 0;">
    <small id="intentText" style="color: #6c757d;">
      <!-- This gets filled by JavaScript with mode info -->
    </small>
</div>

<!-- COLLAPSIBLE POLICY INFORMATION -->
<div class="container">
   <div id="policyInfoSection" class="d-none" style="margin: 1rem 0;">
  <!-- Collapsed View (Default) -->
  <div id="policyInfoCollapsed" 
       style="display: flex; align-items: center; justify-content: space-between; 
              padding: 0.75rem 1rem; background: #e7f3ff; border-radius: 8px; 
              border-left: 4px solid #0d6efd; cursor: pointer;"
       onclick="togglePolicyInfo()">
    <div>
      <strong style="color: #084298;">
        ‚ÑπÔ∏è ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§®‡•Ä‡§§‡§ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä / Important Policy Information
      </strong>
      <small style="display: block; color: #6c757d; margin-top: 0.25rem;">
        90% ‡§∏‡•Ä‡§Æ‡§æ ‡§î‡§∞ March Reset ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§®‡•á‡§Ç
      </small>
    </div>
    <button class="btn btn-sm btn-outline-primary" 
            style="white-space: nowrap;"
            onclick="togglePolicyInfo(); event.stopPropagation();">
      üìö Show Info
    </button>
  </div>
  
  <!-- Expanded View (Hidden by default) -->
  <div id="policyInfoExpanded" 
       class="alert alert-info" 
       style="display: none; margin-top: 0.5rem; margin-bottom: 0;">
    
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
      <h6 style="margin: 0; color: #055160;">
        ‚ÑπÔ∏è ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§®‡•Ä‡§§‡§ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä / Important Policy Information
      </h6>
      <button class="btn btn-sm btn-outline-secondary" 
              onclick="togglePolicyInfo()"
              style="padding: 0.25rem 0.5rem; line-height: 1;">
        ‚úï Hide
      </button>
    </div>
    
    <!-- 90% Limit Info -->
    <div style="margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #0dcaf0;">
      <strong style="color: #055160;">1Ô∏è‚É£ 90% ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§∏‡•Ä‡§Æ‡§æ:</strong>
      <p style="font-size: 0.9rem; margin: 0.5rem 0 0 0;">
        ‡§ï‡•Å‡§õ ‡§∞‡§æ‡§ú‡•ç‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï solar generation ‡§ï‡•Ä 90% ‡§∏‡•Ä‡§Æ‡§æ ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§ 
        ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ units ‡§ï‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§Æ ‡§¶‡§∞ ‡§™‡§∞ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§<br>
        <small>Some states may have 90% annual limit. Excess may be paid at lower rate.</small>
        <a href="#" onclick="show90LimitHelp(); return false;" style="margin-left: 0.5rem;">
          üìö Learn more
        </a>
      </p>
    </div>
    
    <!-- March Reset Info -->
    <div>
      <strong style="color: #055160;">2Ô∏è‚É£ ‡§Æ‡§æ‡§∞‡•ç‡§ö ‡§ï‡•á ‡§¨‡§æ‡§¶ Carry Forward Reset:</strong>
      <p style="font-size: 0.9rem; margin: 0.5rem 0 0 0;">
        ‡§π‡§∞‡§ø‡§Ø‡§æ‡§£‡§æ ‡§Æ‡•á‡§Ç 31 ‡§Æ‡§æ‡§∞‡•ç‡§ö (‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§µ‡§∞‡•ç‡§∑ ‡§ï‡•á ‡§Ö‡§Ç‡§§) ‡§Æ‡•á‡§Ç carry forward ‡§∂‡•Ç‡§®‡•ç‡§Ø ‡§π‡•ã ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à‡•§<br>
        <small>In Haryana, carry forward resets to zero on March 31 (FY end).</small>
        <a href="#" onclick="showMarchResetHelp(); return false;" style="margin-left: 0.5rem;">
          üìö Learn more
        </a>
      </p>
    </div>
    
    <!-- Important Note -->
    <div style="margin-top: 0.75rem; padding: 0.5rem; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107;">
      <strong style="color: #664d03;">‚ö†Ô∏è ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£:</strong><br>
      <small style="color: #664d03;">
        April ‡§Æ‡•á‡§Ç Opening Carry Forward = 0 ‡§≠‡§∞‡•á‡§Ç (‡§®‡§è FY ‡§ï‡•á ‡§≤‡§ø‡§è)‡•§<br>
        In April, enter Opening Carry Forward = 0 (for new FY).
      </small>
    </div>
  </div>
</div>
</div>
   <footer class="mt-1 py-3 text-center"
        style="background:#f8f9fa;border-top:1px solid #cbd5e1;">
<!-- Quote Section - Full Width Simple -->
<div class="container">
  <div id="quotesSection" class="p-4" style=" background: linear-gradient(135deg, #FFFDF5 0%, #FFFFFF 100%);  
   border-radius: 12px; border-left: 6px solid #16a34a; box-shadow: 0 4px 16px rgba(22, 163, 74, 0.15);">
  
  
       
     <!-- Quote -->
    <p class="text-center mb-3" style="font-size: 1.15rem; color: #1e3a8a; font-weight: 500; font-style: italic; line-height: 1.8;">
      ‡§∏‡•Ç‡§∞‡•ç‡§Ø ‡§ï‡•Ä ‡§∞‡•ã‡§∂‡§®‡•Ä ‡§ï‡•ã ‡§¨‡§ö‡§§ ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡§®‡§æ ‚Äî ‡§ú‡§¨ ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¶‡•á‡§ñ ‡§∏‡§ï‡•á‡§Ç ‡§ï‡§ø ‡§∏‡•ã‡§≤‡§∞ ‡§ï‡•ç‡§Ø‡§æ ‡§µ‡§æ‡§™‡§∏ ‡§¶‡•á‡§§‡§æ ‡§π‡•à‡•§
    </p>
    
    <!-- Attribution -->
    <p class="text-center mb-3" style="color: #0c4a6e; font-size: 0.9rem; font-weight: 600;">
      ‚Äì ‡§∏‡•ã‡§≤‡§∞‡§∏‡§Ç‡§ö‡§Ø ‡§¶‡§∞‡•ç‡§∂‡§®
    </p>
    
    <!-- Line -->
    <hr style="width: 100px; height: 2px; background: #0284c7; border: none; margin: 1rem auto;">
    
    <!-- Description -->
    <p class="text-center mb-0" style="font-size: 0.85rem; color: #0369a1; line-height: 1.6; max-width: 800px; margin: 0 auto;">
      ‡§ú‡§¨ ‡§ä‡§∞‡•ç‡§ú‡§æ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§∏‡§∞‡§≤ ‡§§‡§∞‡•Ä‡§ï‡•á ‡§∏‡•á ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡•Å‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§® ‡§∏‡•á ‡§ú‡§æ‡§ó‡§∞‡•Ç‡§ï‡§§‡§æ ‡§ï‡•Ä ‡§ì‡§∞,<br class="d-none d-md-block">
      ‡§î‡§∞ ‡§ú‡§æ‡§ó‡§∞‡•Ç‡§ï‡§§‡§æ ‡§∏‡•á ‡§∏‡•ã‡§≤‡§∞ ‡§Ö‡§™‡§®‡§æ‡§®‡•á ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø ‡§ï‡•Ä ‡§ì‡§∞ ‡§¨‡§¢‡§º‡§§‡•á ‡§π‡•à‡§Ç‡•§
    </p>
  </div>
</div>
   
<!-- DOCUMENT DOWNLOAD BANNER - FULLY RESPONSIVE -->
<div class="container" style="margin: 1.5rem auto;" id="userGuideBanner">
  <div class="doc-banner-wrapper">

       <!-- Text Content -->
    <div class="doc-banner-text">
      <h4 style="color: #1e40af; font-weight: 700; margin: 0 0 0.5rem 0; font-size: 1.1rem;">
        üìö Complete User Guide Available
      </h4>
      <p style="color: #64748b; margin: 0; font-size: 1rem;">
        Learn about features, benefits, and how to use SolarSanchay
      </p>
    </div>
    
    <!-- Button Container -->
    <div class="doc-banner-buttons">
      <a href="docs/SolarSanchay-Guide.pdf" 
         target="_blank"
         class="doc-btn doc-btn-pdf">
        üìÑ View PDF
      </a>
     </div>
    
  </div>
</div>


<div class="footer">
  Developed by <b>National Informatics Centre (NIC), Kurukshetra</b><br>
  for District Administration, Kurukshetra<br>
  <span class="small">A scalable Digital India initiative for solar transparency</span>
</div>
  Last Updated: <span id="lastModified"></span>
</footer>
  <!-- Bill Verification Guide Modal -->
<div id="verificationModal" class="verification-modal">
  <div class="verification-content">
    <div class="verification-header">
      <h2>
        <span>üìã</span>
        <span>Bill Field Verification Guide</span>
      </h2>
      <button class="close-verification" onclick="closeVerificationGuide()">&times;</button>
    </div>
    
    <div class="verification-body">
      <div class="guide-warning">
        <strong style="color: #856404; font-size: 16px;">‚ö†Ô∏è Important - Verify Before Saving</strong>
        <p style="color: #856404; margin: 8px 0 0 0;">
          Please verify the highlighted fields carefully with your physical bill.
        </p>
      </div>
      
      <img src="https://raw.githubusercontent.com/vksinglakkr/SolarSaving/main/assests/SolarSanchayDemo.jpg" 
           alt="Bill Verification Guide" 
           class="guide-image">
      
      <div class="guide-checklist">
        <h3>‚úì Quick Verification Checklist</h3>
        <ul>
          <li><strong>Account & Bill Number:</strong> Match exactly</li>
          <li><strong>Import/Export Units:</strong> MOST IMPORTANT!</li>
          <li><strong>Bill Amount:</strong> Verify total</li>
          <li><strong>Dates:</strong> Check period</li>
        </ul>
      </div>
      
      <button class="got-it-btn" onclick="closeVerificationGuide()">
        Got it! ‚úì
      </button>
    </div>
  </div>
</div>
<script>
// ==========================================
// GLOBAL VARIABLES
// ==========================================
let entryMode = "one";
let currentUser = null;
// Initialize and synchronize userBills
let userBills = [];
let currentAnalysisData = null;
window.isEditMode = false;
window.ignoreNextBillSelection = false;

// Create two-way binding with window.userBills
Object.defineProperty(window, 'userBills', {
  get: function() { return userBills; },
  set: function(value) { 
    userBills = value;
    console.log('userBills updated:', value ? value.length : 0, 'bills');
  },
  configurable: true
});
let selectedBillIndex = null;

// Elements
const gross = document.getElementById("gross");
const importU = document.getElementById("importU");
const exportU = document.getElementById("exportU");
const fixed = document.getElementById("fixed");
const totalBill = document.getElementById("totalBill");
const arrears = document.getElementById("arrears");
const result = document.getElementById("result");

// ==========================================
// INTENT SELECTION
// ==========================================
function selectIntent(type){
  console.log('selectIntent called with type:', type);
  
  entryMode = type;

  // Get all elements
  const intentSection = document.getElementById("intentSection");
  const helper = document.getElementById("helperCards");
  const intentSummary = document.getElementById("intentSummary");
  const intentText = document.getElementById("intentText");
  const consumption = document.getElementById("consumptionSection");
  const identity = document.getElementById("identitySection");
  const billPeriod = document.getElementById("billPeriodSection");
  const authSection = document.getElementById("authSection");
  const dashboardSection = document.getElementById("dashboardSection");
  const carrySec = document.getElementById("carryForwardSection");
  const actionBtn = document.getElementById("actionBtn");
  const downloadMessage = document.getElementById("downloadMessage");
  const policyInfo = document.getElementById("policyInfoSection");
  const scanBtn = document.getElementById("openScannerBtn");
  const quotes = document.getElementById("quotesSection");
  const userGuide = document.getElementById("userGuideBanner"); 
const billHelpers = document.getElementById("billHelpers");   

  // ==========================================
  // STEP 1: CLEAR ALL INLINE STYLES
  // ==========================================
  console.log('Clearing inline styles...');
  if (consumption) consumption.style.display = '';
  if (identity) identity.style.display = '';
  if (billPeriod) billPeriod.style.display = '';
  if (authSection) authSection.style.display = '';
  if (dashboardSection) dashboardSection.style.display = '';
  if (carrySec) carrySec.style.display = '';
  if (actionBtn) actionBtn.style.display = '';

  // ==========================================
  // STEP 2: HIDE INTENT SECTION
  // ==========================================
  console.log('Hiding intent section...');
  if (intentSection) {
    intentSection.classList.add("d-none");
    intentSection.style.display = 'none';
  }
  if (helper) helper.classList.add("d-none");

  // ==========================================
  // STEP 3: SHOW APPROPRIATE SECTIONS
  // ==========================================
  
  if (type === "dashboard") {
    console.log('Dashboard mode selected');
    
    // Hide form sections
    if (consumption) consumption.classList.add("d-none");
    if (identity) identity.classList.add("d-none");
    if (billPeriod) billPeriod.classList.add("d-none");
    if (carrySec) carrySec.classList.add("d-none");
    if (actionBtn) actionBtn.classList.add("d-none");
    if (intentSummary) intentSummary.classList.add("d-none");
    if (dashboardSection) dashboardSection.classList.add("d-none");
       if (downloadMessage) downloadMessage.classList.add("d-none");
     if (policyInfo) policyInfo.classList.add("d-none");     // 1. Hide policy info
    if (scanBtn) scanBtn.classList.add("d-none");           // 2. Hide scan button
    if (quotes) quotes.classList.add("d-none");       
    if (userGuide) userGuide.classList.add("d-none");
    if (billHelpers) billHelpers.classList.add("d-none");     
    // Show auth section
    if (authSection) authSection.classList.remove("d-none");
    
    // Show home button
    showHomeButton();
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
  } else {
    // Form mode (one or save)
    console.log('Form mode selected:', type);
    
    // Hide dashboard/auth
    if (authSection) authSection.classList.add("d-none");
    if (dashboardSection) dashboardSection.classList.add("d-none");
    
    // Show intent summary
    if (intentSummary && intentText) {
      intentSummary.classList.remove("d-none");
      intentText.innerHTML =
        type === "one"
          ? "‚úî <b>One-time Analysis:</b> No data will be saved"
          : "‚úî <b>Save for Future:</b> Bill details will be stored";
    }
   // ‚Üì‚Üì‚Üì ADD THIS ‚Üì‚Üì‚Üì
    // Show download message
   if (downloadMessage) {
  downloadMessage.classList.remove("d-none");
  downloadMessage.style.display = '';  // ‚Üê THIS IS THE KEY!
}
if (policyInfo) {
  policyInfo.classList.remove("d-none");
  policyInfo.style.display = '';
}

if (scanBtn) {
  scanBtn.classList.remove("d-none");
  scanBtn.style.display = '';
}

// ‚Üì‚Üì‚Üì HIDE: Quotes (not needed in form mode) ‚Üì‚Üì‚Üì
if (quotes) {
  quotes.classList.add("d-none");
  quotes.style.display = 'none';
}
if (billHelpers) {                           // ADD THIS
    billHelpers.classList.remove("d-none");    // ADD THIS
    billHelpers.style.display = '';            // ADD THIS
  }        
if (userGuide) {                           // ADD THIS
    userGuide.classList.add("d-none");       // ADD THIS
    userGuide.style.display = 'none';        // ADD THIS
}         

    // Show consumption and bill period (always needed)
    if (consumption) {
      consumption.classList.remove("d-none");
      console.log('Consumption section shown');
    }
    if (billPeriod) {
      billPeriod.classList.remove("d-none");
      console.log('Bill period section shown');
    }

    // Mode-specific: Identity and Carry Forward
   if (type === "save") {
      if (identity) {
        identity.classList.remove("d-none");
        console.log('Identity section shown (save mode)');
      }
      if (carrySec) {
        carrySec.classList.remove("d-none");
        console.log('Carry forward section shown');
      }
      
      // Only change button text if NOT editing
      if (actionBtn && !window.isEditingBill) {
        actionBtn.innerText = "üíæ Save & Submit";
      }
    } else {
      // type === "one"
      if (identity) identity.classList.add("d-none");
      if (carrySec) carrySec.classList.add("d-none");
      const openingCarry = document.getElementById("openingCarry");
      if (openingCarry) openingCarry.value = "";
      
      // Only change button text if NOT editing
      if (actionBtn && !window.isEditingBill) {
        actionBtn.innerText = "üîç Calculate Saving";
      }
    }
    // Show action button
    if (actionBtn) {
      actionBtn.classList.remove("d-none");
      console.log('Action button shown');
    }
    
    // Show home button
    showHomeButton();
    
    // Scroll to top smoothly
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
//  showScannerButton();
  console.log('selectIntent completed');
}

// ==========================================
// AUTHENTICATION & DASHBOARD
// ==========================================
async function authenticateUser() {
  const meter = document.getElementById('authMeter').value.trim();
  const account = document.getElementById('authAccount').value.trim();
  
  if (!meter || !account) {
    showErrorModal('‚ö†Ô∏è Please enter both Meter and Account Number');
    return;
  }
  
  const authSection = document.getElementById('authSection');
  authSection.innerHTML += '<div id="authLoading" style="text-align: center; margin-top: 1rem;"><div class="spinner"></div></div>';
  
  try {
    const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-authenticate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ meterNumber: meter, accountNumber: account })
    });
    
    let data = await response.json();
    
    // Handle array-wrapped response
    if (Array.isArray(data)) {
      data = data[0];
    }
    
    document.getElementById('authLoading')?.remove();
    
    if (data.status === 'success' && data.authenticated) {
      currentUser = { meter, account };
      
      // ‚úÖ CRITICAL FIX: Properly store bills in window.userBills
      const bills = Array.isArray(data.bills) ? data.bills : [];
      userBills = bills;
      window.userBills = bills;
      
      console.log('‚úÖ Bills stored:', bills.length, 'bills');
      console.log('First bill:', bills[0]?.['Bill Number']);
      
      showSuccessModal(`‚úÖ Login Successful!<br><br>Found ${data.billCount} bill(s).`);
      
      setTimeout(() => {
        closeModal();
        showDashboard();
      }, 1500);
      
    } else {
      if (data.billCount === 0 || data.message.includes('No records')) {
        showModal('‚ÑπÔ∏è', 'No Bills Found', `
          <p>You haven't saved any bills yet.</p>
          <p><strong>First time user?</strong></p>
          <p>Save a bill using "Save for Future Reference" option.</p>
        `, [
          { text: 'Save First Bill', type: 'primary', action: () => { closeModal(); selectIntent('save'); } },
          { text: 'Cancel', type: 'secondary', action: closeModal }
        ]);
      } else {
        showErrorModal('‚ùå Authentication Failed<br><br>Invalid credentials.');
      }
    }
  } catch (error) {
    document.getElementById('authLoading')?.remove();
    console.error(error);
    showErrorModal('‚ùå Connection error. Please try again.');
  }
}

async function authenticateUserSilent() {
  const meter = currentUser.meter;
  const account = currentUser.account;
  
  try {
    const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-authenticate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ meterNumber: meter, accountNumber: account })
    });
    
    let data = await response.json();
    if (Array.isArray(data)) data = data[0];
    
if (data.status === 'success' && data.authenticated) {
      currentUser = { meter, account };
      
      // ‚úÖ CRITICAL FIX: Properly store bills
      const bills = Array.isArray(data.bills) ? data.bills : [];
      userBills = bills;
      window.userBills = bills;
      
      console.log('‚úÖ Silent auth: Bills refreshed:', bills.length);
      
      displayBillsList();
    } else {
      showErrorModal('Failed to refresh dashboard');
    }
  } catch (error) {
    console.error(error);
    showErrorModal('‚ùå Failed to refresh');
  }
}

function showDashboard() {
  document.getElementById('authSection').classList.add('d-none');
  document.getElementById('dashboardSection').classList.remove('d-none');
  document.getElementById('userInfo').textContent = `Meter: ${currentUser.meter} | Account: ${currentUser.account}`;
  
  showHomeButton(); // ‚úÖ ADD THIS
  
  displayBillsList();
}

function displayBillsList() {
   // --- ADD THESE THREE LINES AT THE START ---
    selectedBillIndex = null; 
   const billHelpers = document.getElementById("billHelpers");   
    document.getElementById('editBtn').disabled = true;
    // If you have view/delete buttons, disable them too:
    if(document.getElementById('viewBtn')) document.getElementById('viewBtn').disabled = true;
    if(document.getElementById('deleteBtn')) document.getElementById('deleteBtn').disabled = true;
      if (billHelpers) billHelpers.classList.add("d-none");     
    // ------------------------------------------
  const billsList = document.getElementById('billsList');
  
  if (!userBills || userBills.length === 0) {
    billsList.innerHTML = `
      <div style="text-align: center; padding: 3rem; color: #64748b;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
        <p style="font-size: 1.2rem; font-weight: 600;">No Bills Found</p>
      </div>
    `;
    return;
  }
  
  const totalSavings = userBills.reduce((sum, bill) => sum + parseFloat(bill['Solar Saving Amount'] || 0), 0);
  const avgSaving = totalSavings / userBills.length;
  
  billsList.innerHTML = `
    <div class="row g-2 mb-3">
      <div class="col-md-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Total Bills</div>
          <div style="font-size: 2rem; font-weight: 700;">${userBills.length}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Total Savings</div>
          <div style="font-size: 2rem; font-weight: 700;">‚Çπ${totalSavings.toFixed(0)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Avg Saving</div>
          <div style="font-size: 2rem; font-weight: 700;">‚Çπ${avgSaving.toFixed(0)}</div>
        </div>
      </div>
    </div>

    <div id="billCards">
      ${userBills.map((bill, index) => createBillCard(bill, index)).join('')}
    </div>
  `;
}

function createBillCard(bill, index) {
 // Show bill period instead of entry date
let billPeriod = 'N/A';
const fromDate = bill['Bill From Date'] || bill.billPeriod?.from;
const toDate = bill['Bill To Date'] || bill.billPeriod?.to;

if (fromDate && toDate) {
  try {
    const from = new Date(fromDate);
    const to = new Date(toDate);
    
    if (!isNaN(from.getTime()) && !isNaN(to.getTime())) {
      // Format: "1 Apr - 30 Apr 2025" (concise and clear)
      const fromDay = from.getDate();
      const toDay = to.getDate();
      const month = from.toLocaleDateString('en-IN', { month: 'short' });
      const year = from.getFullYear();
      
      // Same month
      if (from.getMonth() === to.getMonth()) {
        billPeriod = `${fromDay}-${toDay} ${month} ${year}`;
      } 
      // Different months
      else {
        const toMonth = to.toLocaleDateString('en-IN', { month: 'short' });
        billPeriod = `${fromDay} ${month} - ${toDay} ${toMonth} ${year}`;
      }
    }
  } catch (e) {
    billPeriod = 'N/A';
  }
}
  const saving = parseFloat(bill['Solar Saving Amount'] || 0);
  const savingPercent = parseFloat(bill['Saving Percentage'] || 0);
  const billAmount = parseFloat(bill['Total Bill Amount'] || 0);
  
return `
  <div class="bill-card" onclick="handleBillCardClick(event, ${index})">

    <div class="d-flex align-items-center gap-3">
      
      <!-- Single Selection Radio (default visible) -->
      <input type="radio" 
       name="billSelection" 
       id="single_${index}"
       class="single-selector"
       value="${index}" 
       style="width: 20px; height: 20px; cursor: pointer;"
       onclick="selectSingleBill(${index})">
      
      <!-- Multi Selection Checkbox (hidden by default) -->
      <input type="checkbox" 
             name="billSummary" 
             id="summary_${index}"
             class="summary-selector"
             value="${index}"
             style="width: 20px; height: 20px; cursor: pointer; display: none;"
             onchange="updateSummarySelection()">
      
      <div class="flex-grow-1">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <div style="font-weight: 700; font-size: 1.1rem; color: #1e3a8a;">
              Bill #${bill['Bill Number'] || 'N/A'}
            </div>
            <div style="font-size: 0.85rem; color: #64748b;">
              üìÖ ${billPeriod}
            </div>
          </div>
          <div class="text-end">
            <div style="font-size: 0.85rem; color: #64748b;">Bill Amount</div>
            <div style="font-weight: 600; color: #1e3a8a;">‚Çπ${billAmount.toFixed(0)}</div>
          </div>
        </div>
        
        <div class="row g-2 pt-2" style="border-top: 1px solid #e2e8f0;">
          <div class="col-6">
            <div style="font-size: 0.75rem; color: #64748b;">Solar Saving</div>
            <div style="font-weight: 700; font-size: 1.3rem; color: #10b981;">‚Çπ${saving.toFixed(0)}</div>
          </div>
          <div class="col-6">
            <div style="font-size: 0.75rem; color: #64748b;">Saving %</div>
            <div style="font-weight: 700; font-size: 1.3rem; color: #3b82f6;">${savingPercent.toFixed(1)}%</div>
          </div>
        </div>
      </div>
    </div>
  </div>
`;}

function selectBill(index) {
  selectedBillIndex = index;
  
  document.getElementById('viewBtn').disabled = false;
  document.getElementById('editBtn').disabled = false;
  document.getElementById('deleteBtn').disabled = false;
  
  document.querySelectorAll('input[name="billSelection"]').forEach((radio, i) => {
    radio.checked = (i === index);
  });
  
  document.querySelectorAll('.bill-card').forEach((card, i) => {
    if (i === index) {
      card.classList.add('selected');
    } else {
      card.classList.remove('selected');
    }
  });
}

// ==========================================
// BUTTON ACTION FUNCTIONS
// ==========================================

// View button - shows bill details
function viewBill() {
  if (selectedBillIndex === null) {
    alert('Please select a bill first.');
    return;
  }
  viewSelectedBill(); // Call existing function
}

// Edit button - loads bill for editing
function editBill() {
  if (selectedBillIndex === null || selectedBillIndex === undefined) {
    alert('Please select a bill first.');
    return;
  }
  
  window.isEditMode = true;
  
  const bills = window.userBills || [];
  
  console.log('=== EDIT BILL DEBUG ===');
  console.log('Selected index:', selectedBillIndex);
  console.log('Total bills available:', bills.length);
  console.log('Bills array:', bills);
  
  if (bills.length === 0) {
    alert('‚ùå No bills loaded! Please refresh the page.');
    return;
  }
  
  const bill = bills[selectedBillIndex];
  
  if (!bill) {
    alert(`‚ùå Bill not found at index ${selectedBillIndex}. Total bills: ${bills.length}`);
    console.error('Bill not found. Index:', selectedBillIndex, 'Bills:', bills);
    return;
  }
  
  console.log('Editing bill:', bill['Bill Number']);
  
  // Store editing state FIRST (before selectIntent)
  window.isEditingBill = true;
  window.editingBillIndex = selectedBillIndex;
  
  // Switch to form view
  selectIntent('save');
  
  // Wait for form to be visible, then load data and update buttons
  setTimeout(function() {
    loadBillForEditing(bill);
    
    const actionBtn = document.getElementById('actionBtn');
    if (actionBtn) {
      actionBtn.textContent = 'üíæ Update Bill';
      actionBtn.classList.remove('d-none');
      actionBtn.disabled = false;
      actionBtn.style.opacity = '1';
      actionBtn.style.cursor = 'pointer';
    }
    
    // Show cancel button
    const cancelBtn = document.getElementById('cancelEditBtn');
    if (cancelBtn) {
      cancelBtn.style.display = 'block';
    }
    
    console.log('Bill data loaded, buttons updated');
  }, 500);
  
  // Scroll to top
  setTimeout(function() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, 600);
}
function cancelEdit() {
  console.log("‚ùå Edit cancelled. Returning to dashboard.");
  const billHelpers = document.getElementById("billHelpers");  
  if (billHelpers) billHelpers.classList.add("d-none");   
  const intentSummary = document.getElementById("intentSummary");
     intentSummary.classList.add("d-none");
 
   // clear edit state
  isEditMode = false;
  editingIndex = null;

  // clear all form fields
  clearBillForm();

  // clear radio / checkbox selection  ‚úÖ FIX
  clearBillSelection();

  // hide award summary
  document.getElementById("awardSummary")?.classList.add("d-none");

  // exit entry mode
  exitBillEntryMode();

  // reset dashboard buttons
  resetDashboardActions();

  // show dashboard
  document.getElementById("dashboardSection").classList.remove("d-none");
}

// Delete button - removes selected bill
function deleteBill() {
  if (selectedBillIndex === null || selectedBillIndex === undefined) {
    alert('Please select a bill first.');
    return;
  }
  
  const bills = window.userBills || [];
  const bill = bills[selectedBillIndex];
  
  if (!bill) {
    alert('Bill not found.');
    return;
  }
  
  const billNum = bill['Bill Number'] || bill.billNumber || 'Unknown';
  
  if (confirm(`Are you sure you want to delete Bill #${billNum}?`)) {
    // Remove from array
    bills.splice(selectedBillIndex, 1);
    
    // Save to storage
    saveBillsToStorage(bills);
    
    // Reset selection
    selectedBillIndex = null;
    
    // Disable buttons
    document.getElementById('viewBtn').disabled = true;
    document.getElementById('editBtn').disabled = true;
    document.getElementById('deleteBtn').disabled = true;
    
    // Refresh dashboard
    renderBillCards(bills);
    
    alert('Bill deleted successfully!');
  }
}
function handleBillCardClick(event, index) {
  console.log('=== BILL CARD CLICKED ===');
  console.log('Index:', index);
  console.log('Current mode:', currentSelectionMode);
  console.log('Ignore flag:', window.ignoreNextBillSelection);

  // üî• Ignore auto-selection after dashboard restore
  if (window.ignoreNextBillSelection === true) {
    console.log("Ignored auto bill selection:", index);
    window.ignoreNextBillSelection = false; // reset after first ignore
    return;
  }

  if (currentSelectionMode === 'single') {
    console.log("User clicked bill card - selecting:", index);
    selectSingleBill(index);
  } else {
    console.log('Not in single mode - mode is:', currentSelectionMode);
  }
}


// Select single bill (radio button)
// Select single bill (radio button)
function selectSingleBill(index) {
  console.log('=== SELECT SINGLE BILL ===');
  console.log('Index:', index);
  
  selectedBillIndex = index;
  
  // Enable action buttons
  const viewBtn = document.getElementById('viewBtn');
  const editBtn = document.getElementById('editBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  
  if (viewBtn) {
    viewBtn.disabled = false;
    console.log('‚úÖ View button enabled');
  }
  if (editBtn) {
    editBtn.disabled = false;
    console.log('‚úÖ Edit button enabled');
  }
  if (deleteBtn) {
    deleteBtn.disabled = false;
    console.log('‚úÖ Delete button enabled');
  }
  
  // Update radio button selection
  document.querySelectorAll('.single-selector').forEach((radio, i) => {
    radio.checked = (i === index);
  });
  
  // Update visual selection
  document.querySelectorAll('.bill-card').forEach((card, i) => {
    if (i === index) {
      card.classList.add('selected');
    } else {
      card.classList.remove('selected');
    }
  });
  
  console.log('‚úÖ Bill selected:', index);
}

// Load bill data into form for editing
function loadBillForEditing(bill) {
  console.log('=== LOADING BILL FOR EDITING ===');
  console.log('Bill:', bill['Bill Number']);
  
  // Identity fields - THESE WORK
  const billNumber = document.getElementById('billNumber');
  const meter = document.getElementById('meter');
  const accountNum = document.getElementById('accountNum');
  
  if (billNumber) billNumber.value = bill['Bill Number'] || '';
  if (meter) meter.value = bill['Meter Number'] || '';
  if (accountNum) accountNum.value = bill['Account Number'] || '';
  
  // Date fields - THESE WORK
  const billFrom = document.getElementById('billFrom');
  const billTo = document.getElementById('billTo');
  
  if (billFrom) billFrom.value = bill['Bill From Date'] || '';
  if (billTo) billTo.value = bill['Bill To Date'] || '';
  
  // Units fields - CORRECTED IDs
  const gross = document.getElementById('gross');
  const importU = document.getElementById('importU');
  const exportU = document.getElementById('exportU');
  
  if (gross) {
    gross.value = bill['Gross Units'] || '';
    console.log('Set gross to:', gross.value);
  }
  if (importU) {
    importU.value = bill['Import Units'] || '';
    console.log('Set importU to:', importU.value);
  }
  if (exportU) {
    exportU.value = bill['Export Units'] || '';
    console.log('Set exportU to:', exportU.value);
  }
  
  // Carry forward
  const carryForwardUnits = document.getElementById('carryForwardUnits');
  const carryForwardSection = document.getElementById('carryForwardSection');
  const openingCarry = bill['Opening Carry Forward'] || 0;
  
  if (carryForwardUnits) carryForwardUnits.value = openingCarry;
  if (carryForwardSection && openingCarry > 0) {
    carryForwardSection.classList.remove('d-none');
  }
  
  // Amount fields - CORRECTED IDs
  const fixed = document.getElementById('fixed');
  const totalBill = document.getElementById('totalBill');
  const arrears = document.getElementById('arrears');
  
  if (fixed) {
    fixed.value = bill['Fixed Charges'] || '';
    console.log('Set fixed to:', fixed.value);
  }
  if (totalBill) {
    totalBill.value = bill['Total Bill Amount'] || '';
    console.log('Set totalBill to:', totalBill.value);
  }
  if (arrears) {
    arrears.value = bill['Arrears'] || '';
  }
  
  console.log('=== BILL LOADING COMPLETE ===');
}
// ==========================================
// UPDATED viewSelectedBill() Function
// Replace in your chatgpt_updated.html
// Shows bill in calculation result format
// ==========================================

function viewSelectedBill() {
  if (selectedBillIndex === null) {
    showErrorModal('Please select a bill first');
    return;
  }
  
  const bill = userBills[selectedBillIndex];
  
  // Extract data from bill
  const billNum = bill['Bill Number'] || 'N/A';
  const meterNum = bill['Meter Number'] || 'N/A';
  const entryDate = bill['Entry DateTime'] ? new Date(bill['Entry DateTime']).toLocaleString('en-IN') : 'N/A';
  
  const billFromDate = bill['Bill From Date'] ? new Date(bill['Bill From Date']).toLocaleDateString('en-IN') : '‚Äî';
  const billToDate = bill['Bill To Date'] ? new Date(bill['Bill To Date']).toLocaleDateString('en-IN') : '‚Äî';
  const days = bill['Billing Days'] || '‚Äî';
  
  const g = parseFloat(bill['Gross Units'] || 0);
  const i = parseFloat(bill['Import Units'] || 0);
  const e = parseFloat(bill['Export Units'] || 0);
  const direct = g - i;
  
  const f = parseFloat(bill['Fixed Charges'] || 0);
  const t = parseFloat(bill['Total Bill Amount'] || 0);
  const unitRate = parseFloat(bill['Unit Rate'] || 0);
  
  const without = parseFloat(bill['Bill Without Solar'] || 0);
  const saving = parseFloat(bill['Solar Saving Amount'] || 0);
  const savingPercent = parseFloat(bill['Saving Percentage'] || 0);
  
  const savingPerDay = days !== '‚Äî' && days > 0 ? (saving / days) : null;
  const annualSaving = savingPerDay ? savingPerDay * 365 : null;
  
  const withoutPerDay = days !== '‚Äî' && days > 0 ? (without / days) : null;
  const withPerDay = days !== '‚Äî' && days > 0 ? (t / days) : null;
  
  const modalContent = `
    <div style="text-align: left;">
      <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #0b5ed7;">
        <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem;">
          <strong>Bill Number:</strong> ${billNum} | 
          <strong>Meter:</strong> ${meterNum}
        </div>
        <div style="font-size: 0.75rem; color: #64748b;">
          Entry Date: ${entryDate}
        </div>
      </div>
      
      <!-- INPUT SUMMARY -->
      <div class="result-box">
        <h6>üì• Input Summary</h6>
        <b>Bill Period:</b> ${billFromDate} &nbsp; to &nbsp; ${billToDate} | 
        <b>Total Days:</b> ${days}<br>

        <b>Gross Units:</b> ${g} <br>
        <b>Import Units (KWHI):</b> ${i} &nbsp; | &nbsp;
        <b>Export Units (KWHE):</b> ${e} <br>

        <b>Direct Solar Used:</b> ${direct} units  
        <i class="text-muted">
          (Gross ‚àí Import ‚Üí electricity used directly from solar during daytime)
        </i>
        <hr>

        <b>Fixed Charges:</b> ‚Çπ${f} <br>
        <b>Total Current Cycle Charges:</b> ‚Çπ${t} <br>

      <b>Per-Unit Rate:</b> ‚Çπ${unitRate ? unitRate.toFixed(2) : "‚Äî"}
        <i class="text-muted">
          = (Total Bill ‚àí Fixed Charges) √∑ (Import ‚àí Export)
        </i>
      </div>

      <!-- COMPARISON -->
      <div class="result-box">
        <h5 class="text-success text-center">
          üí∞ Comparison (Bill)
        </h5>
        <div class="row text-center">
          <div class="col-6 border-end">
            <h6>‚ùå Without Solar</h6>
            <b style="font-size: 1.5rem;">‚Çπ${without.toFixed(0)}</b><br>

            <i class="text-muted small">
              (${g} √ó ‚Çπ${unitRate.toFixed(2)}) + ‚Çπ${f}
            </i><br>

            ${withoutPerDay !== null
              ? `<b>Per Day:</b> ‚Çπ${withoutPerDay.toFixed(0)} / day`
              : `<span class="text-muted small">Per-day not calculated</span>`
            }
          </div>

          <div class="col-6">
            <h6>‚òÄÔ∏è With Solar</h6>
            <b style="font-size: 1.5rem;">‚Çπ${t}</b><br>

            <i class="text-muted small">(Actual bill amount)</i><br>

            ${withPerDay !== null 
              ? `<b>Per Day:</b> ‚Çπ${withPerDay.toFixed(0)} / day` 
              : `<span class="text-muted small">Per-day not calculated</span>`}
          </div>
        </div>
      </div>

      <!-- SAVINGS -->
      <div class="result-box text-center">
        <h5 class="text-success">
          üí∞ Total Saving: ‚Çπ${saving.toFixed(0)} | 
          <i class="text-muted small"> = (‚Çπ${without.toFixed(0)} ‚àí ‚Çπ${t})</i>
        </h5>

        ${savingPerDay !== null 
          ? `<b>Saving (Per Day):</b> ‚Çπ${savingPerDay.toFixed(0)} 
             <i class="text-muted small">(‚Çπ${without.toFixed(0)} ‚àí ‚Çπ${t}) √∑ ${days} days</i><br>` 
          : `<span class="text-muted small">Per-day saving not calculated</span><br>`}
        
        ${annualSaving !== null 
          ? `<b>Estimated Yearly Saving:</b> ‚Çπ${annualSaving.toFixed(0)} / year 
             <i class="text-muted small">Based on current bill's daily saving √ó 365 days</i>` 
          : ``}
      </div>
      
    </div>
  `;
  
  showModal('üìÑ', 'Bill Details - ' + billNum, modalContent, [
    { text: 'Share on WhatsApp', type: 'success', action: () => shareSelectedBillWhatsApp() },
    { text: 'Close', type: 'secondary', action: closeModal }
  ]);
}

// ==========================================
// NEW FUNCTION: Share selected bill on WhatsApp
// Add this function to your script
// ==========================================

function shareSelectedBillWhatsApp() {
  if (selectedBillIndex === null) return;
  
  const bill = userBills[selectedBillIndex];
  
  const g = parseFloat(bill['Gross Units'] || 0);
  const i = parseFloat(bill['Import Units'] || 0);
  const e = parseFloat(bill['Export Units'] || 0);
  const direct = g - i;
  const t = parseFloat(bill['Total Bill Amount'] || 0);
  const without = parseFloat(bill['Bill Without Solar'] || 0);
  const saving = parseFloat(bill['Solar Saving Amount'] || 0);
  
  shareWhatsApp({
    gross: g,
    importU: i,
    exportU: e,
    direct: direct,
    withSolar: t,
    withoutSolar: without.toFixed(0),
    saving: saving.toFixed(0)
  });
  
  closeModal();
}
  
function editSelectedBill() {
  if (selectedBillIndex === null) {
    showErrorModal('Please select a bill first');
    return;
  }
  
  const bill = userBills[selectedBillIndex];
  
  const modalContent = `
    <div style="text-align: left;">
      <h5 style="color: #1e3a8a; margin-bottom: 1rem;">Edit Bill</h5>
      <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 1.5rem;">
        Editing: Bill #${bill['Bill Number']}
      </p>
      
      <div class="mb-3">
        <label class="form-label">Total Consumed Units (Gross Units) *</label>
        <input type="number" class="form-control" id="editGross" value="${bill['Gross Units'] || ''}">
      </div>
      <div class="mb-3">
        <label class="form-label">Import Units (KWHI) *</label>
        <input type="number" class="form-control" id="editImport" value="${bill['Import Units'] || ''}">
      </div>
      <div class="mb-3">
        <label class="form-label">Export Units (KWHE) *</label>
        <input type="number" class="form-control" id="editExport" value="${bill['Export Units'] || ''}">
      </div>
      <div class="mb-3">
        <label class="form-label">Fixed Charges (‚Çπ) *</label>
        <input type="number" class="form-control" id="editFixed" value="${bill['Fixed Charges'] || ''}">
      </div>
      <div class="mb-3">
        <label class="form-label">Total Bill (‚Çπ) *</label>
        <input type="number" class="form-control" id="editTotal" value="${bill['Total Bill Amount'] || ''}">
      </div>
      <div class="mb-3">
        <label class="form-label">Revision Reason</label>
        <input type="text" class="form-control" id="editReason" placeholder="Why are you updating this?">
      </div>
    </div>
  `;
  
  showModal('‚úèÔ∏è', 'Edit Bill', modalContent, [
    { text: 'Cancel', type: 'secondary', action: closeModal },
    { text: 'Save Changes', type: 'primary', action: saveEditedBill }
  ]);
}

async function saveEditedBill() {
  const bill = userBills[selectedBillIndex];
  
  const updatedData = {
    billNumber: bill['Bill Number'],
    meterNumber: bill['Meter Number'],
    accountNumber: bill['Account Number'],
    entryType: 'EDIT',
    revisionReason: document.getElementById('editReason').value || 'Updated by user',
    grossUnits: parseFloat(document.getElementById('editGross').value),
    importUnits: parseFloat(document.getElementById('editImport').value),
    exportUnits: parseFloat(document.getElementById('editExport').value),
    fixedCharges: parseFloat(document.getElementById('editFixed').value),
    totalBillAmount: parseFloat(document.getElementById('editTotal').value)
  };
  
  closeModal();
  
  const billsList = document.getElementById('billsList');
  billsList.innerHTML = '<div style="text-align: center; padding: 3rem;"><div class="spinner"></div><p style="margin-top: 1rem; color: #64748b;">Updating bill...</p></div>';
  
  try {
    const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedData)
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      selectedBillIndex = null;
      await authenticateUserSilent();
    } else {
      showErrorModal('Failed to update: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error(error);
    showErrorModal('‚ùå Connection error');
  }
}

function deleteSelectedBill() {
  if (selectedBillIndex === null) {
    showErrorModal('Please select a bill first');
    return;
  }
  
  const bill = userBills[selectedBillIndex];
  
  showModal('‚ö†Ô∏è', 'Confirm Deletion', `
    <p>Are you sure you want to delete this bill?</p>
    <div class="alert alert-danger">
      <div><strong>Bill #${bill['Bill Number']}</strong></div>
      <div class="small mt-2">Entered on: ${bill['Entry DateTime'] ? new Date(bill['Entry DateTime']).toLocaleDateString('en-IN') : 'N/A'}</div>
    </div>
    <p class="small text-muted">This will mark the bill as inactive.</p>
  `, [
    { text: 'Cancel', type: 'secondary', action: closeModal },
    { text: 'Yes, Delete', type: 'primary', action: confirmDeleteBill }
  ]);
}

async function confirmDeleteBill() {
  const bill = userBills[selectedBillIndex];
  
  closeModal();
  
  const billsList = document.getElementById('billsList');
  billsList.innerHTML = '<div style="text-align: center; padding: 3rem;"><div class="spinner"></div><p style="margin-top: 1rem; color: #64748b;">Deleting bill...</p></div>';
  
  try {
    const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        billNumber: bill['Bill Number'],
        meterNumber: bill['Meter Number'],
        accountNumber: bill['Account Number']
      })
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      selectedBillIndex = null;
      await authenticateUserSilent();
    } else {
      showErrorModal('Failed to delete: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error(error);
    showErrorModal('‚ùå Connection error');
  }
}

function logout() {
  currentUser = null;
  userBills = [];
  selectedBillIndex = null;
  resetIntent();
}

// ==========================================
// MODAL FUNCTIONS
// ==========================================
function showModal(icon, title, message, buttons) {
  document.getElementById('modalIcon').textContent = icon;
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalMessage').innerHTML = message;
  
  const btnContainer = document.getElementById('modalButtons');
  btnContainer.innerHTML = '';
  buttons.forEach(btn => {
    const button = document.createElement('button');
    button.className = `btn btn-${btn.type} flex-fill`;
    button.textContent = btn.text;
    button.onclick = btn.action;
    btnContainer.appendChild(button);
  });
  
  document.getElementById('customModal').classList.add('show');
}

function closeModal() {
  document.getElementById('customModal').classList.remove('show');
}

function showSuccessModal(msg) {
  showModal('‚úÖ', 'Success', msg, [{ text: 'OK', type: 'primary', action: closeModal }]);
}

function showErrorModal(msg) {
  showModal('‚ùå', 'Error', msg, [{ text: 'OK', type: 'primary', action: closeModal }]);
}

// ==========================================
// HELPERS
// ==========================================
function openHelpModal() {
  alert("Help content will be shown here");
}

function handleNumericInput(el){
  // Allow +, digits, spaces
  el.value = el.value.replace(/[^0-9+\s]/g,"");
}

function appendPlus(id){
  const el=document.getElementById(id);
  if(!el.value.endsWith("+")) el.value+= el.value ? "+" : "";
  el.focus();
}

function clearErrors(){
  document.querySelectorAll(".invalid-feedback").forEach(e => e.remove());
  document.querySelectorAll(".is-invalid").forEach(e => e.classList.remove("is-invalid"));
}

function parsePlusExpression(input, fieldName) {
  if (!input || !input.trim()) return 0;

  if (!/^[0-9+\s]+$/.test(input)) {
    throw new Error(fieldName + " can contain only numbers and '+' sign");
  }

  let cleaned = input.trim().replace(/\+\s*$/, "");
  const parts = cleaned.split("+");
  let sum = 0;

  for (let part of parts) {
    const val = part.trim();
    if (val === "") continue;
    sum += Number(val);
  }

  return sum;
}

function resetIntent(){
  entryMode = "one";
  currentUser = null;
  userBills = [];
  selectedBillIndex = null;

  // Hide all sections first
  document.getElementById("intentSummary")?.classList.add("d-none");
  document.getElementById("consumptionSection")?.classList.add("d-none");
  document.getElementById("identitySection")?.classList.add("d-none");
  document.getElementById("billPeriodSection")?.classList.add("d-none");
  document.getElementById("authSection")?.classList.add("d-none");
  document.getElementById("dashboardSection")?.classList.add("d-none");
  document.getElementById("actionBtn")?.classList.add("d-none");
  
  // Show intent section
  document.getElementById("intentSection")?.classList.remove("d-none");
  document.getElementById("helperCards")?.classList.remove("d-none");
  
  // IMPORTANT: Force display block
  const intentSection = document.getElementById("intentSection");
  if (intentSection) {
    intentSection.style.display = "block";
  }
  
  // Clear active state from cards
  document.querySelectorAll('.intent-card-modern').forEach(card => {
    card.classList.remove('active');
  });
  
  // Clear result
  document.getElementById("result").innerHTML = "";
  
  // Scroll to top
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
  
  console.log('‚úì Reset to intent selection');
}

function validateUnits(){
  clearErrors();

  let g, i, e;
  try {
    g = parsePlusExpression(gross.value, "Gross Units");
    i = parsePlusExpression(importU.value, "Import Units");
    e = parsePlusExpression(exportU.value, "Export Units");
  } catch {
    return;
  }

  // Only ONE strict rule
  if (g <= 0) {
    markError(gross, "Gross units must be greater than zero");
  }

  if (i < 0 || e < 0) {
    showHint("Import / Export units cannot be negative");
  }
}
// ==========================================
// HELPER: Show hint message (non-blocking)
// Add this function if you don't have it
// ==========================================
function showHint(msg) {
  const hint = document.createElement('div');
  hint.className = 'alert alert-info alert-dismissible fade show';
  hint.style.position = 'fixed';
  hint.style.top = '20px';
  hint.style.right = '20px';
  hint.style.zIndex = '9999';
  hint.innerHTML = `
    ${msg}
    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
  `;
  document.body.appendChild(hint);
  
  setTimeout(() => hint.remove(), 5000);
}


function markError(el,msg){
  el.classList.add("is-invalid");
  const d=document.createElement("div");
  d.className="invalid-feedback";
  d.innerText=msg;
  el.parentNode.appendChild(d);
}

// ==========================================
// COMPLETE FIXED calculate() FUNCTION
// With: 1) Surplus unit rate fix
//       2) Days calculation fix
//       3) PROMINENT CARRY FORWARD DISPLAY
// ==========================================

async function calculate() {
  
  // ========================================
  // DISABLE BUTTON IMMEDIATELY
  // ========================================
  const actionBtn = document.getElementById('actionBtn');
  let originalText = '';
  
  if (actionBtn) {
    originalText = actionBtn.innerText;
    actionBtn.disabled = true;
    actionBtn.style.opacity = '0.6';
    actionBtn.style.cursor = 'not-allowed';
    actionBtn.innerText = '‚è≥ Processing...';
  }

  // ---------- BASIC VALIDATION ----------
  if (document.querySelector(".is-invalid")) {
    alert("Please correct highlighted fields");
    
    // RE-ENABLE BUTTON ON ERROR
    if (actionBtn) {
      actionBtn.disabled = false;
      actionBtn.style.opacity = '1';
      actionBtn.style.cursor = 'pointer';
      actionBtn.innerText = originalText;
    }
    return;
  }

  // ---------- DECLARATIONS ----------
  let g=0, i=0, e=0, f=0, t=0, a=0;
  let direct = 0;
  let netGridUnits = 0;

  let openingCarry = 0;
  let closingCarryForward = 0;
  let billableUnits = 0;

  let unitRate = 0;
  let estimatedRate = 0;
  let without = 0;
  let saving = 0;
  let savingPercent = 0;

  // ---------- PARSE INPUTS ----------
  try {
    g = entryMode === "save" ? Number(gross.value) : parsePlusExpression(gross.value, "Gross Units");
    i = entryMode === "save" ? Number(importU.value) : parsePlusExpression(importU.value, "Import Units");
    e = entryMode === "save" ? Number(exportU.value) : parsePlusExpression(exportU.value, "Export Units");
    f = entryMode === "save" ? Number(fixed.value) : parsePlusExpression(fixed.value, "Fixed Charges");
    t = entryMode === "save" ? Number(totalBill.value) : parsePlusExpression(totalBill.value, "Total Bill Amount");
    a = entryMode === "save" ? Number(arrears.value) : parsePlusExpression(arrears.value, "Arrears");

    direct = g - i;
    netGridUnits = i - e;

  } catch (err) {
    alert(err.message);
    return;
  }

  // ---------- BILL PERIOD (OPTIONAL) ----------
  const billFromEl = document.getElementById("billFrom");
  const billToEl   = document.getElementById("billTo");

  let days = null;
  let from = null;
  let to = null;

  if (billFromEl?.value && billToEl?.value) {
    from = new Date(billFromEl.value);
    to   = new Date(billToEl.value);
    const diffMs = to - from;
    if (diffMs > 0) {
      days = Math.round(diffMs / (1000 * 60 * 60 * 24)) + 1;
    }
  }

  // =================================================
  // MODE 1: ONE-TIME QUICK CALCULATION
  // =================================================
  if (entryMode === "one") {

    if (netGridUnits <= 0) {
      alert("This month has surplus solar generation.\n\nPlease use 'Save for future reference' to track carry-forward benefits.");
      return;
    }

    billableUnits = netGridUnits;
    unitRate = (t - f) / billableUnits;
    estimatedRate = unitRate;
    
    without = (g * estimatedRate) + f;
    saving = without - t;
    savingPercent = without > 0 ? (saving / without) * 100 : 0;
  }

  // =================================================
  // MODE 2: SAVE FOR FUTURE (WITH CARRY FORWARD)
  // =================================================
  if (entryMode === "save") {

    const billNum = document.getElementById("billNumber")?.value;
    const meter = document.getElementById("meter")?.value;
    const accountNum = document.getElementById("accountNum")?.value;

    if (!billNum || !meter || !accountNum) {
      alert("Please fill Bill Number, Meter Number, and Account Number");
      return;
    }

    openingCarry = Number(document.getElementById("openingCarry")?.value || 0);

    if (billFromEl?.value) {
      const month = new Date(billFromEl.value).getMonth();
      if (month === 3) openingCarry = 0;
    }

    const adjustedNet = netGridUnits - openingCarry;

    if (adjustedNet > 0) {
      billableUnits = adjustedNet;
      closingCarryForward = 0;
    } else {
      billableUnits = 0;
      closingCarryForward = Math.abs(adjustedNet);
    }

    if (billableUnits > 0) {
      unitRate = (t - f) / billableUnits;
      estimatedRate = unitRate;
    } else {
      unitRate = 0;
      estimatedRate = 6.50;
    }

    without = (g * estimatedRate) + f;
    saving = without - t;
    savingPercent = without > 0 ? (saving / without) * 100 : 0;

    const webhookData = {
      billNumber: billNum,
      meterNumber: meter,
      accountNumber: accountNum,
      billPeriod: {
        from: billFromEl?.value || null,
        to: billToEl?.value || null,
        days: days
      },
      consumption: {
        grossUnits: g,
        importUnits: i,
        exportUnits: e,
        directSolarUsed: direct
      },
      charges: {
        fixedCharges: f,
        totalBillAmount: t,
        arrears: a,
        perUnitRate: unitRate ? parseFloat(unitRate.toFixed(2)) : 0,
        estimatedRate: parseFloat(estimatedRate.toFixed(2))
      },
      calculation: {
        billWithSolar: t,
        billWithoutSolar: parseFloat(without.toFixed(2)),
        totalSaving: parseFloat(saving.toFixed(2)),
        savingPercentage: parseFloat(savingPercent.toFixed(2)),
        savingPerDay: days > 0 ? parseFloat((saving / days).toFixed(2)) : null,
        annualSaving: days > 0 ? parseFloat(((saving / days) * 365).toFixed(2)) : null
      },
      carryForward: {
        openingCarry: openingCarry,
        closingCarryForward: closingCarryForward,
        netGridUnits: netGridUnits,
        billableUnits: billableUnits
      }
    };

console.log("Sending to webhook:", webhookData);
    
    // Determine webhook URL based on edit mode
    const isEditing = window.isEditingBill && window.editingBillIndex !== null;
    const webhookUrl = isEditing 
      ? 'https://n8n-workflow-test.duckdns.org/webhook/solar-update'
      : 'https://n8n-workflow-test.duckdns.org/webhook/solar-saving';
    
    console.log("Using webhook:", webhookUrl, "| Editing:", isEditing);

    try {
      const response = await fetch(webhookUrl, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(webhookData)
      });

      console.log("Response status:", response.status);

if (response.ok) {
        const data = await response.json().catch(() => ({ status: 'success' }));
        console.log("Response data:", data);

        if (data.status === 'error' && data.code === 'DUPLICATE_FOUND') {
          alert('‚ö†Ô∏è Duplicate bill found! This bill already exists.');
          return;
        }
        
        console.log("‚úÖ Bill saved successfully");
        
        // CHECK IF EDITING OR ADDING NEW
        if (window.isEditingBill && window.editingBillIndex !== null) {
          // UPDATE EXISTING BILL
          console.log('Updating existing bill at index:', window.editingBillIndex);
          
          // ‚úÖ FIX: Refresh bills from server after update
          await authenticateUserSilent();
          
          // Clear editing state
          window.isEditingBill = false;
          window.editingBillIndex = null;
          
console.log('‚úÖ Bill updated and dashboard refreshed');
          
          // Clear editing state
          window.isEditingBill = false;
          window.editingBillIndex = null;
          
          // Hide cancel button
          const cancelBtn = document.getElementById('cancelEditBtn');
          if (cancelBtn) cancelBtn.style.display = 'none';
          
          // Show success message
          showSuccessModal('‚úÖ Bill updated successfully!');
          
          // Return to dashboard after 1 second
          setTimeout(() => {
            closeModal();
            
            // ‚úÖ FIX: Go directly to dashboard without re-authentication
            // Hide form sections
            document.getElementById('consumptionSection')?.classList.add('d-none');
            document.getElementById('identitySection')?.classList.add('d-none');
            document.getElementById('billPeriodSection')?.classList.add('d-none');
            document.getElementById('carryForwardSection')?.classList.add('d-none');
            document.getElementById('actionBtn')?.classList.add('d-none');
            document.getElementById('intentSummary')?.classList.add('d-none');
            document.getElementById('intentSection')?.classList.add('d-none');
            document.getElementById('authSection')?.classList.add('d-none');
            document.getElementById('awardSummary')?.classList.add('d-none');
            
            // Show dashboard
            document.getElementById('dashboardSection')?.classList.remove('d-none');
            
            // Refresh bill list display
            displayBillsList();
            
            // Show home button
            showHomeButton();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }, 1000);
          
          return;
        } else {
          // ADD NEW BILL
          console.log('Adding new bill');
          
          const bills = window.userBills || [];
          bills.unshift(webhookData); // Add to beginning
          window.userBills = bills;
          
          // Save to localStorage
          saveBillsToStorage(bills);
          
          console.log('New bill added successfully');
        }
        
      } else {
        throw new Error('Server returned error status: ' + response.status);
      }
    } catch (error) {
      console.error("Webhook error:", error);
      alert('‚ö†Ô∏è Failed to save to server: ' + error.message + '\n\nShowing results anyway.');
    }
  }

  // ---------- DAILY/ANNUAL CALCULATIONS ----------
  const withPerDay = days !== null && days > 0 ? (t / days) : null;
  const withoutPerDay = days !== null && days > 0 ? (without / days) : null;
  let savingPerDay = null;
  let annualSaving = null;

  if (days && days > 0) {
    savingPerDay = saving / days;
    annualSaving = savingPerDay * 365;
  }

  // ========================================
  // BUILD MODAL CONTENT - WITH CARRY FORWARD!
  // ========================================
  const modalContent = `
    <div style="text-align: left;">
      <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #0b5ed7;">
        <div style="font-size: 0.85rem; color: #64748b;">
          <strong>${entryMode === "one" ? "Quick Calculator" : "üíæ Bill Saved Successfully"}</strong>
        </div>
      </div>
      
      <!-- INPUT SUMMARY -->
      <div class="result-box">
        <h6>üì• Input Summary</h6>
        <b>Bill Period:</b> ${from ? from.toLocaleDateString("en-IN") : "‚Äî"} 
        to ${to ? to.toLocaleDateString("en-IN") : "‚Äî"} | 
        <b>Days:</b> ${days ?? "‚Äî"}<br><br>

        <b>Total Consumed Units (Gross Units):</b> ${g}<br>
        <b>Import Units (KWHI):</b> ${i} &nbsp; | &nbsp;
        <b>Export Units (KWHE):</b> ${e}<br>

        <b>Direct Solar Used:</b> ${direct} units  
        <i class="text-muted">
          (Gross ‚àí Import ‚Üí electricity used directly from solar during daytime)
        </i>
        <hr>

        <b>Fixed Charges:</b> ‚Çπ${f}<br>
        <b>Total Current Cycle Charges:</b> ‚Çπ${t}<br>

        <b>Per-Unit Rate:</b> ${unitRate > 0 ? '‚Çπ' + unitRate.toFixed(2) : 'N/A (no energy charges)'}
        ${billableUnits === 0 ? '<br><b>Estimated Rate Used:</b> ‚Çπ' + estimatedRate.toFixed(2) + ' <i class="text-muted">(for savings comparison)</i>' : ''}
        ${billableUnits > 0 ? '<br><i class="text-muted">= (Total Bill ‚àí Fixed Charges) √∑ Billable Units</i>' : ''}
      </div>

      <!-- GRID SUPPLY & CARRY FORWARD -->
      ${entryMode === "save" ? `
      <div class="result-box" style="background: ${closingCarryForward > 0 ? '#f0fdf4' : '#f8fafc'}; border-left: 4px solid ${closingCarryForward > 0 ? '#22c55e' : '#94a3b8'};">
        <h6>‚ö° Grid Supply & Carry Forward</h6>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">
          <div>
            <b>Import from Grid:</b> ${i} units<br>
            <b>Export to Grid:</b> ${e} units
          </div>
          <div>
            <b>Net Grid Units:</b> ${netGridUnits} units<br>
            <i class="text-muted small">(Import ‚àí Export)</i>
          </div>
        </div>

        <hr>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <b>Opening Carry:</b> ${openingCarry} units<br>
            <i class="text-muted small">(From previous month)</i>
          </div>
          <div>
            <b>Billable Units:</b> ${billableUnits} units<br>
            <i class="text-muted small">(What you pay for)</i>
          </div>
        </div>

        ${closingCarryForward > 0 ? `
        <div style="background: #dcfce7; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 2px solid #22c55e;">
          <div style="text-align: center;">
            <h5 style="color: #15803d; margin-bottom: 0.5rem;">
              üéâ Surplus Generation!
            </h5>
            <div style="font-size: 2rem; font-weight: bold; color: #15803d;">
              ${closingCarryForward} units
            </div>
            <div style="font-size: 0.9rem; color: #166534; margin-top: 0.5rem;">
              <strong>Closing Carry Forward</strong><br>
              Credit for next month's bill
            </div>
            <div style="font-size: 0.85rem; color: #65a30d; margin-top: 0.75rem; padding: 0.5rem; background: rgba(255,255,255,0.5); border-radius: 6px;">
              üí° These ${closingCarryForward} units will reduce your next month's billing!<br>
              Estimated value: ‚Çπ${(closingCarryForward * estimatedRate).toFixed(0)} @ ‚Çπ${estimatedRate.toFixed(2)}/unit
            </div>
          </div>
        </div>
        ` : ''}
      </div>
      ` : ''}

      <!-- COMPARISON -->
      <div class="result-box">
        <h5 class="text-success text-center">
          üí∞ Comparison (Bill)
        </h5>
        <div class="row text-center">
          <div class="col-6 border-end">
            <h6>‚ùå Without Solar</h6>
            <b style="font-size: 1.5rem;">‚Çπ${without.toFixed(0)}</b><br>

            <i class="text-muted small">
              (${g} √ó ‚Çπ${estimatedRate.toFixed(2)}) + ‚Çπ${f}
            </i><br>

            ${withoutPerDay !== null
              ? `<b>Per Day:</b> ‚Çπ${withoutPerDay.toFixed(0)} / day`
              : `<span class="text-muted small">Per-day not calculated</span>`
            }
          </div>

          <div class="col-6">
            <h6>‚òÄÔ∏è With Solar</h6>
            <b style="font-size: 1.5rem;">‚Çπ${t}</b><br>

            <i class="text-muted small">(Actual bill amount)</i><br>

            ${withPerDay !== null 
              ? `<b>Per Day:</b> ‚Çπ${withPerDay.toFixed(0)} / day` 
              : `<span class="text-muted small">Per-day not calculated</span>`}
          </div>
        </div>
      </div>

      <!-- SAVINGS -->
      <div class="result-box text-center">
        <h5 class="text-success">
          üí∞ Total Saving: ‚Çπ${saving.toFixed(0)} | 
          <i class="text-muted small"> = (‚Çπ${without.toFixed(0)} ‚àí ‚Çπ${t})</i>
        </h5>

        ${savingPerDay !== null 
          ? `<b>Saving (Per Day):</b> ‚Çπ${savingPerDay.toFixed(0)} 
             <i class="text-muted small">(‚Çπ${without.toFixed(0)} ‚àí ‚Çπ${t}) √∑ ${days} days</i><br>` 
          : `<span class="text-muted small">Per-day saving not calculated</span><br>`}
        
        ${annualSaving !== null 
          ? `<b>Estimated Yearly Saving:</b> ‚Çπ${annualSaving.toFixed(0)} / year 
             <i class="text-muted small">Based on current bill's daily saving √ó 365 days</i>` 
          : ``}
        
        ${closingCarryForward > 0
          ? `<br><br><div class="alert alert-success" style="font-size: 0.9rem; margin-top: 1rem;">
             <strong>üåü Bonus Benefit:</strong> Your ${closingCarryForward} units carry forward 
             will provide additional savings of approximately ‚Çπ${(closingCarryForward * estimatedRate).toFixed(0)} in next month's bill!
             </div>` 
          : ''}
      </div>
    </div>
  `;

  // ========================================
  // SHOW MODAL WITH RESULTS
  // ========================================
  
  window.lastCalculation = {
    gross: g,
    importU: i,
    exportU: e,
    direct: direct,
    withSolar: t,
    withoutSolar: without.toFixed(0),
    saving: saving.toFixed(0)
  };

const isEditing = window.isEditingBill;
  
// Check if editing - save and return to dashboard immediately
  if (isEditing) {
    console.log('‚úÖ Bill updated successfully');
    
    // Clear editing flags
    window.isEditingBill = false;
    window.editingBillIndex = null;
    
    // Hide cancel button
    const cancelBtn = document.getElementById('cancelEditBtn');
    if (cancelBtn) cancelBtn.style.display = 'none';
    
    // Reset action button completely
    if (actionBtn) {
      actionBtn.disabled = false;
      actionBtn.style.opacity = '1';
      actionBtn.style.cursor = 'pointer';
      actionBtn.innerText = 'Calculate Solar Benefit';
    }
    
    // Return to dashboard immediately
    setTimeout(() => {
      selectIntent('dashboard');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
    
    return; // Exit - don't show modal or award summary
  }
  // For new bills - show modal as usual
  showModal(
    'üìä', 
    entryMode === "one" ? "Quick Calculator Result" : "‚úÖ Bill Saved Successfully!", 
    modalContent, 
    [
      { text: 'Share on WhatsApp', type: 'success', action: () => { shareWhatsApp(window.lastCalculation); closeModal(); } },
      { text: 'Close', type: 'secondary', action: closeModal }
    ]
  );
// ===== Award Summary Hook (UI only) =====
// ===== Award Summary Hook (UI only) =====

// üîÅ EDIT MODE: detect via editingIndex (source of truth)
if (editingIndex !== null && editingIndex !== undefined) {
  console.log("‚úÖ Edit-mode save detected. Returning to dashboard.");

  // reset edit state
  isEditMode = false;
  editingIndex = null;

  // clear form
  clearBillForm();

  // clear radio + card selection
  clearBillSelection();

  // hide award summary
  const awardSummary = document.getElementById("awardSummary");
  if (awardSummary) awardSummary.classList.add("d-none");

  // exit entry UI
  exitBillEntryMode();

  // reset dashboard buttons
  resetDashboardActions();

  // show dashboard
  document.getElementById("dashboardSection")?.classList.remove("d-none");

  return; // ‚õî STOP here ‚Äì do NOT render summary
}

/* =====================================================
   üü¢ NON-EDIT MODE (New / Quick Calculation)
   ===================================================== */

const awardSavingEl = document.getElementById("awardSaving");
const awardUnitsEl = document.getElementById("awardUnits");
const awardPercentEl = document.getElementById("awardPercent");
const awardPayableEl = document.getElementById("awardPayable");
const awardWithoutSolarEl = document.getElementById("awardWithoutSolar");

if (awardSavingEl) awardSavingEl.innerText = saving.toFixed(0);
if (awardUnitsEl) awardUnitsEl.innerText = e || 0;
if (awardPercentEl)
  awardPercentEl.innerText =
    without > 0 ? ((saving / without) * 100).toFixed(1) : 0;
if (awardPayableEl) awardPayableEl.innerText = t || 0;
if (awardWithoutSolarEl) awardWithoutSolarEl.innerText = without.toFixed(0);

const awardSummary = document.getElementById("awardSummary");
if (awardSummary) awardSummary.classList.remove("d-none");

// Update button state
if (actionBtn) {
  actionBtn.disabled = true;
  actionBtn.style.opacity = "0.5";
  actionBtn.innerText = entryMode === "save" ? "‚úÖ Saved" : "‚úÖ Calculated";
}

}
function exitAfterSuccessfulEdit() {
  console.log("‚Ü© Exiting edit mode");
  
  // ‚úÖ SHOW single mode actions (keep them visible)
  const singleActions = document.getElementById('singleModeActions');
  const summaryActions = document.getElementById('summaryModeActions');

  if (singleActions) singleActions.style.display = 'flex';   // Keep visible
  if (summaryActions) summaryActions.style.display = 'none';
  
  // ‚úÖ CRITICAL FIX: Disable all action buttons (but keep visible)
    selectedBillIndex = null;
  const viewBtn = document.getElementById('viewBtn');
  const editBtn = document.getElementById('editBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  
  if (viewBtn) viewBtn.disabled = true;
  if (editBtn) editBtn.disabled = true;
  if (deleteBtn) deleteBtn.disabled = true;
  
  // ‚úÖ Reset selected bill index
  selectedBillIndex = null;
  
  // Clear edit state
  window.isEditMode = false;
  window.editingBillIndex = null;
  editingIndex = null;

  // Clear form and selections
  clearBillForm();
  clearBillSelection();

  // Hide award summary
  document.getElementById("awardSummary")?.classList.add("d-none");

  // Exit bill entry UI
  exitBillEntryMode();

  // Render bills (this will redraw all cards)
  renderBillCards(window.userBills || []);

  // Show dashboard
  document.getElementById("dashboardSection")?.classList.remove("d-none");
  
  console.log("‚úÖ All buttons disabled (but visible), no bill selected");
}



function shareWhatsApp(data){
  const msg = encodeURIComponent(
`‚òÄÔ∏è SolarSanchay ‚Äì Solar Saving Result

Total Consumed Units (Gross Units): ${data.gross}
Import Units (KWHI): ${data.importU}
Export Units (KWHE): ${data.exportU}
Direct Solar Used: ${data.direct} units

Bill With Solar: ‚Çπ${data.withSolar}
Estimated Bill Without Solar: ‚Çπ${data.withoutSolar}

üí∞ Saving: ‚Çπ${data.saving}`
  );
  window.open(`https://wa.me/?text=${msg}`);
}

document.getElementById("lastModified").innerText =
  new Date(document.lastModified).toLocaleString("en-IN");

// ========================================
// Check Carry Forward Warnings (Dynamic Hints)
// ========================================
function checkCarryForwardWarnings() {
  const billFromEl = document.getElementById("billFrom");
  const openingCarryEl = document.getElementById("openingCarry");
  const hintDiv = document.getElementById("carryForwardHint");
  
  if (!billFromEl?.value || !hintDiv) return;
  
  const billDate = new Date(billFromEl.value);
  const month = billDate.getMonth(); // 0-11 (0=Jan, 3=Apr)
  const year = billDate.getFullYear();
  const openingCarryValue = Number(openingCarryEl.value || 0);
  
  let hintHTML = '';
  
  // CASE 1: April (Financial Year Start)
  if (month === 3) {
    if (openingCarryValue > 0) {
      // User entered carry forward in April - might be same FY
      hintHTML = `
        <div class="carry-warning carry-warning-april">
          <strong>‚ö†Ô∏è Financial Year Alert:</strong><br>
          April marks the start of India's Financial Year (FY ${year}-${year+1}).<br><br>
          
          <strong>You entered ${openingCarryValue} units carry forward.</strong><br><br>
          
          <strong>Is this correct?</strong><br>
          </div>
      `;
    } else {
      // User entered 0 in April - this is expected for new FY
      hintHTML = `
        <div class="carry-warning carry-warning-success">
          <strong>‚úì Correct for New Financial Year</strong><br>
          You've correctly reset carry forward to 0 for FY ${year}-${year+1}.<br>
          Any surplus from this month will create new carry forward.
        </div>
      `;
    }
  }
  
  // CASE 2: Other months with carry forward
  else if (openingCarryValue > 0) {
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const prevMonth = month === 0 ? 11 : month - 1;
    const prevMonthName = monthNames[prevMonth];
    const prevYear = month === 0 ? year - 1 : year;
    
    hintHTML = `
      <div class="carry-warning carry-warning-success">
        <strong>‚úì Using Carry Forward from Previous Bill</strong><br>
        You have ${openingCarryValue} units credit from ${prevMonthName} ${prevYear}.<br>
        This will reduce your billable units this month! üí∞
      </div>
    `;
  }
  
  // CASE 3: Other months with no carry forward
  else {
    hintHTML = `
      <div class="carry-warning carry-warning-info">
        <strong>‚ÑπÔ∏è No Carry Forward</strong><br>
        Starting fresh this month. If previous month had surplus generation,<br>
        enter the "Closing Carry Forward" value here.
      </div>
    `;
  }
  
  hintDiv.innerHTML = hintHTML;
}

// ========================================
// Show Detailed Carry Forward Help (Modal)
// ========================================
function showCarryForwardHelp() {
  const helpContent = `
    <div style="text-align: left;">
      <h5 style="color: #0b5ed7; margin-bottom: 1rem;">
        üìö Understanding Opening Carry Forward
      </h5>
      
      <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <strong>What is Carry Forward?</strong><br>
        When your solar exports MORE units than you import in a month,
        the surplus units are "carried forward" as credit for the next month.
      </div>
      
      <div style="background: #d1e7dd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <strong>‚úì How to Use This Field:</strong><br>
        1. Check your <strong>previous month's bill</strong><br>
        2. Look for "Closing Carry Forward" value<br>
        3. Enter that value here as "Opening Carry Forward"<br>
        4. This will reduce your current month's billing!
      </div>
      
      <div style="background: #cfe2ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <strong>üí° Example Scenario:</strong><br><br>
        
        <strong>Month 1 (Surplus Generated):</strong><br>
        ‚Ä¢ Import: 320 units, Export: 450 units<br>
        ‚Ä¢ Net: -130 units (surplus!)<br>
        ‚Ä¢ Closing Carry Forward: 130 units<br><br>
        
        <strong>Month 2 (Using Carry Forward):</strong><br>
        ‚Ä¢ Opening Carry Forward: <strong>130 units</strong> ‚Üê Enter from previous bill!<br>
        ‚Ä¢ Import: 480 units, Export: 310 units<br>
        ‚Ä¢ Net: 170 units<br>
        ‚Ä¢ After carry forward: 170 - 130 = <strong>40 units</strong><br>
        ‚Ä¢ You only pay for 40 units! üí∞<br>
        ‚Ä¢ Savings from carry: 130 √ó ‚Çπ6.50 = ‚Çπ845
      </div>
      
      <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border-left: 4px solid #ffc107;">
        <strong>‚ö†Ô∏è Important Policy Note:</strong><br>
        Different states have different policies regarding carry forward,
        especially at Financial Year end (March 31).<br><br>
        
        <strong>Please check:</strong><br>
        ‚Ä¢ Your state's Net Metering Policy<br>
        ‚Ä¢ DISCOM regulations<br>
        ‚Ä¢ Policy information shown at the top of this page<br><br>
        
        <a href="#" onclick="closeModal(); setTimeout(() => showMarchResetHelp(), 300); return false;">
          üìÖ Learn about March 31 Reset Policy ‚Üí
        </a>
      </div>
      
      <hr style="margin: 1.5rem 0;">
      
      <div style="font-size: 0.9rem; color: #6c757d;">
        <strong>Need more help?</strong><br>
        ‚Ä¢ üìä <a href="#" onclick="closeModal(); setTimeout(() => show90LimitHelp(), 300); return false;">
          90% Annual Limit Guide</a><br>
        ‚Ä¢ üìû Contact your DISCOM for policy details
      </div>
    </div>
  `;
  
  showModal(
    'üìö',
    'Carry Forward Help Guide',
    helpContent,
    [
      { text: 'Got it!', type: 'primary', action: closeModal }
    ]
  );
}

// ========================================
// Trigger warnings when bill date changes
// ========================================
document.getElementById("billFrom")?.addEventListener("change", checkCarryForwardWarnings);
document.getElementById("openingCarry")?.addEventListener("blur", checkCarryForwardWarnings);

// Initial check when page loads
if (document.getElementById("carryForwardSection")) {
  setTimeout(checkCarryForwardWarnings, 500);
}

// ==========================================
// 90% LIMIT AWARENESS - SIMPLE VERSION
// ==========================================

// Update annual statistics on dashboard load
function updateAnnualStats() {
  const bills = window.userBills || [];
  const currentFY = getCurrentFinancialYear();
  const fyBills = bills.filter(bill => {
    const billDate = bill['Bill From Date'] || bill.billFromDate;
    if (!billDate) return false;
    return isInFinancialYear(billDate, currentFY);
  });
  
  if (fyBills.length === 0) {
    const statsCard = document.getElementById('annualStatsCard');
    if (statsCard) statsCard.style.display = 'none';
    return;
  }
  
  // Calculate totals
  let totalConsumption = 0;
  let totalGeneration = 0;
  
  fyBills.forEach(bill => {
    totalConsumption += parseFloat(bill['Gross Units'] || bill.grossUnits || 0);
    const imp = parseFloat(bill['Import Units'] || bill.importUnits || 0);
    const exp = parseFloat(bill['Export Units'] || bill.exportUnits || 0);
    const gross = parseFloat(bill['Gross Units'] || bill.grossUnits || 0);
    totalGeneration += (gross - imp) + exp;
  });
  
  const ratio = totalConsumption > 0 ? (totalGeneration / totalConsumption * 100) : 0;
  const referenceLimit = totalConsumption * 0.9;
  
  // Update display
  const statsCard = document.getElementById('annualStatsCard');
  if (statsCard) {
    statsCard.style.display = 'block';
    
    document.getElementById('statConsumption').textContent = totalConsumption.toFixed(0);
    document.getElementById('statGeneration').textContent = totalGeneration.toFixed(0);
    document.getElementById('statRatio').textContent = ratio.toFixed(1) + '%';
    document.getElementById('stat90Ref').textContent = referenceLimit.toFixed(0);
    
    // Warning color
    const warningBox = document.getElementById('limitWarning');
    if (warningBox) {
      if (ratio >= 90) {
        warningBox.style.background = '#fee2e2';
        warningBox.style.borderColor = '#ef4444';
      } else if (ratio >= 80) {
        warningBox.style.background = '#fef3c7';
        warningBox.style.borderColor = '#f59e0b';
      } else {
        warningBox.style.background = '#dcfce7';
        warningBox.style.borderColor = '#22c55e';
      }
    }
  }
}
function isInFinancialYear(dateStr, fy) {
  const date = new Date(dateStr);
  const year = date.getFullYear();
  const month = date.getMonth();
  
  if (month >= 3) {
    return year === fy.start;
  } else {
    return year === fy.end;
  }
}
function getCurrentFinancialYear() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth(); // 0-11
  
  // FY starts April (month 3)
  if (month >= 3) {
    return { start: year, end: year + 1 };
  } else {
    return { start: year - 1, end: year };
  }
}
// Helper: Get current FY bills
function filterCurrentFYBills(bills) {
  const today = new Date();
  const currentYear = today.getFullYear();
  const currentMonth = today.getMonth(); // 0-11
  
  // Determine FY start year
  const fyStartYear = currentMonth < 3 ? currentYear - 1 : currentYear;
  const fyStart = new Date(fyStartYear, 3, 1); // April 1
  const fyEnd = new Date(fyStartYear + 1, 2, 31); // March 31
  
  return bills.filter(bill => {
    if (!bill.billPeriod || !bill.billPeriod.from) return false;
    const billDate = new Date(bill.billPeriod.from);
    return billDate >= fyStart && billDate <= fyEnd;
  });
}

// Show warning message based on ratio
function showLimitWarning(ratio, generation, limit90) {
  const warningBox = document.getElementById('limitWarningBox');
  if (!warningBox) return;
  
  let html = '';
  
  if (ratio >= 90) {
    // Exceeded 90%
    const excess = generation - limit90;
    html = `
      <div class="alert alert-danger" style="margin: 0;">
        <strong>‚ö†Ô∏è ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∏‡•Ä‡§Æ‡§æ ‡§™‡§æ‡§∞ / Potential Limit Exceeded</strong><br>
        <small>
          Generation ${ratio}% of consumption ‡§π‡•à‡•§ Excess: ${excess.toLocaleString()} units<br>
          ‡§ï‡•É‡§™‡§Ø‡§æ UHBVN ‡§∏‡•á confirm ‡§ï‡§∞‡•á‡§Ç‡•§ Please check with UHBVN.
          <a href="#" onclick="show90LimitHelp(); return false;">Learn more ‚Üí</a>
        </small>
      </div>
    `;
  } else if (ratio >= 80) {
    // Approaching 90%
    html = `
      <div class="alert alert-warning" style="margin: 0;">
        <strong>‚ö†Ô∏è ‡§∏‡•Ä‡§Æ‡§æ ‡§ï‡•á ‡§™‡§æ‡§∏ / Approaching Limit</strong><br>
        <small>
          Generation ${ratio}% ‡§π‡•à‡•§ 90% ‡§ï‡•á ‡§™‡§æ‡§∏ ‡§™‡§π‡•Å‡§Ç‡§ö ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§<br>
          ‡§ï‡•Å‡§õ states ‡§Æ‡•á‡§Ç limit ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§ Some states may have limit.
          <a href="#" onclick="show90LimitHelp(); return false;">Learn more ‚Üí</a>
        </small>
      </div>
    `;
  } else {
    // Safe
    html = `
      <div class="alert alert-success" style="margin: 0;">
        <strong>‚úì ‡§∏‡•Ä‡§Æ‡§æ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ / Within Limits</strong><br>
        <small>Generation ${ratio}% ‡§π‡•à‡•§ Safe limits ‡§Æ‡•á‡§Ç ‡§π‡•à‡•§ üëç</small>
      </div>
    `;
  }
  
  warningBox.innerHTML = html;
}

// Helper: Get stored bills (adjust based on your storage method)
function getStoredBills() {
  // If using localStorage:
  const stored = localStorage.getItem('solarBills');
  if (stored) {
    try {
      return JSON.parse(stored);
    } catch (e) {
      return [];
    }
  }
  
  // If using Google Sheets, you'll need to fetch from there
  // This is just a placeholder
  return [];
}

// ==========================================
// RENDER BILL CARDS IN DASHBOARD
// ==========================================
function renderBillCards(bills) {
  const billsList = document.getElementById('billsList');
  
  if (!billsList) {
    console.error('billsList element not found!');
    return;
  }
  
  // IMPORTANT: Store bills globally
  window.userBills = bills;
  
  billsList.innerHTML = '';
  
  if (!bills || bills.length === 0) {
    billsList.innerHTML = `
      <div class="text-center text-muted py-5">
        <p style="font-size: 1.2rem;">üìã No bills saved yet</p>
      </div>
    `;
    return;
  }
  
  bills.forEach((bill, index) => {
    const cardHTML = createBillCard(bill, index);
    billsList.innerHTML += cardHTML;
  });
  
  console.log('Rendered', bills.length, 'bills'); // DEBUG
}
// ==========================================
// SAVE BILLS TO STORAGE
// ==========================================
function saveBillsToStorage(bills) {
  try {
    // Save to localStorage
    localStorage.setItem('solarBills', JSON.stringify(bills));
    
    // Also update global variable
    window.userBills = bills;
    
    console.log('Bills saved successfully:', bills.length, 'bills');
    
    // TODO: If using Google Sheets, also save there
    // saveToGoogleSheets(bills);
    
    return true;
  } catch (error) {
    console.error('Error saving bills:', error);
    alert('Error saving bills. Please try again.');
    return false;
  }
}

// ==========================================
// LOAD BILLS FROM STORAGE ON PAGE LOAD
// ==========================================
function loadBillsFromStorage() {
  try {
    const stored = localStorage.getItem('solarBills');
    if (stored) {
      const bills = JSON.parse(stored);
      window.userBills = bills;
      return bills;
    }
  } catch (error) {
    console.error('Error loading bills:', error);
  }
  return [];
}

// ==========================================
// INITIALIZE DASHBOARD
// ==========================================
function initializeDashboard() {
  // Load bills
  const bills = loadBillsFromStorage();
  window.userBills = bills;
  
  // Render bills
  renderBillCards(bills);
  
  // Update stats if function exists
  if (typeof updateDashboardStats === 'function') {
    updateDashboardStats(bills);
  }
  
  console.log('Dashboard initialized with', bills.length, 'bills');
}

// Call initialize when page loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeDashboard);
} else {
  initializeDashboard();
}

// Call on dashboard load
document.addEventListener('DOMContentLoaded', function() {
  // Wait a bit for data to load
  setTimeout(updateAnnualStats, 1000);
});
// ==========================================
// 90% LIMIT HELP MODAL
// ==========================================

function show90LimitHelp() {
  const helpHTML = `
    <div style="text-align: left;">
      <h5 style="color: #0b5ed7; margin-bottom: 1rem;">
        üìä 90% ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§∏‡•Ä‡§Æ‡§æ / 90% Annual Limit - Complete Guide
      </h5>
      
      <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; 
           margin-bottom: 1rem; border-left: 4px solid #ffc107;">
        <strong>‚ö†Ô∏è ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ / Important:</strong><br>
        ‡§Ø‡§π limit ‡§π‡§∞ state ‡§Æ‡•á‡§Ç ‡§Ö‡§≤‡§ó ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§<br>
        This limit may vary by state.<br>
        ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•á state ‡§ï‡•Ä policy check ‡§ï‡§∞‡•á‡§Ç‡•§<br>
        Please check your state's policy.
      </div>
      
      <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <strong>90% Limit ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à? / What is 90% Limit?</strong><br><br>
        ‡§ï‡•Å‡§õ states ‡§Æ‡•á‡§Ç ‡§®‡§ø‡§Ø‡§Æ ‡§π‡•à ‡§ï‡§ø ‡§Ü‡§™‡§ï‡•á solar panels ‡§ï‡•Ä ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï generation
        ‡§Ü‡§™‡§ï‡•Ä ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï consumption ‡§ï‡•á 90% ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è‡•§<br><br>
        Some states have a rule that your annual solar generation should not
        exceed 90% of your annual consumption.
      </div>
      
      <div style="background: #d1e7dd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <strong>‚úì ‡§â‡§¶‡§æ‡§π‡§∞‡§£ / Example:</strong><br><br>
        
        <strong>Case 1: Safe</strong><br>
        Annual Consumption: 10,000 units<br>
        90% Reference: 9,000 units<br>
        Your Generation: 8,500 units ‚úì<br>
        Status: Full net metering benefits<br><br>
        
        <strong>Case 2: Exceeds</strong><br>
        Annual Consumption: 10,000 units<br>
        90% Reference: 9,000 units<br>
        Your Generation: 12,000 units ‚ö†Ô∏è<br>
        Excess: 3,000 units<br><br>
        
        <strong>Excess units ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•ã‡§§‡§æ ‡§π‡•à?</strong><br>
        ‚Ä¢ ‡§ï‡§Æ ‡§¶‡§∞ ‡§™‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® (‚Çπ2-3/unit) ‡§Ø‡§æ<br>
        ‚Ä¢ DISCOM ‡§ï‡•ã forfeit ‡§Ø‡§æ<br>
        ‚Ä¢ State policy ‡§™‡§∞ depend
      </div>
      
      <div style="background: #cfe2ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <strong>üîç Haryana ‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?</strong><br><br>
        ‡§ï‡•É‡§™‡§Ø‡§æ UHBVN ‡§∏‡•á confirm ‡§ï‡§∞‡•á‡§Ç‡•§<br>
        Please confirm with UHBVN.<br><br>
        
        <strong>‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï / Contact:</strong><br>
        ‚Ä¢ HERC Website: https://herc.gov.in<br>
        ‚Ä¢ UHBVN: https://www.uhbvn.org.in<br>
        ‚Ä¢ ‡§Ø‡§æ ‡§Ö‡§™‡§®‡•á local UHBVN office
      </div>
      
      <div style="background: #f8d7da; padding: 1rem; border-radius: 8px;">
        <strong>üí° SolarSanchay ‡§Æ‡•á‡§Ç:</strong><br><br>
        ‚Ä¢ ‡§π‡§Æ ‡§Ü‡§™‡§ï‡•ã inform ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‚úì<br>
        ‚Ä¢ Annual stats ‡§¶‡§ø‡§ñ‡§æ‡§§‡•á ‡§π‡•à‡§Ç ‚úì<br>
        ‚Ä¢ Warning ‡§¶‡•á‡§§‡•á ‡§π‡•à‡§Ç ‚úì<br>
        ‚Ä¢ ‡§≤‡•á‡§ï‡§ø‡§® automatic calculation ‡§®‡§π‡•Ä‡§Ç<br>
        ‚Ä¢ ‡§Ü‡§™ ‡§ñ‡•Å‡§¶ decide ‡§ï‡§∞‡•á‡§Ç!
      </div>
    </div>
  `;
  
  showModal(
    'üìä',
    '90% Annual Limit Guide',
    helpHTML,
    [{ text: '‡§∏‡§Æ‡§ù ‡§ó‡§Ø‡§æ / Got it!', type: 'primary', action: closeModal }]
  );
}
// ==========================================
// MARCH RESET HELP MODAL
// ==========================================

function showMarchResetHelp() {
  const helpHTML = `
    <div style="text-align: left;">
      <h5 style="color: #0b5ed7; margin-bottom: 1rem;">
        üìÖ ‡§Æ‡§æ‡§∞‡•ç‡§ö 31 Carry Forward Reset - Complete Guide
      </h5>
      
      <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; 
           margin-bottom: 1rem; border-left: 4px solid #ffc107;">
        <strong>‚ö†Ô∏è ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ / Important:</strong><br>
        ‡§Ø‡§π policy ‡§π‡§∞ state ‡§Æ‡•á‡§Ç ‡§Ö‡§≤‡§ó ‡§π‡•à‡•§<br>
        This policy varies by state.<br>
        ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•á DISCOM ‡§∏‡•á confirm ‡§ï‡§∞‡•á‡§Ç‡•§<br>
        Please confirm with your DISCOM.
      </div>
      
      <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <strong>Carry Forward Reset ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à? / What is CF Reset?</strong><br><br>
        
        <strong>‡§¶‡•ã ‡§Ö‡§≤‡§ó-‡§Ö‡§≤‡§ó concepts ‡§π‡•à‡§Ç / Two different concepts:</strong><br><br>
        
        <strong>Concept 1: Monthly Carry Forward (‡§≤‡§ó‡§æ‡§§‡§æ‡§∞ ‡§ö‡§≤‡§§‡•Ä ‡§π‡•à)</strong><br>
        ‚Ä¢ ‡§π‡§∞ ‡§Æ‡§π‡•Ä‡§®‡•á: Previous Closing = Next Opening<br>
        ‚Ä¢ March ‚Üí April ‡§Æ‡•á‡§Ç ‡§≠‡•Ä ‡§ö‡§≤‡§§‡•Ä ‡§∞‡§π‡§§‡•Ä ‡§π‡•à<br>
        ‚Ä¢ ‡§Ø‡§π monthly billing cycle ‡§π‡•à<br><br>
        
        <strong>Concept 2: Annual Settlement (FY ‡§ï‡•á ‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç)</strong><br>
        ‚Ä¢ ‡§ï‡•Å‡§õ states ‡§Æ‡•á‡§Ç March 31 ‡§ï‡•ã final adjustment<br>
        ‚Ä¢ Remaining carry forward zero ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à<br>
        ‚Ä¢ ‡§Ø‡§æ payment at avoided cost rate<br>
        ‚Ä¢ ‡§Ø‡§æ carry to next FY (rare)
      </div>
      
      <div style="background: #d1e7dd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <strong>‚úì ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§∏‡§Æ‡§ù / Our Understanding:</strong><br><br>
        
        <strong>‡§Ö‡§ß‡§ø‡§ï‡§§‡§∞ states ‡§Æ‡•á‡§Ç (Most states):</strong><br>
        ‚Ä¢ Monthly carry forward ‡§ö‡§≤‡§§‡•Ä ‡§∞‡§π‡§§‡•Ä ‡§π‡•à ‚úì<br>
        ‚Ä¢ March ‚Üí April ‡§Æ‡•á‡§Ç ‡§≠‡•Ä ‡§ö‡§≤‡§§‡•Ä ‡§π‡•à ‚úì<br>
        ‚Ä¢ ‡§ï‡•ã‡§à automatic reset ‡§®‡§π‡•Ä‡§Ç<br><br>
        
        <strong>Example:</strong><br>
        March 31: Closing CF = 130 units<br>
        April 1: Opening CF = 130 units ‚úì<br>
        (Same year billing, continuous)
      </div>
      
      <div style="background: #f8d7da; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <strong>‚ö†Ô∏è ‡§≤‡•á‡§ï‡§ø‡§® ‡§ï‡•Å‡§õ states ‡§Æ‡•á‡§Ç / But some states:</strong><br><br>
        
        ‚Ä¢ March 31 ‡§ï‡•ã annual settlement ‡§π‡•ã‡§§‡§æ ‡§π‡•à<br>
        ‚Ä¢ Carry forward reset to zero<br>
        ‚Ä¢ ‡§Ø‡§æ payment at lower rate<br>
        ‚Ä¢ Policy document ‡§Æ‡•á‡§Ç clearly mentioned ‡§π‡•ã‡§§‡§æ ‡§π‡•à<br><br>
        
        <strong>‡§Ö‡§ó‡§∞ ‡§ê‡§∏‡§æ ‡§π‡•à ‡§§‡•ã / If this applies:</strong><br>
        March 31: CF = 130 units<br>
        April 1: CF = 0 ‚ùå (reset!)<br>
        Loss: 130 units credit
      </div>
      
      <div style="background: #cfe2ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <strong>üîç Haryana UHBVN ‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?</strong><br><br>
        
        <strong>‡§π‡§Æ‡•á‡§Ç exact information ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</strong><br>
        We don't have exact information.<br><br>
        
        <strong>‡§Ü‡§™‡§ï‡•ã ‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è? / What to do?</strong><br>
        1. ‚úì UHBVN office ‡§∏‡•á ‡§™‡•Ç‡§õ‡•á‡§Ç<br>
        2. ‚úì Net Metering agreement ‡§™‡§¢‡§º‡•á‡§Ç<br>
        3. ‚úì HERC regulations check ‡§ï‡§∞‡•á‡§Ç<br>
        4. ‚úì Solar installer ‡§∏‡•á confirm ‡§ï‡§∞‡•á‡§Ç<br>
        5. ‚úì Existing solar users ‡§∏‡•á ‡§™‡•Ç‡§õ‡•á‡§Ç
      </div>
      
      <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px;">
        <strong>üí° SolarSanchay ‡§Æ‡•á‡§Ç ‡§π‡§Æ‡§æ‡§∞‡§æ approach:</strong><br><br>
        
        ‚Ä¢ ‡§π‡§Æ assume ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç: Monthly CF continuous ‡§π‡•à ‚úì<br>
        ‚Ä¢ March ‚Üí April ‡§Æ‡•á‡§Ç ‡§ö‡§≤‡§§‡•Ä ‡§∞‡§π‡§§‡•Ä ‡§π‡•à<br>
        ‚Ä¢ User ‡§ï‡•ã full information ‡§¶‡•á‡§§‡•á ‡§π‡•à‡§Ç<br>
        ‚Ä¢ ‡§≤‡•á‡§ï‡§ø‡§® automatic reset ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡•á<br>
        ‚Ä¢ User ‡§ñ‡•Å‡§¶ decide ‡§ï‡§∞‡•á!<br><br>
        
        <strong>Why?</strong><br>
        ‚Ä¢ Policy ‡§π‡§∞ state ‡§Æ‡•á‡§Ç ‡§Ö‡§≤‡§ó<br>
        ‚Ä¢ Clear information ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä<br>
        ‚Ä¢ User ‡§ï‡•ã empower ‡§ï‡§∞‡§®‡§æ ‡§¨‡•á‡§π‡§§‡§∞<br>
        ‚Ä¢ Flexibility maintain ‡§∞‡§π‡•á
      </div>
      
      <hr style="margin: 1.5rem 0;">
      
      <div style="font-size: 0.9rem; color: #6c757d;">
        <strong>‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï / Important Contacts:</strong><br>
        ‚Ä¢ HERC: https://herc.gov.in<br>
        ‚Ä¢ UHBVN: https://www.uhbvn.org.in<br>
        ‚Ä¢ UHBVN Helpline: 1912<br>
        ‚Ä¢ Net Metering Cell: Check local office
      </div>
    </div>
  `;
  
  showModal(
    'üìÖ',
    'March 31 Carry Forward Reset Guide',
    helpHTML,
    [{ text: '‡§∏‡§Æ‡§ù ‡§ó‡§Ø‡§æ / Got it!', type: 'primary', action: closeModal }]
  );
}
// Toggle policy info expand/collapse
function togglePolicyInfo() {
  const collapsed = document.getElementById('policyInfoCollapsed');
  const expanded = document.getElementById('policyInfoExpanded');
  
  if (collapsed.style.display === 'none') {
    collapsed.style.display = 'flex';
    expanded.style.display = 'none';
  } else {
    collapsed.style.display = 'none';
    expanded.style.display = 'block';
  }
}
// ==========================================
// MULTI-BILL SUMMARY FEATURE
// ==========================================

let currentSelectionMode = 'single'; // 'single' or 'summary'

// Switch between Single and Summary modes
function switchMode(mode) {
  currentSelectionMode = mode;
  
  if (mode === 'single') {
    // Single mode styling
    document.getElementById('singleModeBtn').classList.add('btn-primary');
    document.getElementById('singleModeBtn').classList.remove('btn-outline-primary');
    document.getElementById('summaryModeBtn').classList.remove('btn-primary');
    document.getElementById('summaryModeBtn').classList.add('btn-outline-primary');
    
    // SHOW single buttons, HIDE summary buttons
    const singleActions = document.getElementById('singleModeActions');
    const summaryActions = document.getElementById('summaryModeActions');
    
    if (singleActions) singleActions.style.display = 'flex';
    if (summaryActions) summaryActions.style.display = 'none';
    
    // Show radios, hide checkboxes
    document.querySelectorAll('.single-selector').forEach(el => el.style.display = 'block');
    document.querySelectorAll('.summary-selector').forEach(el => {
      el.style.display = 'none';
      el.checked = false;
    });
    
    // Update info
    const modeInfo = document.getElementById('modeInfo');
    if (modeInfo) {
      modeInfo.innerHTML = '<strong>Single Selection Mode:</strong> Select one bill to View, Edit, or Delete.';
    }
    
  } else if (mode === 'summary') {
    // Summary mode styling
    document.getElementById('summaryModeBtn').classList.add('btn-primary');
    document.getElementById('summaryModeBtn').classList.remove('btn-outline-primary');
    document.getElementById('singleModeBtn').classList.remove('btn-primary');
    document.getElementById('singleModeBtn').classList.add('btn-outline-primary');
    
    // HIDE single buttons, SHOW summary buttons  ‚Üê THIS IS KEY!
    const singleActions = document.getElementById('singleModeActions');
    const summaryActions = document.getElementById('summaryModeActions');
    
    if (singleActions) singleActions.style.display = 'none';   // ‚Üê HIDE!
    if (summaryActions) summaryActions.style.display = 'flex'; // ‚Üê SHOW!
    
    // Hide radios, show checkboxes
    document.querySelectorAll('.single-selector').forEach(el => {
      el.style.display = 'none';
      el.checked = false;
    });
    document.querySelectorAll('.summary-selector').forEach(el => el.style.display = 'block');
    
    // Disable single mode buttons
    const viewBtn = document.getElementById('viewBtn');
    const editBtn = document.getElementById('editBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    
    if (viewBtn) viewBtn.disabled = true;
    if (editBtn) editBtn.disabled = true;
    if (deleteBtn) deleteBtn.disabled = true;
    
    selectedBillIndex = null;
    
    // Update info
    const modeInfo = document.getElementById('modeInfo');
    if (modeInfo) {
      modeInfo.innerHTML = '<strong>Multi-Bill Summary Mode:</strong> Select multiple bills to see aggregate statistics.';
    }
    
    updateSummarySelection();
  }
}

// Update selected count and button state
function updateSummarySelection() {
  const checked = document.querySelectorAll('.summary-selector:checked');
  const count = checked.length;
  
  document.getElementById('selectedCount').textContent = count;
  document.getElementById('showSummaryBtn').disabled = count === 0;
}

// Select all bills
function selectAllBills() {
  document.querySelectorAll('.summary-selector').forEach(cb => cb.checked = true);
  updateSummarySelection();
}

// Clear all selections
function clearAllSelections() {
  document.querySelectorAll('.summary-selector').forEach(cb => cb.checked = false);
  updateSummarySelection();
}

// Show multi-bill summary modal
function showMultiBillSummary() {
  const checkedBoxes = document.querySelectorAll('.summary-selector:checked');
  
  if (checkedBoxes.length === 0) {
    alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï bill select ‡§ï‡§∞‡•á‡§Ç‡•§\nPlease select at least one bill.');
    return;
  }
  
  // Get all bills - try multiple sources
  let allBills = window.userBills || [];
  
  // Fallback 1: Load from storage
  if (allBills.length === 0) {
    try {
      const stored = localStorage.getItem('solarBills');
      if (stored) {
        allBills = JSON.parse(stored);
        window.userBills = allBills; // Store for future use
      }
    } catch (e) {
      console.error('Error loading bills:', e);
    }
  }
  
  // Fallback 2: Try getStoredBills function
  if (allBills.length === 0 && typeof getStoredBills === 'function') {
    allBills = getStoredBills() || [];
    window.userBills = allBills;
  }
  
  // Final check
  if (allBills.length === 0) {
    alert('‡§ï‡•ã‡§à bills ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ page refresh ‡§ï‡§∞‡•á‡§Ç‡•§\nNo bills found. Please refresh the page.');
    return;
  }
  
  console.log('Total bills available:', allBills.length);
  console.log('Bills selected:', checkedBoxes.length);
  
  // Get selected bills data
  const selectedBills = [];
  checkedBoxes.forEach(cb => {
    const index = parseInt(cb.value);
    if (allBills[index]) {
      selectedBills.push(allBills[index]);
    }
  });
  
  if (selectedBills.length === 0) {
    alert('Selected bills data not found.');
    return;
  }
  
  console.log('Selected bills:', selectedBills.length);
  
  // Calculate aggregate statistics
  const summary = calculateMultiBillSummary(selectedBills);
  
  // Show summary modal
  displaySummaryModal(summary, selectedBills);
}
function calculateMultiBillSummary(bills) {
  const summary = {
    count: bills.length,
    totalDays: 0,
    totalGross: 0,
    totalImport: 0,
    totalExport: 0,
    totalBillAmount: 0,
    totalWithoutSolar: 0,
    totalSavings: 0,
    monthlyBreakdown: []
  };
  
bills.forEach(bill => {
  // === DAYS - CALCULATE FROM BILL DATES ===
  let days = 30; // Default
  
  // Try to get actual days from bill period
  const billFrom = bill['Bill From Date'];
  const billTo = bill['Bill To Date'];
  
  if (billFrom && billTo) {
    // Parse dates and calculate actual days
    const fromDate = new Date(billFrom);
    const toDate = new Date(billTo);
    const diffTime = toDate - fromDate;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays > 0) {
      days = diffDays + 1; // Add 1 to include both start and end dates
    }
  } else if (bill['Days in Bill Period']) {
    // Fallback to stored days
    days = parseInt(bill['Days in Bill Period']);
  }
  
  summary.totalDays += days;
  
  // === UNITS ===
  const gross = parseFloat(bill['Gross Units'] || 0);
  const imp = parseFloat(bill['Import Units'] || 0);
  const exp = parseFloat(bill['Export Units'] || 0);
  
  summary.totalGross += gross;
  summary.totalImport += imp;
  summary.totalExport += exp;
  
  // === MONEY ===
  const billAmount = parseFloat(bill['Total Bill Amount'] || 0);
  const savings = parseFloat(bill['Solar Saving Amount'] || 0);
  
  // ‚úÖ FIX: Calculate "Without Solar" properly
  let withoutSolar = parseFloat(bill['Without Solar Amount'] || 0);
  
  // If Without Solar is 0 or missing, calculate it
  if (withoutSolar === 0 && savings > 0) {
    // Without Solar = Bill Amount + Savings
    withoutSolar = billAmount + savings;
  }
  
  summary.totalBillAmount += billAmount;
  summary.totalWithoutSolar += withoutSolar;
  summary.totalSavings += savings;
  
  // === BREAKDOWN ===
  summary.monthlyBreakdown.push({
    billNumber: bill['Bill Number'],
    days: days,  // Store calculated days
    saving: savings,
    withoutSolar: withoutSolar,  // Store calculated without solar
    savingPercent: parseFloat(bill['Saving Percentage'] || 0)
  });
});  
  // === CALCULATED VALUES ===
  summary.netFromGrid = summary.totalImport - summary.totalExport;
  summary.totalSolarGenerated = summary.totalGross - summary.totalImport + summary.totalExport;
  summary.selfConsumption = summary.totalGross - summary.totalImport;
  
  // === AVERAGES ===
  summary.avgDaysPerBill = (summary.totalDays / bills.length).toFixed(1);
  
  // Safe division to avoid Infinity
  if (summary.totalWithoutSolar > 0) {
    summary.avgSavingPercent = (summary.totalSavings / summary.totalWithoutSolar * 100).toFixed(1);
  } else {
    summary.avgSavingPercent = '0.0';
  }
  
  // Per day
  summary.perDayWithSolar = (summary.totalBillAmount / summary.totalDays).toFixed(0);
  summary.perDayWithoutSolar = (summary.totalWithoutSolar / summary.totalDays).toFixed(0);
  summary.perDaySaving = (summary.totalSavings / summary.totalDays).toFixed(0);
  
  return summary;
}

// Display summary modal
function displaySummaryModal(summary, bills) {
  const modalHTML = `
    <div style="text-align: left; max-height: 70vh; overflow-y: auto; font-family: system-ui; line-height: 1.6;">
      
      <!-- Header -->
      <h4 style="color: #0b5ed7; margin-bottom: 1.5rem; border-bottom: 2px solid #0b5ed7; padding-bottom: 0.5rem;">
        üìä Multi-Bill Summary
      </h4>
      
      <!-- Selected Bills List -->
      <div style="background: linear-gradient(135deg, #e0f2fe, #dbeafe); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #3b82f6;">
        <div style="font-weight: 700; color: #1e3a8a; margin-bottom: 0.5rem;">
          Selected Bills: ${summary.count}
        </div>
        ${bills.map((b, idx) => `
          <div style="padding: 0.25rem 0; color: #1e40af;">
            ${idx + 1}. Bill #${b['Bill Number'] || b.billNumber} 
            <span style="color: #64748b; font-size: 0.9rem;">
              (${formatBillPeriod(b)})
            </span>
          </div>
        `).join('')}
      </div>
      
      <!-- Period Summary -->
      <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
        <h6 style="color: #92400e; font-weight: 700; margin-bottom: 0.75rem;">üìÖ PERIOD SUMMARY</h6>
        
        <div style="display: flex; justify-content: space-between; padding: 0.2rem 0;">
          <span style="color: #78350f; font-weight: 600;">Total Days:</span>
          <span style="font-weight: 700; color: #92400e;">${summary.totalDays} days</span>
        </div>
        ${bills.map((b, idx) => `
          <div style="padding-left: 1rem; font-size: 0.85rem; color: #78350f; padding: 0.2rem 0;">
            ‚Ü≥ Bill ${idx + 1}: ${summary.monthlyBreakdown[idx].days || 30} days
          </div>
        `).join('')}
        
       </div>
      
      <!-- Units Summary -->
      <div style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #6366f1;">
        <h6 style="color: #312e81; font-weight: 700; margin-bottom: 0.75rem;">‚ö° UNITS SUMMARY</h6>
        
        <!-- Gross Units -->
        <div style="display: flex; justify-content: space-between; padding: 0.2rem 0;">
          <span style="color: #4338ca; font-weight: 600;">Total Gross:</span>
          <span style="font-weight: 700; color: #312e81;">${summary.totalGross.toLocaleString()} units</span>
        </div>
        ${bills.map((b, idx) => `
          <div style="padding-left: 1rem; font-size: 0.85rem; color: #4338ca; padding: 0.2rem 0;">
            ‚Ü≥ Bill ${idx + 1}: ${parseFloat(b['Gross Units'] || 0).toLocaleString()} units
          </div>
        `).join('')}
        
        <!-- Import Units -->
        <div style="display: flex; justify-content: space-between; padding: 0.2rem 0; margin-top: 0.5rem;">
          <span style="color: #4338ca; font-weight: 600;">Total Import:</span>
          <span style="font-weight: 700; color: #312e81;">${summary.totalImport.toLocaleString()} units</span>
        </div>
        ${bills.map((b, idx) => `
          <div style="padding-left: 1rem; font-size: 0.85rem; color: #4338ca; padding: 0.2rem 0;">
            ‚Ü≥ Bill ${idx + 1}: ${parseFloat(b['Import Units'] || 0).toLocaleString()} units
          </div>
        `).join('')}
        
        <!-- Export Units -->
        <div style="display: flex; justify-content: space-between; padding: 0.2rem 0; margin-top: 0.5rem;">
          <span style="color: #4338ca; font-weight: 600;">Total Export:</span>
          <span style="font-weight: 700; color: #312e81;">${summary.totalExport.toLocaleString()} units</span>
        </div>
        ${bills.map((b, idx) => `
          <div style="padding-left: 1rem; font-size: 0.85rem; color: #4338ca; padding: 0.2rem 0;">
            ‚Ü≥ Bill ${idx + 1}: ${parseFloat(b['Export Units'] || 0).toLocaleString()} units
          </div>
        `).join('')}
        
        <div style="border-top: 1px solid #a5b4fc; margin: 0.75rem 0;"></div>
        
        <!-- Calculated Values -->
        <div style="display: flex; justify-content: space-between; padding: 0.2rem 0;">
          <span style="color: #4338ca;">Net from Grid:</span>
          <span style="font-weight: 700; color: #312e81;">${summary.netFromGrid.toLocaleString()} units</span>
        </div>
        <div style="padding-left: 1rem; font-size: 0.8rem; color: #6366f1; padding: 0.2rem 0;">
          (Import ${summary.totalImport} - Export ${summary.totalExport})
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 0.2rem 0; margin-top: 0.3rem;">
          <span style="color: #4338ca;">Solar Generated:</span>
          <span style="font-weight: 700; color: #10b981;">${summary.totalSolarGenerated.toLocaleString()} units</span>
        </div>
        <div style="padding-left: 1rem; font-size: 0.8rem; color: #6366f1; padding: 0.2rem 0;">
          (Gross ${summary.totalGross} - Import ${summary.totalImport} + Export ${summary.totalExport})
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 0.2rem 0; margin-top: 0.3rem;">
          <span style="color: #4338ca;">Self Consumed:</span>
          <span style="font-weight: 700; color: #312e81;">${summary.selfConsumption.toLocaleString()} units</span>
        </div>
        <div style="padding-left: 1rem; font-size: 0.8rem; color: #6366f1; padding: 0.2rem 0;">
          (Gross ${summary.totalGross} - Import ${summary.totalImport})
        </div>
      </div>
      
      <!-- Financial Summary -->
      <div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #10b981;">
        <h6 style="color: #14532d; font-weight: 700; margin-bottom: 0.75rem;">üí∞ FINANCIAL SUMMARY</h6>
        
        <!-- Total Bill Amount -->
        <div style="display: flex; justify-content: space-between; padding: 0.2rem 0;">
          <span style="color: #166534; font-weight: 600;">Total Current Cycle Charges:</span>
          <span style="font-weight: 700; color: #14532d;">‚Çπ${summary.totalBillAmount.toLocaleString()}</span>
        </div>
        ${bills.map((b, idx) => `
          <div style="padding-left: 1rem; font-size: 0.85rem; color: #166534; padding: 0.2rem 0;">
            ‚Ü≥ Bill ${idx + 1}: ‚Çπ${parseFloat(b['Total Bill Amount'] || 0).toLocaleString()}
          </div> 
        `).join('')}
        
        <!-- Without Solar -->
        <div style="display: flex; justify-content: space-between; padding: 0.2rem 0; margin-top: 0.5rem;">
          <span style="color: #166534; font-weight: 600;">Without Solar:</span>
          <span style="font-weight: 700; color: #14532d;">‚Çπ${summary.totalWithoutSolar.toLocaleString()}</span>
        </div>
${bills.map((b, idx) => {
  // Get without solar from breakdown (calculated in forEach)
  const withoutSolar = summary.monthlyBreakdown[idx]?.withoutSolar || 0;
  return `
  <div style="padding-left: 1rem; font-size: 0.85rem; color: #166534; padding: 0.2rem 0;">
    ‚Ü≥ Bill ${idx + 1}: ‚Çπ${withoutSolar.toLocaleString()}
  </div>
`}).join('')}        
        <div style="border-top: 2px solid #10b981; margin: 0.75rem 0;"></div>
        
        <!-- Total Savings -->
        <div style="display: flex; justify-content: space-between; padding: 0.2rem 0;">
          <span style="color: #166534; font-weight: 700; font-size: 1rem;">Total Savings:</span>
          <span style="font-weight: 700; color: #10b981; font-size: 1.2rem;">‚Çπ${summary.totalSavings.toLocaleString()}</span>
        </div>
        ${bills.map((b, idx) => `
          <div style="padding-left: 1rem; font-size: 0.85rem; color: #166534; padding: 0.2rem 0;">
            ‚Ü≥ Bill ${idx + 1}: ‚Çπ${parseFloat(b['Solar Saving Amount'] || 0).toLocaleString()}
          </div>
        `).join('')}
        
        <div style="display: flex; justify-content: space-between; padding: 0.2rem 0; margin-top: 0.3rem;">
          <span style="color: #166534;">Avg Saving %:</span>
          <span style="font-weight: 700; color: #10b981; font-size: 1rem;">${summary.avgSavingPercent}%</span>
        </div>
        
        <!-- Per Day Breakdown -->
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #86efac;">
          <div style="font-weight: 700; color: #14532d; margin-bottom: 0.5rem; font-size: 0.95rem;">
            Per Day Average:
          </div>
          <div style="display: flex; justify-content: space-between; padding: 0.3rem 0;">
            <span style="color: #166534; font-size: 0.9rem;">‚Ä¢ With Solar:</span>
            <span style="font-weight: 600; color: #14532d;">‚Çπ${summary.perDayWithSolar}/day</span>
          </div>
          <div style="padding-left: 1.5rem; font-size: 0.75rem; color: #6b7280;">
            (‚Çπ${summary.totalBillAmount.toLocaleString()} √∑ ${summary.totalDays} days)
          </div>
          
          <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; margin-top: 0.3rem;">
            <span style="color: #166534; font-size: 0.9rem;">‚Ä¢ Without Solar:</span>
            <span style="font-weight: 600; color: #14532d;">‚Çπ${summary.perDayWithoutSolar}/day</span>
          </div>
          <div style="padding-left: 1.5rem; font-size: 0.75rem; color: #6b7280;">
            (‚Çπ${summary.totalWithoutSolar.toLocaleString()} √∑ ${summary.totalDays} days)
          </div>
          
          <div style="display: flex; justify-content: space-between; padding: 0.3rem 0; margin-top: 0.3rem;">
            <span style="color: #166534; font-size: 0.9rem;">‚Ä¢ Daily Saving:</span>
            <span style="font-weight: 700; color: #10b981;">‚Çπ${summary.perDaySaving}/day</span>
          </div>
          <div style="padding-left: 1.5rem; font-size: 0.75rem; color: #6b7280;">
            (‚Çπ${summary.totalSavings.toLocaleString()} √∑ ${summary.totalDays} days)
          </div>
        </div>
      </div>   
    </div>
  `;
  
showModal(
  'üìä',
  'Multi-Bill Summary',
  modalHTML,
  [
       { 
        text: 'üñ®Ô∏è Print', 
        type: 'primary', 
        action: () => printModalWithContent()
      },
    { 
      text: 'üì± WhatsApp', 
      type: 'success', 
      action: () => shareMultiBillViaWhatsApp(summary, bills) 
    },
    { text: 'üîç Analysis', type: 'info', action: () => { closeModal(); generateSolarAnalysis(); } },
    { 
      text: '‚úï Close', 
      type: 'secondary', 
      action: closeModal 
    }
  ]
);
}
function downloadAsPDF(summary, bills) {
  // Create printable HTML
  const printHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multi-Bill Summary</title>
  <style>
    @page { size: A4; margin: 2cm; }
    body { 
      font-family: Arial, sans-serif; 
      line-height: 1.4;
      color: #333;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #0b5ed7;
      padding-bottom: 10px;
    }
    .section {
      margin-bottom: 15px;
      page-break-inside: avoid;
    }
    .section-title {
      background: #f0f0f0;
      padding: 8px;
      font-weight: bold;
      margin-bottom: 8px;
      border-left: 4px solid #0b5ed7;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    td {
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .breakdown {
      padding-left: 20px;
      font-size: 0.9em;
      color: #666;
    }
    .total {
      font-weight: bold;
      font-size: 1.1em;
    }
    .footer {
      margin-top: 30px;
      text-align: center;
      font-size: 0.8em;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä SolarSanchay - Multi-Bill Summary</h1>
    <p>Government of Haryana - Solar Savings Analysis</p>
    <p>Generated: ${new Date().toLocaleDateString('en-IN', { 
      day: '2-digit', 
      month: 'short', 
      year: 'numeric' 
    })}</p>
  </div>

  <div class="section">
    <div class="section-title">üìã Selected Bills</div>
    ${bills.map((b, idx) => `
      <div>${idx + 1}. Bill #${b['Bill Number']} (${formatBillPeriod(b)})</div>
    `).join('')}
  </div>

  <div class="section">
    <div class="section-title">üìÖ Period Summary</div>
    <table>
      <tr>
        <td>Total Days:</td>
        <td class="total">${summary.totalDays} days</td>
      </tr>
      ${bills.map((b, idx) => `
        <tr class="breakdown">
          <td>‚Ü≥ Bill ${idx + 1}:</td>
          <td>${parseInt(b['Days in Bill Period'] || 30)} days</td>
        </tr>
      `).join('')}
    </table>
  </div>

  <div class="section">
    <div class="section-title">‚ö° Units Summary</div>
    <table>
      <tr>
        <td>Total Gross:</td>
        <td class="total">${summary.totalGross.toLocaleString()} units</td>
      </tr>
      <tr>
        <td>Total Import:</td>
        <td class="total">${summary.totalImport.toLocaleString()} units</td>
      </tr>
      <tr>
        <td>Total Export:</td>
        <td class="total">${summary.totalExport.toLocaleString()} units</td>
      </tr>
      <tr>
        <td>Solar Generated:</td>
        <td class="total" style="color: #10b981;">${summary.totalSolarGenerated.toLocaleString()} units</td>
      </tr>
      <tr>
        <td>Self Consumed:</td>
        <td class="total">${summary.selfConsumption.toLocaleString()} units</td>
      </tr>
    </table>
  </div>

  <div class="section">
    <div class="section-title">üí∞ Financial Summary</div>
    <table>
      <tr>
        <td>Total Current Cycle Charges:</td>
        <td class="total">‚Çπ${summary.totalBillAmount.toLocaleString()}</td>
      </tr>
      <tr>
        <td>Without Solar:</td>
        <td class="total">‚Çπ${summary.totalWithoutSolar.toLocaleString()}</td>
      </tr>
      <tr>
        <td>Total Savings:</td>
        <td class="total" style="color: #10b981;">‚Çπ${summary.totalSavings.toLocaleString()}</td>
      </tr>
      <tr>
        <td>Avg Saving %:</td>
        <td class="total" style="color: #10b981;">${summary.avgSavingPercent}%</td>
      </tr>
      <tr>
        <td>Daily Saving:</td>
        <td class="total" style="color: #10b981;">‚Çπ${summary.perDaySaving}/day</td>
      </tr>
    </table>
  </div>

  <div class="section">
    <div class="section-title">üìà Bill-wise Breakdown</div>
    ${bills.map((b, idx) => {
      const billNum = b['Bill Number'];
      const days = parseInt(b['Days in Bill Period'] || 30);
      const saving = parseFloat(b['Solar Saving Amount'] || 0);
      const savingPct = parseFloat(b['Saving Percentage'] || 0);
      
      return `
      <div style="margin-bottom: 10px; border: 1px solid #ddd; padding: 8px;">
        <strong>${idx + 1}. Bill #${billNum}</strong> (${formatBillPeriod(b)})<br>
        Days: ${days} | Saving: ‚Çπ${saving.toLocaleString()} (${savingPct.toFixed(1)}%)
      </div>
      `;
    }).join('')}
  </div>
 
  <div class="footer">
    <p><strong>SolarSanchay</strong> - Haryana Solar Savings Calculator</p>
    <p>NIC, Kurukshetra | Government of Haryana</p>
  </div>
</body>
</html>
  `;
  
  // Create blob and download
  const blob = new Blob([printHTML], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Solar_Summary_${new Date().toISOString().split('T')[0]}.html`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  // Also trigger print dialog
  setTimeout(() => {
    const printWindow = window.open(url);
    printWindow.onload = function() {
      printWindow.print();
    };
  }, 500);
}
// Helper function to format bill period
function formatBillPeriod(bill) {
  const fromDate = bill['Bill From Date'] || bill.billFromDate;
  const toDate = bill['Bill To Date'] || bill.billToDate;
  
  if (!fromDate || !toDate) return 'N/A';
  
  try {
    const from = new Date(fromDate);
    const to = new Date(toDate);
    
    if (isNaN(from.getTime()) || isNaN(to.getTime())) return 'N/A';
    
    const fromDay = from.getDate();
    const toDay = to.getDate();
    const fromMonth = from.toLocaleDateString('en-IN', { month: 'short' });
    const year = from.getFullYear();
    
    if (from.getMonth() === to.getMonth()) {
      return `${fromDay}-${toDay} ${fromMonth} ${year}`;
    } else {
      const toMonth = to.toLocaleDateString('en-IN', { month: 'short' });
      return `${fromDay} ${fromMonth} - ${toDay} ${toMonth} ${year}`;
    }
  } catch (e) {
    return 'N/A';
  }
}
function clearBillSelection() {
  // Clear radio / checkbox selection
  const radios = document.querySelectorAll(
    '#billsList input[type="radio"], #billsList input[type="checkbox"]'
  );

  radios.forEach(radio => {
    radio.checked = false;
  });

  // Clear visual selection (blue highlighted cards)
  document
    .querySelectorAll("#billsList .bill-card.selected")
    .forEach(card => card.classList.remove("selected"));

  console.log("üîò Bill radio + card selection cleared");
}


function generateSolarAnalysis() {
  const bills = window.userBills || [];
  
  if (bills.length === 0) {
    alert('No bills to analyze!');
    return;
  }
  
  // Calculate totals from bills
  const totalGross = bills.reduce((sum, b) => sum + parseFloat(b['Gross Units'] || 0), 0);
  const totalImport = bills.reduce((sum, b) => sum + parseFloat(b['Import Units'] || 0), 0);
  const totalExport = bills.reduce((sum, b) => sum + parseFloat(b['Export Units'] || 0), 0);
  const totalBillAmount = bills.reduce((sum, b) => sum + parseFloat(b['Total Bill Amount'] || 0), 0);
  const totalFixedCharges = bills.reduce((sum, b) => sum + parseFloat(b['Fixed Charges'] || 0), 0);
  
  // Calculate total days
  let totalDays = 0;
  bills.forEach((bill) => {
    totalDays += parseInt(bill['Billing Days']) || 0;
  });
  
  if (totalDays === 0) {
    bills.forEach((bill) => {
      const fromDate = new Date(bill['Bill From Date']);
      const toDate = new Date(bill['Bill To Date']);
      if (!isNaN(fromDate) && !isNaN(toDate)) {
        totalDays += Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
      }
    });
  }
  
  if (totalDays === 0) {
    totalDays = bills.length * 60;
  }
  
  // Solar calculations
  const solarGenerated = totalGross - totalImport + totalExport;
  const selfConsumption = totalGross - totalImport;
  const netImport = totalImport - totalExport;
  
  // Percentages
  const selfConsumptionRatio = (selfConsumption / solarGenerated * 100).toFixed(1);
  const exportRatio = (totalExport / solarGenerated * 100).toFixed(1);
  
  // Daily averages
  const avgDailyGeneration = (solarGenerated / totalDays).toFixed(1);
  const avgDailyConsumption = (totalGross / totalDays).toFixed(1);
  const avgDailyImport = (totalImport / totalDays).toFixed(1);
  const avgDailyExport = (totalExport / totalDays).toFixed(1);
  const avgNetImport = (netImport / totalDays).toFixed(1);
  
  // Financial calculations from ACTUAL bills
  const dailyBill = totalBillAmount / totalDays;
  const dailyFixed = totalFixedCharges / totalDays;
  const dailyVariable = (totalBillAmount - totalFixedCharges) / totalDays;
  const monthlyFixed = totalFixedCharges / bills.length;
  
  // Calculate battery metrics first
  const batteryCapacity = Math.round(parseFloat(avgDailyExport) * 0.8);
  const batterySaving = Math.round(dailyVariable * 0.8);
  const batteryCost = batteryCapacity * 15000;
  const batteryPayback = Math.round(batteryCost / (batterySaving * 365));
  
  // Determine recommendation based on battery viability
  let recommendation = '';
  let reason = '';
  let color = '';
  let priority = '';
  
  if (exportRatio > 70) {
    // Check if battery is financially viable (payback <= 15 years)
    if (batteryPayback <= 15) {
      recommendation = 'üîã BATTERY STORAGE RECOMMENDED';
      reason = `You generate ${avgDailyGeneration} units/day but export ${avgDailyExport} units/day (${exportRatio}%). Battery storage will store this daytime surplus for nighttime use. Payback period: ${batteryPayback} years.`;
      color = '#3b82f6';
      priority = 'battery';
    } else {
      // Battery not viable - system working well
      const gridReduction = (100 - (Math.abs(parseFloat(avgNetImport)) / parseFloat(avgDailyConsumption)) * 100).toFixed(0);
      recommendation = '‚úÖ SYSTEM WORKING WELL';
      reason = `You generate ${avgDailyGeneration} units/day and export ${exportRatio}% to grid. Your net import is only ${Math.abs(avgNetImport)} units/day (${gridReduction}% grid reduction achieved). Battery would take ${batteryPayback} years to pay back, which is not financially viable. Consider adding ${Math.round(Math.abs(parseFloat(avgNetImport)) * 1.2)} units/day capacity for complete self-sufficiency.`;
      color = '#10b981';
      priority = 'small-addition';
    }
  }
  else if (exportRatio > 40 && exportRatio <= 70) {
    if (batteryPayback <= 15) {
      recommendation = 'üîã BATTERY BENEFICIAL';
      reason = `You export ${exportRatio}% of solar generation. Battery storage will help you use this energy at night. Payback: ${batteryPayback} years.`;
      color = '#3b82f6';
      priority = 'battery';
    } else {
      recommendation = '‚úÖ BALANCED SYSTEM';
      reason = `Your system shows good balance. Export ${exportRatio}%, net import ${Math.abs(avgNetImport)} units/day. Battery payback (${batteryPayback} years) not viable currently.`;
      color = '#10b981';
      priority = 'optimal';
    }
  }
  else if (exportRatio <= 40 && avgDailyImport > avgDailyGeneration * 0.6) {
    recommendation = '‚¨ÜÔ∏è ADD MORE SOLAR PANELS';
    reason = `Your solar generates ${avgDailyGeneration} units/day but you need ${avgDailyConsumption} units/day. Adding more panels will reduce grid dependency significantly.`;
    color = '#f59e0b';
    priority = 'panels';
  }
  else if (selfConsumptionRatio > 70) {
    recommendation = '‚≠ê EXCELLENT SYSTEM';
    reason = `Your system is performing excellently! You're using ${selfConsumptionRatio}% of solar directly. Well balanced with your consumption.`;
    color = '#10b981';
    priority = 'optimal';
  }
  else {
    recommendation = '‚úÖ GOOD SYSTEM';
    reason = `Your solar system is working well with reasonable balance.`;
    color = '#10b981';
    priority = 'optimal';
  }
  
  // Additional panels calculation (if needed)
  let additionalCapacity = 0;
  let panelsNeeded = 0;
  let panelsSaving = 0;
  
  if (priority === 'panels') {
    additionalCapacity = Math.round(parseFloat(avgDailyImport) * 0.7);
    panelsNeeded = Math.ceil(additionalCapacity / 4);
    panelsSaving = Math.round((additionalCapacity / totalImport) * (totalBillAmount - totalFixedCharges) / totalDays);
  } else if (priority === 'small-addition') {
    additionalCapacity = Math.round(Math.abs(parseFloat(avgNetImport)) * 1.2);
    panelsNeeded = Math.ceil(additionalCapacity / 4);
  }
  
  // Format bill periods
  const firstBillPeriod = formatBillPeriod(bills[0]);
  const lastBillPeriod = formatBillPeriod(bills[bills.length - 1]);
  
  // Generate HTML report
  const analysisHTML = `
    <div style="text-align: left; max-height: 70vh; overflow-y: auto; font-family: system-ui; line-height: 1.6;">
      
      <h4 style="color: #1e40af; margin-bottom: 1rem; border-bottom: 3px solid #1e40af; padding-bottom: 0.5rem; font-size: 1.2rem;">
        üîç Solar Performance Analysis
      </h4>
      
      <div style="background: linear-gradient(135deg, #dbeafe, #e0f2fe); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">
        <strong>Analysis Period:</strong> ${totalDays} days (${bills.length} bills)<br>
        <strong>Date Range:</strong> ${firstBillPeriod} to ${lastBillPeriod}
      </div>
      
      <div style="background: ${color}; color: white; padding: 1.25rem; border-radius: 10px; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <h5 style="margin: 0 0 0.75rem 0; font-size: 1.1rem; font-weight: 700;">${recommendation}</h5>
        <p style="margin: 0; font-size: 0.95rem; line-height: 1.6; opacity: 0.95;">${reason}</p>
      </div>
      
      <div style="background: linear-gradient(135deg, #fef3c7, #fef9e7); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
        <h6 style="color: #92400e; font-weight: 700; margin: 0 0 0.75rem 0; font-size: 1rem;">‚òÄÔ∏è Solar Performance</h6>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.9rem;">
          <div style="background: white; padding: 0.75rem; border-radius: 6px;">
            <div style="color: #666; font-size: 0.8rem;">Solar Generated</div>
            <div style="font-size: 1.3rem; font-weight: 700; color: #f59e0b;">${solarGenerated.toLocaleString()}</div>
            <div style="color: #666; font-size: 0.8rem;">${avgDailyGeneration} units/day</div>
          </div>
          
          <div style="background: white; padding: 0.75rem; border-radius: 6px;">
            <div style="color: #666; font-size: 0.8rem;">Home Consumption</div>
            <div style="font-size: 1.3rem; font-weight: 700; color: #3b82f6;">${totalGross.toLocaleString()}</div>
            <div style="color: #666; font-size: 0.8rem;">${avgDailyConsumption} units/day</div>
          </div>
          
          <div style="background: white; padding: 0.75rem; border-radius: 6px;">
            <div style="color: #666; font-size: 0.8rem;">Used Directly</div>
            <div style="font-size: 1.3rem; font-weight: 700; color: #10b981;">${selfConsumption.toLocaleString()}</div>
            <div style="color: #666; font-size: 0.8rem;">${selfConsumptionRatio}% of solar</div>
          </div>
          
          <div style="background: white; padding: 0.75rem; border-radius: 6px;">
            <div style="color: #666; font-size: 0.8rem;">Sent to Grid</div>
            <div style="font-size: 1.3rem; font-weight: 700; color: #8b5cf6;">${totalExport.toLocaleString()}</div>
            <div style="color: #666; font-size: 0.8rem;">${exportRatio}% of solar</div>
          </div>
        </div>
      </div>
      
      <div style="background: linear-gradient(135deg, #e0e7ff, #e5e7eb); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid #6366f1;">
        <h6 style="color: #312e81; font-weight: 700; margin: 0 0 0.75rem 0; font-size: 1rem;">‚ö° Grid Interaction</h6>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.9rem;">
          <div style="background: white; padding: 0.75rem; border-radius: 6px;">
            <div style="color: #666; font-size: 0.8rem;">Bought from Grid</div>
            <div style="font-size: 1.3rem; font-weight: 700; color: #ef4444;">${totalImport.toLocaleString()}</div>
            <div style="color: #666; font-size: 0.8rem;">${avgDailyImport} units/day</div>
          </div>
          
          <div style="background: ${netImport > 0 ? '#fef3c7' : '#dcfce7'}; padding: 0.75rem; border-radius: 6px;">
            <div style="color: #666; font-size: 0.8rem;">Net ${netImport > 0 ? 'Import' : 'Export'}</div>
            <div style="font-size: 1.3rem; font-weight: 700; color: ${netImport > 0 ? '#f59e0b' : '#10b981'};">${Math.abs(parseFloat(avgNetImport))}</div>
            <div style="color: #666; font-size: 0.8rem;">units/day</div>
          </div>
        </div>
      </div>
      
      <div style="background: linear-gradient(135deg, #dcfce7, #d1fae5); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid #10b981;">
        <h6 style="color: #065f46; font-weight: 700; margin: 0 0 0.75rem 0; font-size: 1rem;">üí∞ Your Electricity Bill</h6>
        
        <div style="background: white; padding: 1rem; border-radius: 8px;">
          <table style="width: 100%; font-size: 0.9rem;">
            <tr>
              <td style="padding: 0.5rem 0; color: #666;">Current Daily Bill:</td>
              <td style="text-align: right; font-weight: 700; font-size: 1.1rem;">‚Çπ${Math.round(dailyBill)}</td>
            </tr>
            <tr style="border-top: 1px solid #e5e7eb;">
              <td style="padding: 0.5rem 0; padding-left: 1rem; color: #666; font-size: 0.85rem;">
                ‚Ü≥ Fixed Charges
                <div style="font-size: 0.75rem; color: #999;">(~‚Çπ${Math.round(monthlyFixed)}/month)</div>
              </td>
              <td style="text-align: right; color: #666;">‚Çπ${Math.round(dailyFixed)}</td>
            </tr>
            <tr>
              <td style="padding: 0.5rem 0; padding-left: 1rem; color: #666; font-size: 0.85rem;">‚Ü≥ Variable Charges</td>
              <td style="text-align: right; color: #666;">‚Çπ${Math.round(dailyVariable)}</td>
            </tr>
          </table>
        </div>
      </div>
      
      ${priority === 'battery' ? `
      <div style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); padding: 1.25rem; border-radius: 10px; border: 2px solid #3b82f6;">
        <h6 style="color: #1e40af; font-weight: 700; margin: 0 0 1rem 0; font-size: 1.05rem;">üîã Battery Storage Solution</h6>
        
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-size: 0.9rem; line-height: 1.8; color: #374151;">
            <strong style="color: #1e40af;">The Problem:</strong><br>
            You generate electricity during the day but need it at night. Currently, you send ${avgDailyExport} units/day back to grid and buy ${avgDailyImport} units/day from grid.
          </div>
        </div>
        
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-size: 0.9rem; line-height: 1.8; color: #374151;">
            <strong style="color: #1e40af;">The Solution:</strong><br>
            Install a <strong>${batteryCapacity} kWh battery</strong> to store your daytime solar and use it at night.
          </div>
        </div>
        
        <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border-left: 3px solid #10b981;">
          <table style="width: 100%; font-size: 0.9rem;">
            <tr>
              <td style="padding: 0.4rem 0;">Daily Saving:</td>
              <td style="text-align: right; font-weight: 700; color: #10b981; font-size: 1.1rem;">‚Çπ${batterySaving}</td>
            </tr>
            <tr>
              <td style="padding: 0.4rem 0;">Monthly Saving:</td>
              <td style="text-align: right; font-weight: 700;">‚Çπ${Math.round(batterySaving * 30)}</td>
            </tr>
            <tr>
              <td style="padding: 0.4rem 0;">Yearly Saving:</td>
              <td style="text-align: right; font-weight: 700;">‚Çπ${Math.round(batterySaving * 365)}</td>
            </tr>
            <tr style="border-top: 2px solid #d1fae5;">
              <td style="padding: 0.4rem 0;">Battery Cost:</td>
              <td style="text-align: right;">‚Çπ${batteryCost.toLocaleString()}</td>
            </tr>
            <tr>
              <td style="padding: 0.4rem 0;"><strong>Payback Period:</strong></td>
              <td style="text-align: right; font-weight: 700; color: #1e40af; font-size: 1.1rem;">${batteryPayback} years</td>
            </tr>
          </table>
        </div>
        
        <div style="background: #fef3c7; padding: 0.75rem; border-radius: 6px; margin-top: 1rem; font-size: 0.85rem; color: #92400e;">
          <strong>‚ö†Ô∏è Note:</strong> Fixed charges (‚Çπ${Math.round(dailyFixed)}/day) will remain even after battery installation.
        </div>
      </div>
      ` : ''}
      
      ${priority === 'small-addition' ? `
      <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 1.25rem; border-radius: 10px; border: 2px solid #f59e0b;">
        <h6 style="color: #92400e; font-weight: 700; margin: 0 0 1rem 0; font-size: 1.05rem;">‚òÄÔ∏è Minor Capacity Addition (Optional)</h6>
        
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-size: 0.9rem; line-height: 1.8; color: #374151;">
            <strong style="color: #92400e;">Current Status:</strong><br>
            Your system is performing excellently! Net import is only ${Math.abs(avgNetImport)} units/day (${((Math.abs(parseFloat(avgNetImport)) / parseFloat(avgDailyConsumption)) * 100).toFixed(1)}% of consumption). You've already achieved ${(100 - (Math.abs(parseFloat(avgNetImport)) / parseFloat(avgDailyConsumption)) * 100).toFixed(0)}% grid reduction.
          </div>
        </div>
        
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-size: 0.9rem; line-height: 1.8; color: #374151;">
            <strong style="color: #92400e;">Optional Improvement:</strong><br>
            For 100% self-sufficiency, add <strong>${panelsNeeded} panel(s)</strong> (approximately ${additionalCapacity} units/day capacity).
          </div>
        </div>
        
        <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border-left: 3px solid #10b981;">
          <table style="width: 100%; font-size: 0.9rem;">
            <tr>
              <td style="padding: 0.4rem 0;">Additional Capacity:</td>
              <td style="text-align: right; font-weight: 700;">${additionalCapacity} units/day</td>
            </tr>
            <tr>
              <td style="padding: 0.4rem 0;">Estimated Panels:</td>
              <td style="text-align: right; font-weight: 700;">${panelsNeeded} panel(s)</td>
            </tr>
            <tr>
              <td style="padding: 0.4rem 0;">Estimated Cost:</td>
              <td style="text-align: right; font-weight: 700;">‚Çπ${Math.round(panelsNeeded * 25000).toLocaleString()}</td>
            </tr>
            <tr>
              <td style="padding: 0.4rem 0;">Current Variable Cost:</td>
              <td style="text-align: right; font-weight: 700;">‚Çπ${Math.round(dailyVariable)}/day</td>
            </tr>
            <tr>
              <td style="padding: 0.4rem 0;">After Addition:</td>
              <td style="text-align: right; font-weight: 700; color: #10b981;">~‚Çπ${Math.round(dailyFixed)}/day</td>
            </tr>
            <tr style="border-top: 2px solid #d1fae5;">
              <td style="padding: 0.4rem 0;"><strong>Payback Period:</strong></td>
              <td style="text-align: right; font-weight: 700; color: #10b981; font-size: 1.1rem;">${Math.round((panelsNeeded * 25000) / (dailyVariable * 365))} years</td>
            </tr>
          </table>
        </div>
        
        <div style="background: #dbeafe; padding: 0.75rem; border-radius: 6px; margin-top: 1rem; font-size: 0.85rem; color: #1e3a8a;">
          <strong>üí° Recommendation:</strong> This is optional. Your current system is already ${(100 - (Math.abs(parseFloat(avgNetImport)) / parseFloat(avgDailyConsumption)) * 100).toFixed(0)}% efficient. Add capacity only if you want complete energy independence.
        </div>
      </div>
      ` : ''}
      
      ${priority === 'panels' ? `
      <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 1.25rem; border-radius: 10px; border: 2px solid #f59e0b;">
        <h6 style="color: #92400e; font-weight: 700; margin: 0 0 1rem 0; font-size: 1.05rem;">‚òÄÔ∏è Expand Solar Capacity</h6>
        
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-size: 0.9rem; line-height: 1.8; color: #374151;">
            <strong style="color: #92400e;">The Gap:</strong><br>
            Your solar generates ${avgDailyGeneration} units/day but you need ${avgDailyConsumption} units/day. You're importing ${avgDailyImport} units/day from grid.
          </div>
        </div>
        
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-size: 0.9rem; line-height: 1.8; color: #374151;">
            <strong style="color: #92400e;">The Solution:</strong><br>
            Add approximately <strong>${panelsNeeded} solar panels</strong> to generate an additional ${additionalCapacity} units/day.
          </div>
        </div>
        
        <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border-left: 3px solid #10b981;">
          <table style="width: 100%; font-size: 0.9rem;">
            <tr>
              <td style="padding: 0.4rem 0;">Additional Capacity:</td>
              <td style="text-align: right; font-weight: 700;">${additionalCapacity} units/day</td>
            </tr>
            <tr>
              <td style="padding: 0.4rem 0;">Estimated Panels:</td>
              <td style="text-align: right; font-weight: 700;">${panelsNeeded} panels</td>
            </tr>
            <tr>
              <td style="padding: 0.4rem 0;">Daily Saving:</td>
              <td style="text-align: right; font-weight: 700; color: #10b981; font-size: 1.1rem;">‚Çπ${panelsSaving}</td>
            </tr>
            <tr>
              <td style="padding: 0.4rem 0;">Yearly Saving:</td>
              <td style="text-align: right; font-weight: 700;">‚Çπ${Math.round(panelsSaving * 365)}</td>
            </tr>
          </table>
        </div>
        
        <div style="background: #dbeafe; padding: 0.75rem; border-radius: 6px; margin-top: 1rem; font-size: 0.85rem; color: #1e3a8a;">
          <strong>üí° Tip:</strong> Consult with your solar installer for exact requirements and current market prices.
        </div>
      </div>
      ` : ''}
      
      ${priority === 'optimal' ? `
      <div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); padding: 1.25rem; border-radius: 10px; text-align: center; border: 2px solid #10b981;">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ú®</div>
        <h6 style="color: #065f46; margin: 0 0 0.5rem 0; font-size: 1.1rem;">System Performing Excellently!</h6>
        <p style="margin: 0; color: #166534; font-size: 0.95rem;">Your solar setup is well-balanced. Continue monitoring for seasonal variations.</p>
      </div>
      ` : ''}
      
    </div>
  `;
currentAnalysisData = {
    totalDays: totalDays,
    savedBills: bills,
    avgDailyConsumption: avgDailyConsumption,
    avgDailySolar: avgDailyGeneration,
    avgDailyImport: avgDailyImport,
    avgDailyExport: avgDailyExport,
    avgNetImport: avgNetImport,
    totalBillAmount: totalBillAmount,
    totalFixedCharges: totalFixedCharges
  };
  showModal(
    'üîç',
    'Solar Performance Analysis',
    analysisHTML,
   [
      { 
        text: 'üñ®Ô∏è Print', 
        type: 'primary', 
        action: () => printModalWithContent() 
      },
      { 
           text: 'üì± WhatsApp', 
           type: 'success', 
           action: () => shareAnalysisViaWhatsApp()      
      },
      { 
        text: '‚úï Close', 
        type: 'secondary', 
        action: closeModal 
      }
    ]
  );
}

function shareAnalysisReport(recommendation, saving, capacity, payback, priority) {
  let message = `üîç Solar Performance Analysis\n\n${recommendation}\n\n`;
  
  if (priority === 'battery') {
    message += `üí∞ Saving: ‚Çπ${saving}/day\nüîã Battery: ${capacity} kWh\n‚è±Ô∏è Payback: ${payback} years`;
  } else if (priority === 'small-addition') {
    message += `System already ${(100 - (Math.abs(parseFloat(avgNetImport)) / parseFloat(avgDailyConsumption)) * 100).toFixed(0)}% efficient!`;
  }
  
  message += `\n\nGenerated by SolarSanchay\nGovernment of Haryana`;
  
  if (navigator.share) {
    navigator.share({ title: 'Solar Analysis', text: message });
  } else {
    alert('Share feature not available.');
  }
}
function shareMultiBillViaWhatsApp(summary, bills) {
  // Build comprehensive WhatsApp message
  let message = '*üìä Multi-Bill Summary*\n\n';
  message += '*üåû SolarSanchay Report*\n';
  message += 'Government of Haryana\n\n';
  
  // Period Summary
  message += 'üìÖ *Period Summary*\n';
  message += 'Total Days: ' + summary.totalDays + ' days\n';
  message += 'Bills Analyzed: ' + summary.count + ' bills\n';
  
  // Get first and last bill dates
  if (bills.length > 0) {
    const firstBill = bills[bills.length - 1];
    const lastBill = bills[0];
    const fromDate = firstBill['Bill From Date'];
    const toDate = lastBill['Bill To Date'];
    
    if (fromDate && toDate) {
      message += 'From: ' + new Date(fromDate).toLocaleDateString('en-GB') + '\n';
      message += 'To: ' + new Date(toDate).toLocaleDateString('en-GB') + '\n';
    }
  }
  message += '\n';
  
  // Units Summary
  message += '‚ö° *Units Summary*\n';
  message += 'Total Gross: ' + summary.totalGross.toLocaleString() + ' units\n';
  message += 'Total Import: ' + summary.totalImport.toLocaleString() + ' units\n';
  message += 'Total Export: ' + summary.totalExport.toLocaleString() + ' units\n';
  message += 'Solar Generated: ' + summary.totalSolarGenerated.toLocaleString() + ' units\n';
  message += 'Self Consumed: ' + summary.selfConsumption.toLocaleString() + ' units\n';
  message += '\n';
  
  // Financial Summary
  message += 'üí∞ *Financial Summary*\n';
  message += 'Total Bill: ‚Çπ' + summary.totalBillAmount.toLocaleString() + '\n';
  message += 'Without Solar: ‚Çπ' + summary.totalWithoutSolar.toLocaleString() + '\n';
  message += 'Total Savings: ‚Çπ' + summary.totalSavings.toLocaleString() + '\n';
  message += 'Avg Saving: ' + summary.avgSavingPercent + '%\n';
  message += 'Daily Saving: ‚Çπ' + summary.perDaySaving + '/day\n';
  message += '\n';
  
  // Bill-wise Breakdown (first 3 bills)
  message += 'üìã *Bill Breakdown*\n';
  const maxBills = Math.min(3, bills.length);
  for (let i = 0; i < maxBills; i++) {
    const bill = bills[i];
    const billNumber = bill['Bill Number'] || 'N/A';
    const fromDate = bill['Bill From Date'];
    const toDate = bill['Bill To Date'];
    const billAmount = parseFloat(bill['Total Bill Amount'] || bill['Bill Amount'] || 0);
    const withoutSolar = parseFloat(bill['Bill Without Solar'] || 0);
    const saving = withoutSolar - billAmount;
    
    message += (i + 1) + '. Bill #' + billNumber + '\n';
    
    if (fromDate && toDate) {
      const from = new Date(fromDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
      const to = new Date(toDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
      message += '   Period: ' + from + ' - ' + to + '\n';
    }
    
    message += '   Saving: ‚Çπ' + Math.round(saving).toLocaleString() + '\n';
  }
  
  if (bills.length > 3) {
    message += '   ... and ' + (bills.length - 3) + ' more bills\n';
  }
  message += '\n';
  
  // Footer
  message += '_Generated by SolarSanchay_\n';
  message += '_NIC, Kurukshetra_\n';
  message += '_Government of Haryana_\n\n';
  message += 'üîó vksinglakkr.github.io/SolarSaving';
  
  console.log('=== Multi-Bill WhatsApp Message ===');
  console.log(message);
  
  // Encode and open WhatsApp
  const encodedMessage = encodeURIComponent(message);
  const whatsappURL = 'https://wa.me/?text=' + encodedMessage;
  
  window.open(whatsappURL, '_blank');
}
function printModalWithContent() {
  // Get the content RIGHT NOW while modal is visible
  const modalElement = document.getElementById('customModal');
  
  if (!modalElement) {
    alert('Modal not found');
    return;
  }
  
  const titleElement = modalElement.querySelector('.modal-title');
  const contentElement = modalElement.querySelector('div[style*="max-height"]') || 
                         modalElement.querySelector('.modal-body') ||
                         modalElement.querySelector('div > div > div:nth-child(2)');
  
  if (!contentElement) {
    alert('Content not found. Modal structure: ' + modalElement.innerHTML.substring(0, 200));
    return;
  }
  
  const title = titleElement ? titleElement.textContent : 'Solar Analysis Report';
  const content = contentElement.innerHTML;
  
  console.log('Got title:', title);
  console.log('Got content length:', content.length);
  
  // Now print with this content
  printContent(title, content);
}

function printContent(title, content) {
  const timestamp = new Date().toLocaleString('en-IN');
  const printWindow = window.open('', '_blank');
  
  printWindow.document.write('<!DOCTYPE html>');
  printWindow.document.write('<html><head>');
  printWindow.document.write('<meta charset="UTF-8">');
  printWindow.document.write('<title>' + title + '</title>');
  printWindow.document.write('<style>');
  printWindow.document.write('@page { size: A4; margin: 2cm; }');
  printWindow.document.write('body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }');
  printWindow.document.write('.print-header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #1e40af; padding-bottom: 15px; }');
  printWindow.document.write('.print-header h1 { color: #1e40af; margin: 0 0 10px 0; font-size: 24px; }');
  printWindow.document.write('.print-header p { color: #666; margin: 5px 0; font-size: 14px; }');
  printWindow.document.write('h4, h5, h6 { color: #1e40af; margin-top: 20px; margin-bottom: 10px; }');
  printWindow.document.write('@media print { body { margin: 0; padding: 20px; } }');
  printWindow.document.write('</style></head><body>');
  printWindow.document.write('<div class="print-header">');
  printWindow.document.write('<h1>' + title + '</h1>');
  printWindow.document.write('<p><strong>SolarSanchay</strong> - Government of Haryana</p>');
  printWindow.document.write('<p>Generated: ' + timestamp + '</p>');
  printWindow.document.write('</div>');
  printWindow.document.write(content);
  printWindow.document.write('<div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #666; font-size: 12px;">');
  printWindow.document.write('<p><strong>SolarSanchay</strong> - Solar Savings Calculator</p>');
  printWindow.document.write('<p>NIC, Kurukshetra | Government of Haryana</p>');
  printWindow.document.write('</div>');
  printWindow.document.write('</body></html>');
  
  printWindow.document.close();
  
  setTimeout(function() {
    printWindow.print();
    printWindow.onafterprint = function() {
      printWindow.close();
    };
  }, 250);
}
function shareAnalysisViaWhatsApp() {
  // Check if analysis data is available
  if (!currentAnalysisData) {
    alert('No analysis data available');
    return;
  }
  
  // Get the modal content
  const modalElement = document.getElementById('customModal');
  
  if (!modalElement) {
    alert('Modal not found');
    return;
  }
  
  const titleElement = modalElement.querySelector('.modal-title');
  const title = titleElement ? titleElement.textContent.trim() : 'Solar Performance Analysis';
  
  // Extract data from global variable
  const data = currentAnalysisData;
  
  // Build comprehensive WhatsApp message
  let message = '*' + title + '*\n\n';
  message += '*üåû SolarSanchay Report*\n';
  message += 'Government of Haryana\n\n';
  
  // Analysis Period
  message += 'üìÖ *Analysis Period*\n';
  message += 'Period: ' + data.totalDays + ' days (' + data.savedBills.length + ' bills)\n';
  if (data.savedBills.length > 0) {
    message += 'From: ' + data.savedBills[data.savedBills.length - 1].billFrom + '\n';
    message += 'To: ' + data.savedBills[0].billTo + '\n';
  }
  message += '\n';
  
  // Energy Summary
  message += '‚ö° *Energy Summary*\n';
  message += 'Daily Consumption: ' + data.avgDailyConsumption + ' units\n';
  message += 'Daily Solar: ' + data.avgDailySolar + ' units\n';
  message += 'Daily Import: ' + data.avgDailyImport + ' units\n';
  message += 'Daily Export: ' + data.avgDailyExport + ' units\n';
  message += 'Net Grid: ' + data.avgNetImport + ' units/day\n';
  message += '\n';
  
  // Financial Summary
  message += 'üí∞ *Bill Summary*\n';
  message += 'Daily Bill: ‚Çπ' + Math.round(data.totalBillAmount / data.totalDays) + '\n';
  message += 'Daily Fixed: ‚Çπ' + Math.round(data.totalFixedCharges / data.totalDays) + '\n';
  message += 'Daily Variable: ‚Çπ' + Math.round((data.totalBillAmount - data.totalFixedCharges) / data.totalDays) + '\n';
  message += '\n';
  
  // Recommendation (extract from modal)
  const contentElement = modalElement.querySelector('div[style*="max-height"]');
  if (contentElement) {
    const fullText = contentElement.innerText;
    
    if (fullText.includes('BATTERY BENEFICIAL') || fullText.includes('BATTERY STORAGE RECOMMENDED')) {
      message += 'üîã *Recommendation: BATTERY STORAGE*\n';
      
      const capacityMatch = fullText.match(/(\d+)\s*kWh/i);
      const savingMatch = fullText.match(/‚Çπ(\d+)\/day/i);
      const paybackMatch = fullText.match(/(\d+)\s*years?/i);
      
      if (capacityMatch) message += 'Capacity: ' + capacityMatch[1] + ' kWh\n';
      if (savingMatch) message += 'Savings: ‚Çπ' + savingMatch[1] + '/day\n';
      if (paybackMatch) message += 'Payback: ' + paybackMatch[1] + ' years\n';
      
    } else if (fullText.includes('SYSTEM WORKING WELL') || (fullText.includes('already') && fullText.includes('efficient'))) {
      message += '‚úÖ *System Working Well*\n';
      
      const efficiencyMatch = fullText.match(/(\d+)%\s*(?:efficient|grid reduction)/i);
      if (efficiencyMatch) {
        message += 'Grid Reduction: ' + efficiencyMatch[1] + '%\n';
      }
      message += 'Battery not needed\n';
      
    } else if (fullText.includes('INCREASE') || fullText.includes('ADD') || fullText.includes('Additional')) {
      message += '‚òÄÔ∏è *Increase Solar Capacity*\n';
      
      const unitsMatch = fullText.match(/(\d+\.?\d*)\s*units/i);
      if (unitsMatch) {
        message += 'Add: ' + unitsMatch[1] + ' units/day\n';
      }
    } else {
      message += 'üí° *Recommendation*\n';
      message += 'Check portal for details\n';
    }
  }
  
  message += '\n';
  
  // Footer
  message += '_Generated by SolarSanchay_\n';
  message += '_NIC, Kurukshetra_\n';
  message += '_Government of Haryana_\n\n';
  message += 'üîó vksinglakkr.github.io/SolarSaving';
  
  console.log('=== WhatsApp Message ===');
  console.log(message);
  
  // Encode and open WhatsApp
  const encodedMessage = encodeURIComponent(message);
  const whatsappURL = 'https://wa.me/?text=' + encodedMessage;
  
  window.open(whatsappURL, '_blank');
}

function goBack() {
  window.history.back();
}

function goHome() {
  // Go to dashboard or login
  showView('dashboardView');
}

function setPageTitle(title) {
  document.getElementById('pageTitle').textContent = title;
}
function showIntentSection() {
  // Hide all sections
  document.getElementById('intentSection').style.display = 'block';
  document.getElementById('consumptionSection').classList.add('d-none');
  document.getElementById('dashboardSection').classList.add('d-none');
  document.getElementById('authSection').classList.add('d-none');
  
  // Update navigation
  updateNavigation('intentSection');
  
  // Scroll to top
  window.scrollTo(0, 0);
}




// Prevent browser back from leaving app
window.addEventListener('load', function() {
  // Add dummy entry
  history.pushState(null, '', window.location.href);
  
  // When user presses browser back
  window.addEventListener('popstate', function() {
    // Stay in app
    history.pushState(null, '', window.location.href);
    // Use app's back logic
    handleBack();
  });
});
// ==========================================
// SIMPLE HOME BUTTON
// ==========================================

function goToHome() {
  console.log('üè† Going to home...');
  
  // Hide ALL sections
  const sectionsToHide = [
    'consumptionSection',
    'dashboardSection',
    'authSection',
    'identitySection',      // ‚úÖ ADD - Consumer Identification
    'billPeriodSection',    // ‚úÖ ADD - Bill Period
    'carryForwardSection',  // ‚úÖ ADD - Carry Forward
    'intentSummary', // ‚úÖ ADD - Summary bar
    'actionBtn',
     'downloadMessage',
     'policyInfoSection',
'openScannerBtn',
   'billHelpers'
  ];
  
  sectionsToHide.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.classList.add('d-none');
      element.style.display = 'none';
    }
  });
  
  // Show intent section
  const intentSection = document.getElementById('intentSection');
  if (intentSection) {
    intentSection.classList.remove('d-none');
    intentSection.style.display = 'block';
  }
const quotes = document.getElementById('quotesSection');
if (quotes) {
  quotes.classList.remove('d-none');
  quotes.style.display = 'block';
}
const userGuide = document.getElementById('userGuideBanner');  // ADD THIS
if (userGuide) {                                               // ADD THIS
  userGuide.classList.remove('d-none');                        // ADD THIS
  userGuide.style.display = 'block';                           // ADD THIS
}    
  
  // Hide home button
  document.getElementById('simpleHomeBtn').style.display = 'none';
  
  window.scrollTo(0, 0);
}

// Show home button when not on home page
function showHomeButton() {
  const homeBtn = document.getElementById('simpleHomeBtn');
  if (homeBtn) {
    homeBtn.style.display = 'block';
  }
}
function exitBillEntryMode() {
  [
    "identitySection",
    "billPeriodSection",
    "consumptionSection",
    "carryForwardSection",
    "result"
  ].forEach(id => {
    document.getElementById(id)?.classList.add("d-none");
  });

  document.getElementById("actionBtn")?.classList.add("d-none");
  document.getElementById("cancelEditBtn").style.display = "none";
}
function resetDashboardActions() {
  document.getElementById("viewBtn").disabled = true;
  document.getElementById("editBtn").disabled = true;
  document.getElementById("deleteBtn").disabled = true;
}
function clearBillForm() {
  [
    "billNumber","meter","accountNum",
    "billFrom","billTo",
    "gross","importU","exportU",
    "openingCarry","fixed","totalBill","arrears"
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });
}

// Hide home button on home page
function hideHomeButton() {
  const homeBtn = document.getElementById('simpleHomeBtn');
  if (homeBtn) {
    homeBtn.style.display = 'none';
  }
}
function handleHome() {
  // Hide all sections
  const consumptionSection = document.getElementById('consumptionSection');
  const dashboardSection = document.getElementById('dashboardSection');
  const authSection = document.getElementById('authSection');
  const intentSection = document.getElementById('intentSection');
  
  if (consumptionSection) consumptionSection.classList.add('d-none');
  if (dashboardSection) dashboardSection.classList.add('d-none');
  if (authSection) authSection.classList.add('d-none');
  
  // Show intent selection (home)
  if (intentSection) {
    intentSection.style.display = 'block';
  }
  
  // Hide the navbar
  const navbar = document.getElementById('mainNavbar');
  if (navbar) {
    navbar.style.display = 'none';
  }
  
  // Scroll to top
  window.scrollTo(0, 0);
  
  console.log('Returned to home (Intent Selection)');
}

// ==========================================
// BILL SCANNER INTEGRATION
// ==========================================
// ==========================================
// BILL SCANNER COMMUNICATION
// ==========================================

window.addEventListener('message', function(event) {
  if (event.data.type === 'SCAN_COMPLETE') {
    const data = event.data.payload;
    
    console.log('=== SCAN DATA ===');
    
    function convertDate(d) {
      if (!d) return '';
      const p = d.split('/');
      return `${p[2]}-${p[1]}-${p[0]}`;
    }
    
    function set(id, val) {
      const el = document.getElementById(id);
      if (el && val != null) {
        el.value = val;
        console.log(`‚úì ${id}: ${val}`);
      }
    }
    
    const isSave = document.getElementById('billNumber') !== null;
    console.log(`Form: ${isSave ? 'Save' : 'Quick'}`);
    
    if (isSave) {
      set('billNumber', data.billNumber);
      set('accountNum', data.accountNumber);
      set('meter', data.meterNumber);
      set('billFrom', convertDate(data.billFrom));
      set('billTo', convertDate(data.billTo));
      set('gross', data.grossUnits);
      set('importU', data.importUnits);
      set('exportU', data.exportUnits);
      set('fixed', data.fixedCharges);
      set('totalBill', data.totalBill);
      set('arrears', data.arrears);
      
      const oc = (data.solarGenerated || 0) + (data.importUnits || 0) - 
                 (data.exportUnits || 0) - (data.grossUnits || 0);
      set('openingCarry', oc);
    }
    
    console.log('‚úÖ Done!');
    
     // Close modal and RESET scanner
    closeBillScanner();
    
    // ============================================
    // FIX SCROLL: Re-enable body scroll
    // ============================================
    document.body.style.overflow = 'auto';
    document.body.style.position = 'static';
    document.documentElement.style.overflow = 'auto';
    
    // Remove any modal backdrop
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
      backdrop.remove();
    }
    
    // Force scroll to top of form
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
    
    console.log('‚úÖ Scroll restored!');
  }
  
  if (event.data.type === 'SCAN_CANCELLED') {
    const modal = document.getElementById('scannerModal');
    if (modal) {
      modal.style.display = 'none';
    }
    
    // Also restore scroll on cancel
    document.body.style.overflow = 'auto';
    document.body.style.position = 'static';
    document.documentElement.style.overflow = 'auto';
  }
});
// Show scanner button when form mode selected
function showScannerButton() {
  const btn = document.getElementById('openScannerBtn');
  if (btn && (entryMode === 'one' || entryMode === 'save')) {
    btn.classList.remove('d-none');
    } else {
    btn.classList.add('d-none');
  }
}

// Open scanner modal
function openBillScanner() {
  const modal = document.getElementById('scannerModal');
  if (modal) {
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent background scroll
  }
}

// Close scanner modal
function closeBillScanner() {
  const modal = document.getElementById('scannerModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // RESET SCANNER: Reload iframe to clear previous scan
    const iframe = document.getElementById('scannerFrame');
    if (iframe) {
      // Save the current src
      const src = iframe.src;
      // Reset by reloading
      iframe.src = 'about:blank';
      setTimeout(() => {
        iframe.src = src;
      }, 100);
      
      console.log('‚úì Scanner reset - ready for next scan');
    }
  }
}
    // ========================================
    // ADD VERIFICATION GUIDE FUNCTIONS HERE
    // ========================================
    
    function showVerificationGuide() {
      const modal = document.getElementById('verificationModal');
      if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      }
    }
    
    function closeVerificationGuide() {
      const modal = document.getElementById('verificationModal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }
    
    // Close on outside click
    window.onclick = function(event) {
      const modal = document.getElementById('verificationModal');
      if (event.target === modal) {
        closeVerificationGuide();
      }
    }
    
    // Close on ESC key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeVerificationGuide();
      }
    });
    
    // Your existing message listener...
    window.addEventListener('message', function(event) {
      if (event.data.type === 'SCAN_COMPLETE') {
        const data = event.data.payload;
        
        // Set all fields...
        // ... your existing code ...
        
        // ‚úÖ OPTIONAL: Auto-show guide after first scan
        if (!sessionStorage.getItem('guideShown')) {
          setTimeout(() => {
            showVerificationGuide();
            sessionStorage.setItem('guideShown', 'true');
          }, 800);
        }
      }
    });
function openVerificationGuide() {
  window.open('assests/SolarSanchayDemo.jpg', '_blank');
}
</script>
 </div>
</body>
</html>
