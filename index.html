<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SolarSanchay ‚Äì Haryana</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f4f6fb; }

/* Header */
.header {
  background:#fff;
  border-bottom:3px solid #0b5ed7;
  padding:12px;
}
.header-title { font-weight:700; }

/* Intent cards */
.intent-card {
  border:2px solid #ddd;
  border-radius:12px;
  padding:16px;
  cursor:pointer;
  transition:0.2s;
  background:#fff;
}
.intent-card:hover { border-color:#0b5ed7; }
.intent-card.active {
  border-color:#0b5ed7;
  background:#eef4ff;
}
.intent-card h6 { font-weight:700; }

/* Forms */
label { font-weight:600; }
input::placeholder { color:#aaa; }

/* Result */
.result-box {
  background:#fff;
  border-radius:12px;
  padding:16px;
  margin-bottom:14px;
  box-shadow:0 2px 8px rgba(0,0,0,0.06);
}

/* Validation */
.is-invalid { border-color:#dc3545; }
.invalid-feedback { display:block; }

/* Mobile */
@media (max-width:768px){
  .govt-text { display:none; }
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="container d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <img src="assests/haryana-logo.jpg" style="height:55px;margin-right:12px">
      <div>
        <div class="header-title">SolarSanchay ‚Äì Haryana</div>
        <small class="text-muted">Solar Savings Estimation Tool</small>
      </div>
    </div>
    <div class="govt-text text-muted">NIC, Kurukshetra</div>
  </div>
</div>

<div class="container my-3">

<!-- INTENT SELECTION -->
<div id="intentSection">
  <h6 class="mb-2">What do you want to do?</h6>

  <div class="intent-card mb-2" id="intentOne"
       onclick="selectIntent('one')">
    <h6>‚ö° One-time Saving Check</h6>
    <small class="text-muted">Quick calculation, no data saved</small>
  </div>

  <div class="intent-card" id="intentSave"
       onclick="selectIntent('save')">
    <h6>üíæ Save for Future Reference</h6>
    <small class="text-muted">Maintain bill history & analysis</small>
  </div>
</div>

<!-- INTENT SUMMARY -->
<div id="intentSummary" class="alert alert-info d-none">
  <span id="intentText"></span>
  <button class="btn btn-sm btn-link" onclick="resetIntent()">Change</button>
</div>

<!-- IDENTITY -->
<div class="card p-3 mb-3 d-none" id="identitySection">
  <h6>Consumer Identification</h6>
  <label>Bill Number (e.g. 123456)</label>
  <input id="billNumber" class="form-control mb-2" placeholder="Enter bill number">
  <label>Meter / Account Number (e.g. 24600455)</label>
  <input id="meter" class="form-control" placeholder="Enter meter or account no">
</div>

<!-- BILL PERIOD -->
<div class="card p-3 mb-3 d-none" id="billPeriodSection">
  <h6>Bill Period</h6>
  <label>From</label>
  <input type="date" id="billFrom" class="form-control mb-2">
  <label>To</label>
  <input type="date" id="billTo" class="form-control">
</div>

<!-- CONSUMPTION -->
<div class="card p-3 mb-3 d-none" id="consumptionSection">
  <h6>Consumption & Charges</h6>
<!-- BILL PERIOD -->
<div class="card p-3 mb-3" id="billPeriodSection">
  <h6>Bill Period</h6>
  <label>From</label>
  <input type="date" id="billFrom" class="form-control mb-2">
  <label>To</label>
  <input type="date" id="billTo" class="form-control">
</div>
  <label>Gross Units (e.g. 1354)</label>
 <div class="input-group mb-2">
  <input id="gross"
    type="text"
    inputmode="numeric"
    class="form-control"
    placeholder="Enter value"
    oninput="this.value=this.value.replace(/[^0-9+ ]/g,'')">

  <button class="btn btn-outline-secondary"
          type="button"
          onclick="appendPlus('gross')">
    +
  </button>
</div>


  <label>Import Units (e.g. 1114)</label>
 <div class="input-group mb-2">
  <input id="importU"
    type="text"
    inputmode="numeric"
    class="form-control"
    placeholder="Enter value"
    oninput="this.value=this.value.replace(/[^0-9+ ]/g,'')" onblur="validateUnits()">

  <button class="btn btn-outline-secondary"
          type="button"
          onclick="appendPlus('importU')">
    +
  </button>
</div>

  <label>Export Units (e.g. 944)</label>
 <div class="input-group mb-2">
  <input id="exportU"
    type="text"
    inputmode="numeric"
    class="form-control"
    placeholder="Enter value"
    oninput="this.value=this.value.replace(/[^0-9+ ]/g,'')" onblur="validateUnits()">

  <button class="btn btn-outline-secondary"
          type="button"
          onclick="appendPlus('exportU')">
    +
  </button>
</div>

  
  <label>Fixed Charges ‚Çπ (e.g. 1605)</label>
 <div class="input-group mb-2">
  <input id="fixed"
    type="text"
    inputmode="numeric"
    class="form-control"
    placeholder="Enter amount"
    oninput="this.value=this.value.replace(/[^0-9+ ]/g,'')">

  <button class="btn btn-outline-secondary"
          type="button"
          onclick="appendPlus('fixed')">
    +
  </button>
</div>


  <label>Total Bill Amount ‚Çπ (e.g. 2700)</label>
 <div class="input-group mb-2">
  <input id="totalBill"
    type="text"
    inputmode="numeric"
    class="form-control"
    placeholder="Enter amount"
    oninput="this.value=this.value.replace(/[^0-9+ ]/g,'')">

  <button class="btn btn-outline-secondary"
          type="button"
          onclick="appendPlus('totalBill')">
    +
  </button>
</div>


 
    <label>Arrears ‚Çπ (if any)</label>
 <div class="input-group mb-2">
  <input id="arrears"
    type="text"
    inputmode="numeric"
    class="form-control"
    placeholder="Enter amount"
    oninput="this.value=this.value.replace(/[^0-9+ ]/g,'')">

  <button class="btn btn-outline-secondary"
          type="button"
          onclick="appendPlus('arrears')">
    +
  </button>
</div>

</div>
<button class="btn btn-primary w-100" onclick="calculate()">Calculate</button>

<div id="result" class="mt-4"></div>

</div>

<footer class="text-center text-muted py-3">
  Last Updated: <span id="lastModified"></span>
</footer>

<script>
const identitySection = document.getElementById("identitySection");
const billPeriodSection = document.getElementById("billPeriodSection");
const arrearsRow = document.getElementById("arrearsRow");
const result = document.getElementById("result");

let mode = "one";

  function appendPlus(id){
  const el = document.getElementById(id);
  if (!el.value.trim().endsWith("+")) {
    el.value = el.value.trim() + " + ";
    el.focus();
  }
}


  
/* Intent */
function selectIntent(type){
  const one = document.getElementById("intentOne");
  const save = document.getElementById("intentSave");
  const intentSection = document.getElementById("intentSection");
  const consumption = document.getElementById("consumptionSection");
  const summary = document.getElementById("intentSummary");

  if (!one || !save || !intentSection || !consumption || !summary) {
    console.error("Intent elements missing in DOM");
    return;
  }

  one.classList.toggle("active", type === "one");
  save.classList.toggle("active", type === "save");

  intentSection.classList.add("d-none");
  consumption.classList.remove("d-none");
  summary.classList.remove("d-none");
}
function clearErrors(){
  document
    .querySelectorAll(".invalid-feedback")
    .forEach(e => e.remove());

  document
    .querySelectorAll(".is-invalid")
    .forEach(e => e.classList.remove("is-invalid"));
}


function parsePlusExpression(input, fieldName) {
  if (!input || !input.trim()) return 0;

  // Allow only digits, + and spaces
  if (!/^[0-9+\s]+$/.test(input)) {
    throw new Error(
      fieldName + " can contain only numbers and '+' sign"
    );
  }

  // Remove trailing +
  let cleaned = input.trim().replace(/\+\s*$/, "");

  const parts = cleaned.split("+");
  let sum = 0;

  for (let part of parts) {
    const val = part.trim();
    if (val === "") continue;   // <-- silently ignore empty part
    sum += Number(val);
  }

  return sum;
}


function resetIntent(){
  document.getElementById("intentSection").classList.remove("d-none");
  document.getElementById("intentSummary").classList.add("d-none");
  identitySection.classList.add("d-none");
  billPeriodSection.classList.add("d-none");
  arrearsRow.classList.add("d-none");
}

/* Validation */
function validateUnits(){
  clearErrors();

  let g, i, e;

  try {
    g = parsePlusExpression(gross.value, "Gross Units");
    i = parsePlusExpression(importU.value, "Import Units");
    e = parsePlusExpression(exportU.value, "Export Units");
  } catch(err) {
    // Don't block typing; show error only on Calculate
    return;
  }

  if (i > g) {
    markError(importU, "Import cannot exceed Gross");
  }

  if (e > i) {
    markError(exportU, "Export cannot exceed Import");
  }
}


function markError(el,msg){
  el.classList.add("is-invalid");
  const d=document.createElement("div");
  d.className="invalid-feedback";
  d.innerText=msg;
  el.parentNode.appendChild(d);
}

/* Calculation */
function calculate(){
  if(document.querySelector(".is-invalid")){
    alert("Please correct highlighted fields");
    return;
  }

let g=0, i=0, e=0, f=0, t=0, a=0;

try {
  g = parsePlusExpression(gross.value, "Gross Units");
  i = parsePlusExpression(importU.value, "Import Units");
  e = parsePlusExpression(exportU.value, "Export Units");
  f = parsePlusExpression(fixed.value, "Fixed Charges");
  t = parsePlusExpression(totalBill.value, "Total Bill Amount");
  a = parsePlusExpression(arrears.value, "Arrears");
} catch (err) {
  alert(err.message);
  return;
}

  const net=i-e;
  const direct=g-i;
  const unitRate=(t-f)/net;
  const without=(g*unitRate)+f;

let days = null;
  result.innerHTML=`
    <div class="result-box">
      <b>Input Summary</b><br>
      Gross: ${g} | Import: ${i} | Export: ${e}<br>
      Direct Solar Used: ${direct} units<br>
      (Gross Units - Import Units i.e. units consumed directly from Solar in day time) <br>     
      Fixed Charges: ‚Çπ${f} | Bill Amount: ‚Çπ${t} | Per Unit rate: ‚Çπ${(unitRate).toFixed(2)} (Total Bill Amount - Fixed Charges)/(Import Unit - Export Units))
    </div>

    <div class="result-box row text-center">
      <div class="col-6">
        <b>Without Solar</b><br>
        ‚Çπ${without.toFixed(0)}<br>
        (Gross Units * Per Unit Rate)+Fixed Charges)
        ${days?`‚Çπ${(without/days).toFixed(0)} / day`:""}
      </div>
      <div class="col-6">
        <b>With Solar</b><br>
        ‚Çπ${t}<br>
        ${days?`‚Çπ${(t/days).toFixed(0)} / day`:""}
      </div>
    </div>

 <button class="btn btn-success mt-2"
 onclick='shareWhatsApp({
   gross:${g},
   importU:${i},
   exportU:${e},
   direct:${direct},
   withSolar:${t},
   withoutSolar:${without.toFixed(0)},
   saving:${(without-t).toFixed(0)}
 })'>
 Share on WhatsApp
</button>

  `;
}

function shareWhatsApp(data){
  const msg = encodeURIComponent(
`‚òÄÔ∏è SolarSanchay ‚Äì Solar Saving Result

Gross Units: ${data.gross}
Import Units: ${data.importU}
Export Units: ${data.exportU}
Direct Solar Used: ${data.direct} units

Bill With Solar: ‚Çπ${data.withSolar}
Estimated Bill Without Solar: ‚Çπ${data.withoutSolar}

üí∞ Saving: ‚Çπ${data.saving}`
  );
  window.open(`https://wa.me/?text=${msg}`);
}

document.getElementById("lastModified").innerText =
  new Date(document.lastModified).toLocaleString("en-IN");
</script>

</body>
</html>
