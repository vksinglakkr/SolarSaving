<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SolarSanchay - Solar Savings Calculator & Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 2rem;
}
.container {
  max-width: 900px;
  margin: 0 auto;
  background: white;
  border-radius: 20px;
  padding: 2rem;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.hidden { display: none !important; }
.header {
  text-align: center;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 3px solid #667eea;
}
.header h1 {
  color: #1e3a8a;
  font-size: 2rem;
  margin-bottom: 0.5rem;
}
.header p {
  color: #64748b;
  font-size: 0.9rem;
}
.intent-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin: 2rem 0;
}
.intent-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 2rem;
  border-radius: 12px;
  cursor: pointer;
  text-align: center;
  transition: transform 0.3s, box-shadow 0.3s;
}
.intent-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.intent-card h3 {
  font-size: 1.2rem;
  margin-bottom: 0.5rem;
}
.form-group {
  margin-bottom: 1.5rem;
}
.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  color: #1e3a8a;
  font-weight: 600;
}
.form-group input {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s;
}
.form-group input:focus {
  outline: none;
  border-color: #667eea;
}
.btn {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}
.btn:hover { transform: scale(1.02); }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }

.result-card {
  margin-top: 2rem;
  padding: 2rem;
  background: #f8fafc;
  border-radius: 12px;
  border-left: 4px solid #667eea;
}
.stat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}
.stat-item {
  padding: 1.5rem;
  border-radius: 12px;
  text-align: center;
  color: white;
}

/* Bill Card Styles */
.bill-card {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  cursor: pointer;
  transition: all 0.3s;
}
.bill-card:hover {
  border-color: #667eea;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
}

/* Modal Styles */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(4px);
}
.modal-content {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}
.modal-buttons {
  display: flex;
  gap: 1rem;
  margin-top: 1.5rem;
}
.modal-btn {
  flex: 1;
  padding: 0.75rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}
.modal-btn:hover { transform: scale(1.02); }
.modal-btn-primary {
  background: #667eea;
  color: white;
}
.modal-btn-secondary {
  background: #e2e8f0;
  color: #334155;
}

/* Spinner */
.spinner {
  border: 3px solid #f3f4f6;
  border-top: 3px solid #667eea;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Action Buttons Container */
.action-buttons {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-bottom: 2rem;
}
.action-btn {
  padding: 0.75rem 1rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
}
.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Scrollbar Styling */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #667eea; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #5568d3; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üåû SolarSanchay</h1>
    <p>Government of Haryana Solar Savings Portal</p>
  </div>

  <!-- Intent Selection -->
  <div id="intentSelection">
    <h2 style="text-align: center; color: #1e3a8a; margin-bottom: 1.5rem;">Choose an Option</h2>
    <div class="intent-cards">
      <div class="intent-card" onclick="selectIntent('quick')">
        <h3>üßÆ Quick Calculator</h3>
        <p style="font-size: 0.85rem;">Instant calculation without saving</p>
      </div>
      <div class="intent-card" onclick="selectIntent('save')">
        <h3>üíæ Save & Track</h3>
        <p style="font-size: 0.85rem;">Save your bill for history</p>
      </div>
      <div class="intent-card" onclick="selectIntent('view')">
        <h3>üìä My Dashboard</h3>
        <p style="font-size: 0.85rem;">View & manage saved bills</p>
      </div>
    </div>
  </div>

  <!-- Authentication Section -->
  <div id="authSection" class="hidden">
    <h2 style="color: #1e3a8a; margin-bottom: 1.5rem;">üîê Login to Dashboard</h2>
    <div class="form-group">
      <label>Meter Number *</label>
      <input type="text" id="authMeter" placeholder="Enter meter number">
    </div>
    <div class="form-group">
      <label>Account Number *</label>
      <input type="text" id="authAccount" placeholder="Enter account number">
    </div>
    <button class="btn" onclick="authenticateUser()">Login to Dashboard</button>
    <button class="btn" style="background: #64748b; margin-top: 1rem;" onclick="resetCalculator()">Back</button>
  </div>

  <!-- Calculator Section -->
  <div id="calculatorSection" class="hidden">
    <h2 style="color: #1e3a8a; margin-bottom: 1.5rem;" id="calcTitle">Solar Savings Calculator</h2>
    
    <div class="auth-fields" style="display: none;">
      <div class="form-group">
        <label>Bill Number *</label>
        <input type="text" id="billNumber" placeholder="e.g., bill111234">
      </div>
      <div class="form-group">
        <label>Meter Number *</label>
        <input type="text" id="meterNumber" placeholder="e.g., 12345678">
      </div>
      <div class="form-group">
        <label>Account Number *</label>
        <input type="text" id="accountNumber" placeholder="e.g., ACC12345">
      </div>
    </div>

    <div class="form-group">
      <label>Bill From Date</label>
      <input type="date" id="billFrom">
    </div>
    <div class="form-group">
      <label>Bill To Date</label>
      <input type="date" id="billTo">
    </div>

    <div class="form-group">
      <label>Gross Units *</label>
      <input type="number" id="grossUnits" placeholder="e.g., 1354">
    </div>
    <div class="form-group">
      <label>Import Units *</label>
      <input type="number" id="importUnits" placeholder="e.g., 1114">
    </div>
    <div class="form-group">
      <label>Export Units *</label>
      <input type="number" id="exportUnits" placeholder="e.g., 944">
    </div>

    <div class="form-group">
      <label>Fixed Charges (‚Çπ) *</label>
      <input type="number" id="fixedCharges" placeholder="e.g., 1605">
    </div>
    <div class="form-group">
      <label>Total Bill Amount (‚Çπ) *</label>
      <input type="number" id="totalBill" placeholder="e.g., 2700">
    </div>
    <div class="form-group">
      <label>Arrears (‚Çπ)</label>
      <input type="number" id="arrears" placeholder="e.g., 0" value="0">
    </div>

    <button class="btn" id="actionBtn" onclick="initiateCalculation()">Calculate</button>
    <button class="btn" style="background: #64748b; margin-top: 1rem;" onclick="resetCalculator()">Back</button>

    <div id="result"></div>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboardSection" class="hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="color: #1e3a8a; margin: 0;">üìä My Dashboard</h2>
      <div id="userInfo" style="font-size: 0.85rem; color: #64748b;"></div>
    </div>
    <div id="billsList"></div>
    <button class="btn" style="background: #64748b; margin-top: 2rem;" onclick="logout()">Logout</button>
  </div>
</div>

<!-- Modal -->
<div id="customModal" class="modal hidden" onclick="if(event.target === this) closeModal()">
  <div class="modal-content">
    <div style="text-align: center; font-size: 3rem;" id="modalIcon">‚úÖ</div>
    <h2 style="text-align: center; margin: 1rem 0;" id="modalTitle">Success</h2>
    <div id="modalMessage" style="color: #64748b;"></div>
    <div class="modal-buttons" id="modalButtons"></div>
  </div>
</div>

<script>
// ==========================================
// GLOBAL VARIABLES
// ==========================================
let currentMode = 'quick';
let currentUser = null;
let userBills = [];
let selectedBillIndex = null;

// ==========================================
// MODE SELECTION
// ==========================================
function selectIntent(mode) {
  currentMode = mode;
  
  document.getElementById('intentSelection').classList.add('hidden');
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('dashboardSection').classList.add('hidden');
  document.getElementById('calculatorSection').classList.add('hidden');
  
  if (mode === 'quick') {
    document.getElementById('calculatorSection').classList.remove('hidden');
    document.getElementById('calcTitle').textContent = 'üßÆ Quick Calculator';
    document.querySelector('.auth-fields').style.display = 'none';
    document.getElementById('actionBtn').textContent = 'Calculate';
  } else if (mode === 'save') {
    document.getElementById('calculatorSection').classList.remove('hidden');
    document.getElementById('calcTitle').textContent = 'üíæ Save & Track';
    document.querySelector('.auth-fields').style.display = 'block';
    document.getElementById('actionBtn').textContent = 'Save & Calculate';
  } else if (mode === 'view') {
    document.getElementById('authSection').classList.remove('hidden');
  }
}

// ==========================================
// CALCULATE INITIATION
// ==========================================
function initiateCalculation() {
  const values = {
    billNumber: document.getElementById('billNumber')?.value,
    meterNumber: document.getElementById('meterNumber')?.value,
    accountNumber: document.getElementById('accountNumber')?.value,
    billFrom: document.getElementById('billFrom')?.value,
    billTo: document.getElementById('billTo')?.value,
    gross: parseFloat(document.getElementById('grossUnits')?.value),
    importU: parseFloat(document.getElementById('importUnits')?.value),
    exportU: parseFloat(document.getElementById('exportUnits')?.value),
    fixed: parseFloat(document.getElementById('fixedCharges')?.value),
    total: parseFloat(document.getElementById('totalBill')?.value),
    arrears: parseFloat(document.getElementById('arrears')?.value || 0)
  };
  
  if (currentMode === 'save') {
    if (!values.billNumber || !values.meterNumber || !values.accountNumber) {
      showErrorModal('‚ö†Ô∏è Please fill Bill Number, Meter Number, and Account Number');
      return;
    }
  }
  
  if (isNaN(values.gross) || isNaN(values.importU) || isNaN(values.exportU) || 
      isNaN(values.fixed) || isNaN(values.total)) {
    showErrorModal('‚ö†Ô∏è Please fill all required fields');
    return;
  }
  
  processCalculation(values);
}

// ==========================================
// PROCESS CALCULATION
// ==========================================
async function processCalculation(values) {
  const net = values.importU - values.exportU;
  const direct = values.gross - values.importU;
  const currentBill = values.total - values.arrears;
  const unitRate = (currentBill - values.fixed) / net;
  const billWithoutSolar = (values.gross * unitRate) + values.fixed;
  const saving = billWithoutSolar - currentBill;
  const savingPercent = (saving / billWithoutSolar) * 100;
  
  let days = null;
  let savingPerDay = null;
  let annualProjection = null;
  
  if (values.billFrom && values.billTo) {
    const from = new Date(values.billFrom);
    const to = new Date(values.billTo);
    const diffMs = to - from;
    if (diffMs > 0) {
      days = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
      savingPerDay = saving / days;
      annualProjection = savingPerDay * 365;
    }
  }
  
  const results = {
    ...values,
    net, direct, currentBill, unitRate, billWithoutSolar,
    saving, savingPercent, days, savingPerDay, annualProjection
  };
  
  const btn = document.getElementById('actionBtn');
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div>';
  
  if (currentMode === 'save') {
    const webhookData = {
      billNumber: values.billNumber,
      meterNumber: values.meterNumber,
      accountNumber: values.accountNumber,
      billPeriod: { from: values.billFrom, to: values.billTo, days },
      consumption: { grossUnits: values.gross, importUnits: values.importU, exportUnits: values.exportU, directSolarUsed: direct },
      charges: { fixedCharges: values.fixed, totalBillAmount: values.total, arrears: values.arrears, perUnitRate: unitRate.toFixed(2) },
      calculation: { 
        billWithSolar: currentBill,
        billWithoutSolar: billWithoutSolar.toFixed(2),
        totalSaving: saving.toFixed(2), 
        savingPercentage: savingPercent.toFixed(2), 
        savingPerDay: savingPerDay ? savingPerDay.toFixed(2) : null, 
        annualSaving: annualProjection ? annualProjection.toFixed(2) : null 
      }
    };
    
    try {
      const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-saving', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(webhookData)
      });
      
      if (response.ok) {
        const data = await response.json().catch(() => ({ status: 'success' }));
        
        if (data.status === 'error' && data.code === 'DUPLICATE_FOUND') {
          showErrorModal('‚ö†Ô∏è Duplicate bill found! This bill already exists.');
        } else {
          showSuccessModal('‚úÖ Bill saved successfully!');
          setTimeout(() => {
            closeModal();
            displayResults(results);
          }, 2000);
        }
      } else {
        throw new Error('Server error');
      }
    } catch (error) {
      console.error(error);
      showErrorModal('‚ö†Ô∏è Failed to save. Showing results anyway.');
      setTimeout(() => {
        closeModal();
        displayResults(results);
      }, 2000);
    }
  } else {
    displayResults(results);
  }
  
  btn.disabled = false;
  btn.textContent = originalText;
}

// ==========================================
// DISPLAY RESULTS
// ==========================================
function displayResults(results) {
  document.getElementById('result').innerHTML = `
    <div class="result-card">
      <h3 style="color: #1e3a8a; margin-bottom: 1rem;">üí∞ Your Solar Savings</h3>
      <div class="stat-grid">
        <div class="stat-item" style="background: linear-gradient(135deg, #10b981, #059669);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Total Saving</div>
          <div style="font-size: 2rem; font-weight: 700;">‚Çπ${results.saving.toFixed(0)}</div>
        </div>
        <div class="stat-item" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Saving %</div>
          <div style="font-size: 2rem; font-weight: 700;">${results.savingPercent.toFixed(1)}%</div>
        </div>
        ${results.savingPerDay ? `
        <div class="stat-item" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Per Day</div>
          <div style="font-size: 2rem; font-weight: 700;">‚Çπ${results.savingPerDay.toFixed(0)}</div>
        </div>
        <div class="stat-item" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Annual</div>
          <div style="font-size: 2rem; font-weight: 700;">‚Çπ${results.annualProjection.toFixed(0)}</div>
        </div>
        ` : ''}
      </div>
    </div>
  `;
}

// Continue in next part due to length...
</script>

<script>
// ==========================================
// AUTHENTICATION & DASHBOARD
// ==========================================
async function authenticateUser() {
  const meter = document.getElementById('authMeter').value.trim();
  const account = document.getElementById('authAccount').value.trim();
  
  if (!meter || !account) {
    showErrorModal('‚ö†Ô∏è Please enter both Meter and Account Number');
    return;
  }
  
  const authSection = document.getElementById('authSection');
  const loadingDiv = document.createElement('div');
  loadingDiv.id = 'authLoading';
  loadingDiv.innerHTML = '<div style="text-align: center; margin-top: 1rem;"><div class="spinner"></div></div>';
  authSection.appendChild(loadingDiv);
  
  try {
    const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-authenticate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ meterNumber: meter, accountNumber: account })
    });
    
    const data = await response.json();
    document.getElementById('authLoading')?.remove();
    
    if (data.status === 'success' && data.authenticated) {
      currentUser = { meter, account };
      userBills = data.bills || [];
      
      showSuccessModal(`‚úÖ Login Successful!<br><br>Found ${data.billCount} bill(s).`);
      
      setTimeout(() => {
        closeModal();
        showDashboard();
      }, 1500);
      
    } else {
      if (data.billCount === 0 || data.message.includes('No records')) {
        showModal('‚ÑπÔ∏è', 'No Bills Found', `
          <p style="margin-bottom: 1rem;">You haven't saved any bills yet.</p>
          <p><strong>First time user?</strong></p>
          <ol style="text-align: left; margin: 1rem 0; padding-left: 2rem; font-size: 0.9rem;">
            <li>Select "Save & Track" mode</li>
            <li>Enter your first bill details</li>
            <li>Use Meter: <strong>${meter}</strong></li>
            <li>Use Account: <strong>${account}</strong></li>
          </ol>
        `, [
          { text: 'Save First Bill', type: 'primary', action: () => { closeModal(); selectIntent('save'); } },
          { text: 'Cancel', type: 'secondary', action: closeModal }
        ]);
      } else {
        showErrorModal('‚ùå Authentication Failed<br><br>Invalid credentials.');
      }
    }
  } catch (error) {
    document.getElementById('authLoading')?.remove();
    console.error(error);
    showErrorModal('‚ùå Connection error. Please try again.');
  }
}

function showDashboard() {
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('dashboardSection').classList.remove('hidden');
  document.getElementById('userInfo').textContent = `Meter: ${currentUser.meter} | Account: ${currentUser.account}`;
  displayBillsList();
}

function displayBillsList() {
  const billsList = document.getElementById('billsList');
  
  if (!userBills || userBills.length === 0) {
    billsList.innerHTML = `
      <div style="text-align: center; padding: 3rem; color: #64748b;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
        <p style="font-size: 1.2rem; font-weight: 600;">No Bills Found</p>
      </div>
    `;
    return;
  }
  
  const totalSavings = userBills.reduce((sum, bill) => sum + parseFloat(bill['Solar Saving Amount'] || 0), 0);
  const avgSaving = totalSavings / userBills.length;
  
  billsList.innerHTML = `
    <div class="stat-grid" style="margin-bottom: 2rem;">
      <div class="stat-item" style="background: linear-gradient(135deg, #10b981, #059669);">
        <div style="font-size: 0.85rem; opacity: 0.9;">Total Bills</div>
        <div style="font-size: 2rem; font-weight: 700;">${userBills.length}</div>
      </div>
      <div class="stat-item" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
        <div style="font-size: 0.85rem; opacity: 0.9;">Total Savings</div>
        <div style="font-size: 2rem; font-weight: 700;">‚Çπ${totalSavings.toFixed(0)}</div>
      </div>
      <div class="stat-item" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
        <div style="font-size: 0.85rem; opacity: 0.9;">Avg Saving</div>
        <div style="font-size: 2rem; font-weight: 700;">‚Çπ${avgSaving.toFixed(0)}</div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="action-btn" style="background: #3b82f6; color: white;" onclick="viewSelectedBill()" id="viewBtn" disabled>
        üìÑ View
      </button>
      <button class="action-btn" style="background: #f59e0b; color: white;" onclick="editSelectedBill()" id="editBtn" disabled>
        ‚úèÔ∏è Edit
      </button>
      <button class="action-btn" style="background: #ef4444; color: white;" onclick="deleteSelectedBill()" id="deleteBtn" disabled>
        üóëÔ∏è Delete
      </button>
    </div>

    <div id="billCards">
      ${userBills.map((bill, index) => createBillCard(bill, index)).join('')}
    </div>
  `;
}

function createBillCard(bill, index) {
  const billDate = bill['Entry DateTime'] ? new Date(bill['Entry DateTime']).toLocaleDateString('en-IN') : 'N/A';
  const saving = parseFloat(bill['Solar Saving Amount'] || 0);
  const savingPercent = parseFloat(bill['Saving Percentage'] || 0);
  const billAmount = parseFloat(bill['Total Bill Amount'] || 0);
  
  return `
    <div class="bill-card" onclick="selectBill(${index})">
      <div style="display: flex; align-items: center; gap: 1rem;">
        <input type="radio" name="billSelection" value="${index}" 
               style="width: 20px; height: 20px; cursor: pointer;"
               onchange="selectBill(${index})">
        
        <div style="flex: 1;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <div>
              <div style="font-weight: 700; font-size: 1.1rem; color: #1e3a8a;">
                Bill #${bill['Bill Number'] || 'N/A'}
              </div>
              <div style="font-size: 0.85rem; color: #64748b;">
                üìÖ ${billDate}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 0.85rem; color: #64748b;">Bill Amount</div>
              <div style="font-weight: 600; color: #1e3a8a;">‚Çπ${billAmount.toFixed(0)}</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
            <div>
              <div style="font-size: 0.75rem; color: #64748b;">Solar Saving</div>
              <div style="font-weight: 700; font-size: 1.3rem; color: #10b981;">‚Çπ${saving.toFixed(0)}</div>
            </div>
            <div>
              <div style="font-size: 0.75rem; color: #64748b;">Saving %</div>
              <div style="font-weight: 700; font-size: 1.3rem; color: #3b82f6;">${savingPercent.toFixed(1)}%</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function selectBill(index) {
  selectedBillIndex = index;
  
  document.getElementById('viewBtn').disabled = false;
  document.getElementById('editBtn').disabled = false;
  document.getElementById('deleteBtn').disabled = false;
  
  document.querySelectorAll('input[name="billSelection"]').forEach((radio, i) => {
    radio.checked = (i === index);
  });
  
  document.querySelectorAll('.bill-card').forEach((card, i) => {
    if (i === index) {
      card.style.borderColor = '#667eea';
      card.style.background = '#f0f4ff';
    } else {
      card.style.borderColor = '#e2e8f0';
      card.style.background = 'white';
    }
  });
}

// VIEW, EDIT, DELETE functions continue in next part...
</script>

<script>
// ==========================================
// VIEW BILL DETAILS
// ==========================================
function viewSelectedBill() {
  if (selectedBillIndex === null) {
    showErrorModal('Please select a bill first');
    return;
  }
  
  const bill = userBills[selectedBillIndex];
  
  const modalContent = `
    <div style="text-align: left;">
      <h3 style="color: #1e3a8a; margin-bottom: 1.5rem;">Bill Details</h3>
      
      <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <table style="width: 100%; font-size: 0.9rem;">
          <tr>
            <td style="padding: 0.5rem; color: #64748b;"><strong>Bill Number:</strong></td>
            <td style="padding: 0.5rem;">${bill['Bill Number'] || 'N/A'}</td>
          </tr>
          <tr>
            <td style="padding: 0.5rem; color: #64748b;"><strong>Meter Number:</strong></td>
            <td style="padding: 0.5rem;">${bill['Meter Number'] || 'N/A'}</td>
          </tr>
          <tr>
            <td style="padding: 0.5rem; color: #64748b;"><strong>Entry Date:</strong></td>
            <td style="padding: 0.5rem;">${bill['Entry DateTime'] ? new Date(bill['Entry DateTime']).toLocaleString('en-IN') : 'N/A'}</td>
          </tr>
        </table>
      </div>
      
      <h4 style="color: #1e3a8a; margin: 1rem 0;">Consumption</h4>
      <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <table style="width: 100%; font-size: 0.9rem;">
          <tr>
            <td style="padding: 0.5rem; color: #64748b;">Gross Units:</td>
            <td style="padding: 0.5rem;">${bill['Gross Units'] || 0}</td>
          </tr>
          <tr>
            <td style="padding: 0.5rem; color: #64748b;">Import Units:</td>
            <td style="padding: 0.5rem;">${bill['Import Units'] || 0}</td>
          </tr>
          <tr>
            <td style="padding: 0.5rem; color: #64748b;">Export Units:</td>
            <td style="padding: 0.5rem;">${bill['Export Units'] || 0}</td>
          </tr>
        </table>
      </div>
      
      <h4 style="color: #1e3a8a; margin: 1rem 0;">Charges & Savings</h4>
      <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
        <table style="width: 100%; font-size: 0.9rem;">
          <tr>
            <td style="padding: 0.5rem; color: #64748b;">Fixed Charges:</td>
            <td style="padding: 0.5rem;">‚Çπ${bill['Fixed Charges'] || 0}</td>
          </tr>
          <tr>
            <td style="padding: 0.5rem; color: #64748b;">Total Bill:</td>
            <td style="padding: 0.5rem;">‚Çπ${bill['Total Bill Amount'] || 0}</td>
          </tr>
          <tr style="background: #ecfdf5;">
            <td style="padding: 0.5rem; color: #059669;"><strong>Solar Saving:</strong></td>
            <td style="padding: 0.5rem; color: #059669; font-weight: 700;">‚Çπ${bill['Solar Saving Amount'] || 0}</td>
          </tr>
          <tr style="background: #eff6ff;">
            <td style="padding: 0.5rem; color: #2563eb;"><strong>Saving %:</strong></td>
            <td style="padding: 0.5rem; color: #2563eb; font-weight: 700;">${bill['Saving Percentage'] || 0}%</td>
          </tr>
        </table>
      </div>
    </div>
  `;
  
  showModal('üìÑ', 'Bill Details', modalContent, [
    { text: 'Close', type: 'primary', action: closeModal }
  ]);
}

// ==========================================
// EDIT BILL
// ==========================================
function editSelectedBill() {
  if (selectedBillIndex === null) {
    showErrorModal('Please select a bill first');
    return;
  }
  
  const bill = userBills[selectedBillIndex];
  
  const modalContent = `
    <div style="text-align: left;">
      <h3 style="color: #1e3a8a; margin-bottom: 1rem;">Edit Bill</h3>
      <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 1.5rem;">
        Editing: Bill #${bill['Bill Number']}
      </p>
      
      <div class="form-group">
        <label>Gross Units *</label>
        <input type="number" id="editGross" value="${bill['Gross Units'] || ''}">
      </div>
      <div class="form-group">
        <label>Import Units *</label>
        <input type="number" id="editImport" value="${bill['Import Units'] || ''}">
      </div>
      <div class="form-group">
        <label>Export Units *</label>
        <input type="number" id="editExport" value="${bill['Export Units'] || ''}">
      </div>
      <div class="form-group">
        <label>Fixed Charges (‚Çπ) *</label>
        <input type="number" id="editFixed" value="${bill['Fixed Charges'] || ''}">
      </div>
      <div class="form-group">
        <label>Total Bill (‚Çπ) *</label>
        <input type="number" id="editTotal" value="${bill['Total Bill Amount'] || ''}">
      </div>
      <div class="form-group">
        <label>Revision Reason</label>
        <input type="text" id="editReason" placeholder="Why are you updating this?">
      </div>
    </div>
  `;
  
  showModal('‚úèÔ∏è', 'Edit Bill', modalContent, [
    { text: 'Cancel', type: 'secondary', action: closeModal },
    { text: 'Save Changes', type: 'primary', action: saveEditedBill }
  ]);
}

async function saveEditedBill() {
  const bill = userBills[selectedBillIndex];
  
  const updatedData = {
    billNumber: bill['Bill Number'],
    meterNumber: bill['Meter Number'],
    accountNumber: bill['Account Number'],
    entryType: 'EDIT',
    revisionReason: document.getElementById('editReason').value || 'Updated by user',
    grossUnits: parseFloat(document.getElementById('editGross').value),
    importUnits: parseFloat(document.getElementById('editImport').value),
    exportUnits: parseFloat(document.getElementById('editExport').value),
    fixedCharges: parseFloat(document.getElementById('editFixed').value),
    totalBillAmount: parseFloat(document.getElementById('editTotal').value)
  };
  
  closeModal();
  showModal('‚è≥', 'Updating...', '<div class="spinner" style="margin: 2rem auto;"></div>', []);
  
  try {
    const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedData)
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      showSuccessModal('‚úÖ Bill updated successfully!');
      setTimeout(() => {
        closeModal();
        authenticateUser();
      }, 2000);
    } else {
      showErrorModal('Failed to update: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error(error);
    showErrorModal('‚ùå Connection error');
  }
}

// ==========================================
// DELETE BILL
// ==========================================
function deleteSelectedBill() {
  if (selectedBillIndex === null) {
    showErrorModal('Please select a bill first');
    return;
  }
  
  const bill = userBills[selectedBillIndex];
  
  showModal('‚ö†Ô∏è', 'Confirm Deletion', `
    <p style="margin-bottom: 1rem;">Are you sure you want to delete this bill?</p>
    <div style="background: #fef2f2; padding: 1rem; border-radius: 8px; border-left: 4px solid #ef4444;">
      <div style="font-weight: 600;">Bill #${bill['Bill Number']}</div>
      <div style="font-size: 0.9rem; color: #64748b; margin-top: 0.5rem;">
        Entered on: ${bill['Entry DateTime'] ? new Date(bill['Entry DateTime']).toLocaleDateString('en-IN') : 'N/A'}
      </div>
    </div>
    <p style="margin-top: 1rem; font-size: 0.85rem; color: #64748b;">
      ‚ÑπÔ∏è This will mark the bill as inactive.
    </p>
  `, [
    { text: 'Cancel', type: 'secondary', action: closeModal },
    { text: 'Yes, Delete', type: 'primary', action: confirmDeleteBill }
  ]);
}

async function confirmDeleteBill() {
  const bill = userBills[selectedBillIndex];
  
  closeModal();
  showModal('‚è≥', 'Deleting...', '<div class="spinner" style="margin: 2rem auto;"></div>', []);
  
  try {
    const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        billNumber: bill['Bill Number'],
        meterNumber: bill['Meter Number'],
        accountNumber: bill['Account Number']
      })
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      showSuccessModal('‚úÖ Bill deleted successfully!');
      setTimeout(() => {
        closeModal();
        selectedBillIndex = null;
        authenticateUser();
      }, 2000);
    } else {
      showErrorModal('Failed to delete: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error(error);
    showErrorModal('‚ùå Connection error');
  }
}

// ==========================================
// MODAL FUNCTIONS
// ==========================================
function showModal(icon, title, message, buttons) {
  document.getElementById('modalIcon').textContent = icon;
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalMessage').innerHTML = message;
  
  const btnContainer = document.getElementById('modalButtons');
  btnContainer.innerHTML = '';
  buttons.forEach(btn => {
    const button = document.createElement('button');
    button.className = `modal-btn modal-btn-${btn.type}`;
    button.textContent = btn.text;
    button.onclick = btn.action;
    btnContainer.appendChild(button);
  });
  
  document.getElementById('customModal').classList.remove('hidden');
}

function closeModal() {
  document.getElementById('customModal').classList.add('hidden');
}

function showSuccessModal(msg) {
  showModal('‚úÖ', 'Success', msg, [{ text: 'OK', type: 'primary', action: closeModal }]);
}

function showErrorModal(msg) {
  showModal('‚ùå', 'Error', msg, [{ text: 'OK', type: 'primary', action: closeModal }]);
}

// ==========================================
// RESET & LOGOUT
// ==========================================
function resetCalculator() {
  document.querySelectorAll('input').forEach(i => i.value = '');
  document.getElementById('result').innerHTML = '';
  document.getElementById('calculatorSection').classList.add('hidden');
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('dashboardSection').classList.add('hidden');
  document.getElementById('intentSelection').classList.remove('hidden');
  currentMode = 'quick';
  selectedBillIndex = null;
}

function logout() {
  currentUser = null;
  userBills = [];
  selectedBillIndex = null;
  document.getElementById('dashboardSection').classList.add('hidden');
  document.getElementById('intentSelection').classList.remove('hidden');
}
</script>

</body>
</html>
