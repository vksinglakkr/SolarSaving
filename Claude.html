<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SolarSanchay ‚Äì Haryana Solar Savings Portal</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary: #FF6B35;
  --primary-dark: #E55A2B;
  --secondary: #004E89;
  --secondary-light: #1A659E;
  --accent: #FFA630;
  --success: #06D6A0;
  --light: #F7F9FC;
  --dark: #1E293B;
  --glass: rgba(255, 255, 255, 0.75);
  --glass-border: rgba(255, 255, 255, 0.3);
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
  --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.12);
  --shadow-lg: 0 16px 64px rgba(0, 0, 0, 0.18);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Work Sans', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
  background-attachment: fixed;
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
}

/* Animated background particles */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 50%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(6, 214, 160, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 50% 20%, rgba(255, 166, 48, 0.1) 0%, transparent 50%);
  animation: float 20s ease-in-out infinite;
  pointer-events: none;
}

@keyframes float {
  0%, 100% { transform: translate(0, 0) scale(1); }
  33% { transform: translate(30px, -30px) scale(1.1); }
  66% { transform: translate(-20px, 20px) scale(0.9); }
}

/* Header */
.header {
  background: var(--glass);
  backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--glass-border);
  padding: 1rem 0;
  box-shadow: var(--shadow-sm);
  position: sticky;
  top: 0;
  z-index: 1000;
  animation: slideDown 0.6s ease-out;
}

@keyframes slideDown {
  from { transform: translateY(-100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.header-logo {
  height: 60px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
}

.header-logo:hover {
  transform: scale(1.05) rotate(2deg);
}

.header-title {
  font-family: 'Playfair Display', serif;
  font-weight: 900;
  font-size: 1.75rem;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}

.header-subtitle {
  font-weight: 500;
  color: var(--secondary);
  font-size: 0.9rem;
}

/* Container */
.main-container {
  max-width: 900px;
  margin: 2rem auto;
  padding: 0 1rem;
  position: relative;
  z-index: 1;
}

/* Glass Card */
.glass-card {
  background: var(--glass);
  backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-md);
  animation: fadeInUp 0.6s ease-out backwards;
  transition: all 0.3s ease;
}

.glass-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

@keyframes fadeInUp {
  from { 
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Intent Cards */
.intent-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-top: 1.5rem;
}

.intent-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
  backdrop-filter: blur(10px);
  border: 2px solid transparent;
  border-radius: 20px;
  padding: 2rem 1.5rem;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  position: relative;
  overflow: hidden;
  animation: fadeInUp 0.6s ease-out backwards;
}

.intent-card:nth-child(2) { animation-delay: 0.1s; }
.intent-card:nth-child(3) { animation-delay: 0.2s; }

.intent-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  opacity: 0;
  transition: opacity 0.4s ease;
  z-index: 0;
}

.intent-card:hover::before {
  opacity: 0.1;
}

.intent-card:hover {
  transform: translateY(-8px) scale(1.02);
  border-color: var(--primary);
  box-shadow: 0 20px 40px rgba(255, 107, 53, 0.3);
}

.intent-card.active {
  border-color: var(--success);
  background: linear-gradient(135deg, rgba(6, 214, 160, 0.2), rgba(6, 214, 160, 0.1));
  transform: scale(1.05);
}

.intent-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  display: block;
  position: relative;
  z-index: 1;
}

.intent-title {
  font-family: 'Playfair Display', serif;
  font-weight: 700;
  font-size: 1.3rem;
  margin-bottom: 0.5rem;
  color: var(--dark);
  position: relative;
  z-index: 1;
}

.intent-desc {
  color: #64748b;
  font-size: 0.9rem;
  position: relative;
  z-index: 1;
}

/* Helper Cards */
.helper-section {
  background: linear-gradient(135deg, rgba(255, 166, 48, 0.15), rgba(255, 107, 53, 0.1));
  border: 2px dashed rgba(255, 107, 53, 0.3);
  border-radius: 20px;
  padding: 2rem;
  margin-top: 2rem;
  animation: fadeInUp 0.8s ease-out backwards;
}

.helper-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.helper-card {
  background: white;
  border: 2px solid var(--accent);
  border-radius: 16px;
  padding: 1.5rem;
  text-align: center;
  transition: all 0.3s ease;
}

.helper-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(255, 166, 48, 0.3);
}

.helper-card h6 {
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 1rem;
  font-size: 1rem;
}

/* Forms */
.form-section {
  animation: fadeInUp 0.6s ease-out backwards;
}

.form-label {
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
  display: block;
}

.form-control {
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 0.75rem 1rem;
  font-size: 1rem;
  transition: all 0.3s ease;
  background: white;
}

.form-control:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
  outline: none;
  transform: translateY(-2px);
}

.input-group {
  position: relative;
}

.input-plus-btn {
  background: linear-gradient(135deg, var(--accent), var(--primary));
  color: white;
  border: none;
  border-radius: 0 12px 12px 0;
  padding: 0 1.5rem;
  font-weight: 600;
  transition: all 0.3s ease;
  cursor: pointer;
}

.input-plus-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(255, 166, 48, 0.4);
}

/* Buttons */
.btn-primary-custom {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  border: none;
  border-radius: 16px;
  padding: 1rem 2rem;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  box-shadow: 0 8px 24px rgba(255, 107, 53, 0.3);
  position: relative;
  overflow: hidden;
}

.btn-primary-custom::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn-primary-custom:hover::before {
  width: 300px;
  height: 300px;
}

.btn-primary-custom:hover {
  transform: translateY(-4px) scale(1.02);
  box-shadow: 0 12px 32px rgba(255, 107, 53, 0.4);
}

.btn-primary-custom:active {
  transform: translateY(-2px) scale(0.98);
}

.btn-secondary-custom {
  background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
  color: white;
  border: none;
  border-radius: 12px;
  padding: 0.75rem 1.5rem;
  font-weight: 600;
  transition: all 0.3s ease;
  cursor: pointer;
}

.btn-outline-custom {
  background: transparent;
  color: var(--primary);
  border: 2px solid var(--primary);
  border-radius: 12px;
  padding: 0.75rem 1.5rem;
  font-weight: 600;
  transition: all 0.3s ease;
  cursor: pointer;
}

.btn-outline-custom:hover {
  background: var(--primary);
  color: white;
  transform: translateY(-2px);
}

/* Results */
.result-card {
  background: white;
  border-radius: 20px;
  padding: 2rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-md);
  animation: scaleIn 0.5s ease-out backwards;
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.result-header {
  font-family: 'Playfair Display', serif;
  font-weight: 700;
  font-size: 1.5rem;
  color: var(--dark);
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.stat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1.5rem;
  margin: 1.5rem 0;
}

.stat-box {
  text-align: center;
  padding: 1.5rem;
  background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 166, 48, 0.05));
  border-radius: 16px;
  transition: all 0.3s ease;
}

.stat-box:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(255, 107, 53, 0.2);
}

.stat-value {
  font-family: 'Playfair Display', serif;
  font-size: 2rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-label {
  font-size: 0.85rem;
  color: #64748b;
  margin-top: 0.5rem;
  font-weight: 500;
}

/* Modal/Popup */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(8px);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: white;
  border-radius: 24px;
  padding: 2.5rem;
  max-width: 500px;
  width: 100%;
  box-shadow: 0 24px 80px rgba(0, 0, 0, 0.3);
  animation: modalSlideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  position: relative;
}

@keyframes modalSlideUp {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-icon {
  font-size: 4rem;
  text-align: center;
  margin-bottom: 1rem;
  animation: bounce 1s ease-in-out;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}

.modal-title {
  font-family: 'Playfair Display', serif;
  font-weight: 700;
  font-size: 1.75rem;
  text-align: center;
  color: var(--dark);
  margin-bottom: 1rem;
}

.modal-message {
  text-align: center;
  color: #64748b;
  font-size: 1rem;
  line-height: 1.6;
  margin-bottom: 2rem;
}

.modal-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
}

/* Alert Messages */
.alert-custom {
  border-radius: 16px;
  padding: 1rem 1.5rem;
  margin-bottom: 1.5rem;
  border: none;
  animation: slideInRight 0.5s ease-out;
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.alert-info-custom {
  background: linear-gradient(135deg, rgba(26, 101, 158, 0.15), rgba(0, 78, 137, 0.1));
  color: var(--secondary);
  border-left: 4px solid var(--secondary);
}

.alert-success-custom {
  background: linear-gradient(135deg, rgba(6, 214, 160, 0.15), rgba(6, 214, 160, 0.1));
  color: #059669;
  border-left: 4px solid var(--success);
}

.alert-danger-custom {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));
  color: #dc2626;
  border-left: 4px solid #ef4444;
}

/* Loading Spinner */
.spinner {
  width: 50px;
  height: 50px;
  margin: 2rem auto;
  border: 4px solid rgba(255, 107, 53, 0.2);
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Footer */
.footer {
  background: var(--glass);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--glass-border);
  padding: 2rem 0;
  margin-top: 4rem;
  text-align: center;
  color: var(--dark);
}

.footer-text {
  font-size: 0.9rem;
  color: #64748b;
}

.footer-brand {
  font-weight: 700;
  color: var(--primary);
}

/* Utility Classes */
.d-none { display: none !important; }
.text-center { text-align: center; }
.mt-2 { margin-top: 1rem; }
.mt-3 { margin-top: 1.5rem; }
.mb-2 { margin-bottom: 1rem; }
.mb-3 { margin-bottom: 1.5rem; }

/* Responsive */
@media (max-width: 768px) {
  .header-title { font-size: 1.3rem; }
  .intent-grid { grid-template-columns: 1fr; }
  .stat-grid { grid-template-columns: 1fr 1fr; }
  .modal-content { padding: 2rem 1.5rem; }
  .glass-card { padding: 1.5rem; }
}

/* Validation */
.is-invalid {
  border-color: #ef4444 !important;
  animation: shake 0.5s;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

.invalid-feedback {
  color: #ef4444;
  font-size: 0.85rem;
  margin-top: 0.5rem;
  display: block;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <img src="assests/haryana-logo.jpg" alt="Haryana Logo" class="header-logo">
        <div>
          <div class="header-title">SolarSanchay</div>
          <div class="header-subtitle">Solar Savings Estimation Portal</div>
        </div>
      </div>
      <div class="d-none d-md-block">
        <span style="font-weight: 600; color: var(--secondary);">NIC Kurukshetra</span>
      </div>
    </div>
  </div>
</div>

<div class="main-container">

  <!-- INTENT SELECTION -->
  <div id="intentSection">
    <div class="glass-card">
      <h2 style="font-family: 'Playfair Display', serif; font-weight: 700; text-align: center; color: var(--dark); margin-bottom: 0.5rem;">
        Welcome to SolarSanchay
      </h2>
      <p style="text-align: center; color: #64748b; margin-bottom: 2rem;">
        Calculate and track your solar savings with precision
      </p>

      <div class="intent-grid">
        <div class="intent-card" onclick="selectIntent('one')">
          <span class="intent-icon">‚ö°</span>
          <h3 class="intent-title">Quick Check</h3>
          <p class="intent-desc">One-time calculation without saving data</p>
        </div>

        <div class="intent-card" onclick="selectIntent('save')">
          <span class="intent-icon">üíæ</span>
          <h3 class="intent-title">Save & Track</h3>
          <p class="intent-desc">Maintain bill history and analyze trends</p>
        </div>

        <div class="intent-card" onclick="selectIntent('view')">
          <span class="intent-icon">üìä</span>
          <h3 class="intent-title">My Bills</h3>
          <p class="intent-desc">View saved bills and comprehensive analysis</p>
        </div>
      </div>
    </div>

    <!-- HELPER CARDS -->
    <div class="helper-section">
      <h5 style="font-weight: 700; color: var(--dark); margin-bottom: 0.5rem;">
        üîç Helpful Resources
      </h5>
      <p style="color: #64748b; font-size: 0.9rem;">
        Everything you need before you start
      </p>

      <div class="helper-grid">
        <div class="helper-card">
          <h6>üìÑ Download Bill</h6>
          <a href="https://www.uhbvn.org.in/web/portal/auth?lastPage=/view-bill" 
             target="_blank" 
             class="btn btn-outline-custom btn-sm">
            Open Portal
          </a>
        </div>

        <div class="helper-card">
          <h6>‚ÑπÔ∏è Bill Terms</h6>
          <button class="btn btn-outline-custom btn-sm" onclick="showHelpModal()">
            Learn More
          </button>
        </div>

        <div class="helper-card">
          <h6>‚òÄÔ∏è Why This Tool?</h6>
          <span class="badge" style="background: var(--success); color: white; padding: 0.5rem 1rem; border-radius: 8px;">
            Secure & Free
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- INTENT SUMMARY -->
  <div id="intentSummary" class="alert-info-custom alert-custom d-none">
    <strong id="intentText"></strong>
    <button class="btn btn-sm btn-outline-custom" style="float: right;" onclick="resetIntent()">
      Change
    </button>
  </div>

  <!-- AUTHENTICATION SECTION -->
  <div id="authSection" class="glass-card d-none">
    <h3 style="font-family: 'Playfair Display', serif; font-weight: 700; color: var(--dark); margin-bottom: 1rem;">
      üîê Access Your Bills
    </h3>
    <p style="color: #64748b; margin-bottom: 2rem;">
      Enter your credentials to view and analyze your saved bills
    </p>

    <div class="mb-3">
      <label class="form-label">Meter Number</label>
      <input id="authMeter" type="text" class="form-control" placeholder="e.g., 24600455">
    </div>

    <div class="mb-3">
      <label class="form-label">Account Number</label>
      <input id="authAccount" type="text" class="form-control" placeholder="e.g., ACC789123">
    </div>

    <button class="btn-primary-custom w-100" onclick="authenticateUser()">
      üîç View My Bills
    </button>

    <div id="authError" class="alert-danger-custom alert-custom d-none mt-3"></div>
  </div>

  <!-- RECORDS LIST SECTION -->
  <div id="recordsSection" class="d-none">
    <div class="glass-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 style="font-family: 'Playfair Display', serif; font-weight: 700; color: var(--dark);">
          üìã Your Bill History
        </h3>
        <button class="btn-secondary-custom btn-sm" onclick="logout()">
          Logout
        </button>
      </div>

      <div id="billsList"></div>

      <button class="btn-primary-custom w-100 mt-3" onclick="analyzeSelected()">
        üìä Analyze Selected Bills
      </button>
    </div>
  </div>

  <!-- ANALYSIS RESULTS SECTION -->
  <div id="analysisSection" class="d-none">
    <div class="glass-card">
      <h3 style="font-family: 'Playfair Display', serif; font-weight: 700; color: var(--dark); margin-bottom: 2rem;">
        üìà Analysis Results
      </h3>
      <div id="analysisResults"></div>
    </div>
  </div>

  <!-- IDENTITY SECTION -->
  <div id="identitySection" class="glass-card d-none">
    <h4 style="font-weight: 700; color: var(--dark); margin-bottom: 1.5rem;">
      üë§ Consumer Identification
    </h4>

    <div class="mb-3">
      <label class="form-label">Bill Number</label>
      <input id="billNumber" type="text" class="form-control" placeholder="e.g., 123456">
    </div>

    <div class="mb-3">
      <label class="form-label">Meter Number</label>
      <input id="meter" type="text" class="form-control" placeholder="e.g., 24600455">
    </div>

    <div class="mb-3">
      <label class="form-label">Account Number</label>
      <input id="accountNumber" type="text" class="form-control" placeholder="e.g., ACC789123">
      <small style="color: #64748b; font-size: 0.85rem;">
        Required for authentication & future access
      </small>
    </div>
  </div>

  <!-- BILL PERIOD SECTION -->
  <div id="billPeriodSection" class="glass-card d-none">
    <h4 style="font-weight: 700; color: var(--dark); margin-bottom: 1.5rem;">
      üìÖ Bill Period
    </h4>

    <div class="mb-3">
      <label class="form-label">From Date</label>
      <input type="date" id="billFrom" class="form-control">
    </div>

    <div class="mb-3">
      <label class="form-label">To Date</label>
      <input type="date" id="billTo" class="form-control">
    </div>
  </div>

  <!-- CONSUMPTION SECTION -->
  <div id="consumptionSection" class="glass-card d-none">
    <h4 style="font-weight: 700; color: var(--dark); margin-bottom: 1.5rem;">
      ‚ö° Consumption & Charges
    </h4>

    <div class="mb-3">
      <label class="form-label">Gross Units</label>
      <div class="input-group">
        <input id="gross" type="text" inputmode="numeric" class="form-control" 
               placeholder="e.g., 1354" oninput="handleNumericInput(this)">
        <button class="input-plus-btn" type="button" onclick="appendPlus('gross')">+</button>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Import Units</label>
      <div class="input-group">
        <input id="importU" type="text" inputmode="numeric" class="form-control" 
               placeholder="e.g., 1114" oninput="handleNumericInput(this)" onblur="validateUnits()">
        <button class="input-plus-btn" type="button" onclick="appendPlus('importU')">+</button>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Export Units</label>
      <div class="input-group">
        <input id="exportU" type="text" inputmode="numeric" class="form-control" 
               placeholder="e.g., 944" oninput="handleNumericInput(this)" onblur="validateUnits()">
        <button class="input-plus-btn" type="button" onclick="appendPlus('exportU')">+</button>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Fixed Charges ‚Çπ</label>
      <div class="input-group">
        <input id="fixed" type="text" inputmode="numeric" class="form-control" 
               placeholder="e.g., 1605" oninput="handleNumericInput(this)">
        <button class="input-plus-btn" type="button" onclick="appendPlus('fixed')">+</button>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Total Bill Amount ‚Çπ</label>
      <div class="input-group">
        <input id="totalBill" type="text" inputmode="numeric" class="form-control" 
               placeholder="e.g., 2700" oninput="handleNumericInput(this)">
        <button class="input-plus-btn" type="button" onclick="appendPlus('totalBill')">+</button>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Arrears ‚Çπ (if any)</label>
      <div class="input-group">
        <input id="arrears" type="text" inputmode="numeric" class="form-control" 
               placeholder="e.g., 0" oninput="handleNumericInput(this)">
        <button class="input-plus-btn" type="button" onclick="appendPlus('arrears')">+</button>
      </div>
    </div>
  </div>

  <button id="actionBtn" class="btn-primary-custom w-100 d-none" onclick="calculate()">
    Calculate Solar Saving
  </button>

  <div id="result" class="mt-3"></div>

</div>

<!-- FOOTER -->
<div class="footer">
  <div class="container">
    <p class="footer-text">
      Developed by <span class="footer-brand">National Informatics Centre (NIC), Kurukshetra</span><br>
      for <strong>District Administration, Kurukshetra</strong>
    </p>
    <p class="footer-text mt-2">
      Last Updated: <span id="lastModified"></span>
    </p>
  </div>
</div>

<script>
// Global variables
const identitySection = document.getElementById("identitySection");
const billPeriodSection = document.getElementById("billPeriodSection");
const consumptionSection = document.getElementById("consumptionSection");
const actionBtn = document.getElementById("actionBtn");
const result = document.getElementById("result");

const gross = document.getElementById("gross");
const importU = document.getElementById("importU");
const exportU = document.getElementById("exportU");
const fixed = document.getElementById("fixed");
const totalBill = document.getElementById("totalBill");
const arrears = document.getElementById("arrears");

let entryMode = "one";
let currentUser = null;
let userBills = [];

// Modal functions
function showModal(icon, title, message, buttons) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal-content">
      <div class="modal-icon">${icon}</div>
      <h3 class="modal-title">${title}</h3>
      <p class="modal-message">${message}</p>
      <div class="modal-actions">
        ${buttons.map(btn => `
          <button class="btn-${btn.type}-custom" onclick="${btn.action}">
            ${btn.text}
          </button>
        `).join('')}
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  
  // Close on overlay click
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeModal();
  });
}

function closeModal() {
  const modals = document.querySelectorAll('.modal-overlay');
  modals.forEach(modal => {
    modal.style.animation = 'fadeOut 0.3s ease-out';
    setTimeout(() => modal.remove(), 300);
  });
}

function showSuccessModal(message) {
  showModal('‚úÖ', 'Success!', message, [
    { text: 'OK', type: 'primary', action: 'closeModal()' }
  ]);
}

function showErrorModal(message) {
  showModal('‚ùå', 'Error', message, [
    { text: 'OK', type: 'secondary', action: 'closeModal()' }
  ]);
}

function showConfirmModal(message, onConfirm) {
  const confirmId = 'confirm_' + Date.now();
  window[confirmId] = () => {
    closeModal();
    onConfirm();
  };
  
  showModal('‚ùì', 'Confirm Action', message, [
    { text: 'Cancel', type: 'outline', action: 'closeModal()' },
    { text: 'Confirm', type: 'primary', action: `${confirmId}()` }
  ]);
}

function showHelpModal() {
  showModal('‚ÑπÔ∏è', 'Understanding Bill Terms', `
    <strong>Gross Units:</strong> Total electricity consumed (solar + grid)<br><br>
    <strong>Import Units:</strong> Electricity taken from grid<br><br>
    <strong>Export Units:</strong> Surplus solar sent back to grid<br><br>
    <strong>Net Units:</strong> Import - Export (what you pay for)<br><br>
    <strong>Fixed Charges:</strong> Monthly connection charges<br><br>
    <strong>Total Bill:</strong> Final amount including all charges
  `, [{ text: 'Got It', type: 'primary', action: 'closeModal()' }]);
}

// Input handling
function handleNumericInput(input) {
  if (entryMode === "save") {
    input.value = input.value.replace(/[^0-9]/g, "");
  } else {
    let cleaned = input.value.replace(/[^0-9+\s]/g, "");
    cleaned = cleaned.replace(/\+{2,}/g, "+");
    input.value = cleaned;
  }
}

function appendPlus(fieldId) {
  const input = document.getElementById(fieldId);
  if (!input.value.trim()) {
    showErrorModal("Please enter a value first");
    input.focus();
    return;
  }
  if (!input.value.trim().endsWith("+")) {
    input.value = input.value.trim() + " + ";
  }
  input.focus();
}

// Intent selection
function selectIntent(type) {
  entryMode = type;

  const intentSection = document.getElementById("intentSection");
  const intentSummary = document.getElementById("intentSummary");
  const intentText = document.getElementById("intentText");
  const authSection = document.getElementById("authSection");

  intentSection.classList.add("d-none");

  if (type === "view") {
    authSection.classList.remove("d-none");
    authSection.scrollIntoView({ behavior: 'smooth' });
    return;
  }

  if (intentSummary && intentText) {
    intentSummary.classList.remove("d-none");
    intentText.innerHTML = type === "one"
      ? "‚úî <b>Quick Check:</b> Results not saved"
      : "‚úî <b>Save & Track:</b> Bill details will be stored for future analysis";
  }

  consumptionSection.classList.remove("d-none");

  if (type === "save") {
    identitySection.classList.remove("d-none");
    billPeriodSection.classList.remove("d-none");
    actionBtn.innerText = "üíæ Save & Submit";
  } else {
    identitySection.classList.add("d-none");
    billPeriodSection.classList.add("d-none");
    actionBtn.innerText = "üîç Calculate Saving";
  }

  actionBtn.classList.remove("d-none");
  consumptionSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function resetIntent() {
  entryMode = "one";
  document.getElementById("intentSection")?.classList.remove("d-none");
  document.getElementById("intentSummary")?.classList.add("d-none");
  document.getElementById("consumptionSection")?.classList.add("d-none");
  document.getElementById("identitySection")?.classList.add("d-none");
  document.getElementById("billPeriodSection")?.classList.add("d-none");
  document.getElementById("actionBtn")?.classList.add("d-none");
  document.getElementById("result").innerHTML = "";
  
  // Clear all inputs
  document.querySelectorAll('input[type="text"], input[type="date"]').forEach(input => {
    input.value = "";
    input.classList.remove("is-invalid");
  });
  clearErrors();
}

// Authentication
async function authenticateUser() {
  const meter = document.getElementById("authMeter").value.trim();
  const account = document.getElementById("authAccount").value.trim();
  const errorDiv = document.getElementById("authError");

  if (!meter || !account) {
    errorDiv.innerText = "‚ö†Ô∏è Please enter both Meter and Account Number";
    errorDiv.classList.remove("d-none");
    return;
  }

  // Show loading
  const authBtn = event.target;
  const originalText = authBtn.innerText;
  authBtn.innerHTML = '<div class="spinner" style="width: 24px; height: 24px; margin: 0 auto; border-width: 3px;"></div>';
  authBtn.disabled = true;

  try {
    const response = await fetch("https://n8n-workflow-test.duckdns.org/webhook/solar-authenticate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ meterNumber: meter, accountNumber: account })
    });

    const data = await response.json();

    if (data.status === "success" && data.authenticated) {
      currentUser = { meter, account };
      errorDiv.classList.add("d-none");
      showSuccessModal(`Authentication successful! Found ${data.billCount} bill(s).`);
      setTimeout(() => {
        closeModal();
        loadUserBills();
      }, 1500);
    } else {
      errorDiv.innerText = "‚ùå " + (data.message || "Authentication failed");
      errorDiv.classList.remove("d-none");
    }
  } catch (error) {
    console.error("Auth error:", error);
    errorDiv.innerText = "‚ùå Connection error. Please try again.";
    errorDiv.classList.remove("d-none");
  } finally {
    authBtn.innerHTML = originalText;
    authBtn.disabled = false;
  }
}

// Load user bills
async function loadUserBills() {
  const authSection = document.getElementById("authSection");
  const recordsSection = document.getElementById("recordsSection");
  const billsList = document.getElementById("billsList");

  billsList.innerHTML = '<div class="spinner"></div>';

  try {
    const response = await fetch("https://n8n-workflow-test.duckdns.org/webhook/solar-records", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        meterNumber: currentUser.meter,
        accountNumber: currentUser.account
      })
    });

    const data = await response.json();

    if (data.status === "success") {
      userBills = data.bills;
      authSection.classList.add("d-none");
      recordsSection.classList.remove("d-none");

      if (userBills.length === 0) {
        billsList.innerHTML = `
          <div class="alert-info-custom alert-custom">
            No bills found. Start by saving your first bill!
          </div>`;
      } else {
        let html = '<div style="display: grid; gap: 1rem;">';
        userBills.forEach((bill, index) => {
          html += `
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease;" 
                 onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-4px)'" 
                 onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="bill${index}" data-index="${index}" 
                       style="cursor: pointer; width: 20px; height: 20px;">
                <label class="form-check-label w-100" for="bill${index}" style="cursor: pointer;">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong style="font-size: 1.1rem; color: var(--dark);">Bill #${bill.billNumber}</strong><br>
                      <small style="color: #64748b;">${bill.billPeriod} (${bill.billingDays} days)</small>
                    </div>
                    <div class="text-end">
                      <div style="background: linear-gradient(135deg, var(--success), #059669); color: white; padding: 0.5rem 1rem; border-radius: 12px; font-weight: 700; font-size: 1.1rem;">
                        ‚Çπ${bill.saving}
                      </div>
                      <small style="color: #64748b; margin-top: 0.25rem; display: block;">${bill.savingPercent.toFixed(1)}% saved</small>
                    </div>
                  </div>
                </label>
              </div>
            </div>`;
        });
        html += '</div>';
        
        html += `
          <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button class="btn-outline-custom" onclick="selectAll()">Select All</button>
            <button class="btn-outline-custom" onclick="deselectAll()">Deselect All</button>
          </div>`;
        
        billsList.innerHTML = html;
      }
      
      recordsSection.scrollIntoView({ behavior: 'smooth' });
    }
  } catch (error) {
    console.error("Load bills error:", error);
    billsList.innerHTML = `
      <div class="alert-danger-custom alert-custom">
        ‚ùå Failed to load bills. Please try again.
      </div>`;
  }
}

function selectAll() {
  document.querySelectorAll('#billsList input[type="checkbox"]').forEach(cb => cb.checked = true);
}

function deselectAll() {
  document.querySelectorAll('#billsList input[type="checkbox"]').forEach(cb => cb.checked = false);
}

function logout() {
  showConfirmModal('Are you sure you want to logout?', () => {
    currentUser = null;
    userBills = [];
    
    document.getElementById("authSection").classList.add("d-none");
    document.getElementById("recordsSection").classList.add("d-none");
    document.getElementById("analysisSection").classList.add("d-none");
    document.getElementById("intentSection").classList.remove("d-none");
    
    document.getElementById("authMeter").value = "";
    document.getElementById("authAccount").value = "";
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
}

// Analysis
function analyzeSelected() {
  const checkboxes = document.querySelectorAll('#billsList input[type="checkbox"]:checked');
  
  if (checkboxes.length === 0) {
    showErrorModal("Please select at least one bill to analyze");
    return;
  }

  const selectedBills = Array.from(checkboxes).map(cb => {
    const index = parseInt(cb.dataset.index);
    return userBills[index];
  });

  let totalSaving = 0;
  let totalDays = 0;
  let totalBillAmount = 0;

  selectedBills.forEach(bill => {
    totalSaving += parseFloat(bill.saving);
    totalDays += parseInt(bill.billingDays);
    totalBillAmount += parseFloat(bill.totalAmount);
  });

  const avgDailySaving = totalSaving / totalDays;
  const annualProjection = avgDailySaving * 365;
  const avgSavingPercent = selectedBills.reduce((sum, b) => sum + b.savingPercent, 0) / selectedBills.length;

  const bestBill = selectedBills.reduce((max, b) => b.saving > max.saving ? b : max);
  const worstBill = selectedBills.reduce((min, b) => b.saving < min.saving ? b : min);

  const analysisSection = document.getElementById("analysisSection");
  const analysisResults = document.getElementById("analysisResults");

  analysisResults.innerHTML = `
    <div class="stat-grid">
      <div class="stat-box">
        <div class="stat-value">‚Çπ${totalSaving.toFixed(0)}</div>
        <div class="stat-label">Total Savings</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">‚Çπ${avgDailySaving.toFixed(0)}</div>
        <div class="stat-label">Avg. Daily Saving</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">‚Çπ${annualProjection.toFixed(0)}</div>
        <div class="stat-label">Annual Projection</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">${avgSavingPercent.toFixed(1)}%</div>
        <div class="stat-label">Avg. Savings %</div>
      </div>
    </div>

    <hr style="margin: 2rem 0; border: none; border-top: 2px dashed #e2e8f0;">

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
      <div style="background: linear-gradient(135deg, rgba(6, 214, 160, 0.1), rgba(6, 214, 160, 0.05)); padding: 1.5rem; border-radius: 16px;">
        <h6 style="color: var(--success); font-weight: 700; margin-bottom: 1rem;">üèÜ Best Performance</h6>
        <p style="margin: 0;">
          <strong>Bill #${bestBill.billNumber}</strong><br>
          <span style="font-size: 1.5rem; font-weight: 700; color: var(--success);">‚Çπ${bestBill.saving}</span>
          <span style="color: #64748b;"> (${bestBill.savingPercent.toFixed(1)}%)</span><br>
          <small style="color: #64748b;">${bestBill.billPeriod}</small>
        </p>
      </div>
      <div style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 107, 53, 0.05)); padding: 1.5rem; border-radius: 16px;">
        <h6 style="color: var(--primary); font-weight: 700; margin-bottom: 1rem;">üìâ Lowest Performance</h6>
        <p style="margin: 0;">
          <strong>Bill #${worstBill.billNumber}</strong><br>
          <span style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">‚Çπ${worstBill.saving}</span>
          <span style="color: #64748b;"> (${worstBill.savingPercent.toFixed(1)}%)</span><br>
          <small style="color: #64748b;">${worstBill.billPeriod}</small>
        </p>
      </div>
    </div>

    <div class="alert-success-custom alert-custom">
      <strong>üí° AI Insight:</strong> ${generateInsight(selectedBills)}
    </div>

    <button class="btn-primary-custom w-100 mt-2" onclick="shareAnalysis()">
      üì§ Share Analysis on WhatsApp
    </button>
  `;

  analysisSection.classList.remove("d-none");
  analysisSection.scrollIntoView({ behavior: 'smooth' });
}

function generateInsight(bills) {
  const avgPercent = bills.reduce((sum, b) => sum + b.savingPercent, 0) / bills.length;
  
  if (avgPercent >= 70) {
    return "Excellent solar performance! Your system is working optimally and saving you significantly on electricity costs.";
  } else if (avgPercent >= 50) {
    return "Good solar performance! Your investment is paying off well. Continue monitoring for consistent savings.";
  } else if (avgPercent >= 30) {
    return "Moderate savings observed. Consider checking if all panels are clean and functioning properly.";
  } else {
    return "Lower than expected savings. Recommend a professional system inspection to ensure optimal performance.";
  }
}

function shareAnalysis() {
  const checkboxes = document.querySelectorAll('#billsList input[type="checkbox"]:checked');
  const selectedBills = Array.from(checkboxes).map(cb => userBills[parseInt(cb.dataset.index)]);
  
  const totalSaving = selectedBills.reduce((sum, b) => sum + parseFloat(b.saving), 0);
  const totalDays = selectedBills.reduce((sum, b) => sum + parseInt(b.billingDays), 0);
  const annualProjection = (totalSaving / totalDays) * 365;

  const msg = encodeURIComponent(
`‚òÄÔ∏è SolarSanchay - My Solar Savings Analysis

üìä Bills Analyzed: ${selectedBills.length}
üí∞ Total Savings: ‚Çπ${totalSaving.toFixed(0)}
üìÖ Period: ${totalDays} days
üìà Annual Projection: ‚Çπ${annualProjection.toFixed(0)}

Generated by SolarSanchay - Haryana`
  );

  window.open(`https://wa.me/?text=${msg}`);
}

// Validation
function clearErrors() {
  document.querySelectorAll(".invalid-feedback").forEach(e => e.remove());
  document.querySelectorAll(".is-invalid").forEach(e => e.classList.remove("is-invalid"));
}

function markError(el, msg) {
  el.classList.add("is-invalid");
  const d = document.createElement("div");
  d.className = "invalid-feedback";
  d.innerText = msg;
  el.parentNode.appendChild(d);
}

function parsePlusExpression(input, fieldName) {
  if (!input || !input.trim()) return 0;
  if (!/^[0-9+\s]+$/.test(input)) {
    throw new Error(fieldName + " can contain only numbers and '+' sign");
  }
  let cleaned = input.trim().replace(/\+\s*$/, "");
  const parts = cleaned.split("+");
  let sum = 0;
  for (let part of parts) {
    const val = part.trim();
    if (val === "") continue;
    sum += Number(val);
  }
  return sum;
}

function validateUnits() {
  clearErrors();
  let g, i, e;
  try {
    g = entryMode === "save" ? Number(gross.value) : parsePlusExpression(gross.value, "Gross Units");
    i = entryMode === "save" ? Number(importU.value) : parsePlusExpression(importU.value, "Import Units");
    e = entryMode === "save" ? Number(exportU.value) : parsePlusExpression(exportU.value, "Export Units");
  } catch(err) {
    return;
  }
  if (i > g) markError(importU, "Import cannot exceed Gross");
  if (e > i) markError(exportU, "Export cannot exceed Import");
}

// Calculate
async function calculate() {
  // First validation check
  if (document.querySelector(".is-invalid")) {
    showErrorModal("Please correct the highlighted fields before proceeding");
    return;
  }

  let g = 0, i = 0, e = 0, f = 0, t = 0, a = 0;

  try {
    g = entryMode === "save" ? Number(gross.value) : parsePlusExpression(gross.value, "Gross Units");
    i = entryMode === "save" ? Number(importU.value) : parsePlusExpression(importU.value, "Import Units");
    e = entryMode === "save" ? Number(exportU.value) : parsePlusExpression(exportU.value, "Export Units");
    f = entryMode === "save" ? Number(fixed.value) : parsePlusExpression(fixed.value, "Fixed Charges");
    t = entryMode === "save" ? Number(totalBill.value) : parsePlusExpression(totalBill.value, "Total Bill Amount");
    a = entryMode === "save" ? Number(arrears.value || 0) : parsePlusExpression(arrears.value || "0", "Arrears");
  } catch (err) {
    showErrorModal(err.message);
    return;
  }

  // Second check popup - Confirm values
  showConfirmModal(
    `Please verify your entered values:<br><br>
    <strong>Gross Units:</strong> ${g}<br>
    <strong>Import Units:</strong> ${i}<br>
    <strong>Export Units:</strong> ${e}<br>
    <strong>Fixed Charges:</strong> ‚Çπ${f}<br>
    <strong>Total Bill:</strong> ‚Çπ${t}<br><br>
    Are these values correct?`,
    async () => {
      await processCalculation(g, i, e, f, t, a);
    }
  );
}

// ==========================================
// FIXED processCalculation Function
// Replace your existing function with this
// ==========================================

async function processCalculation(values) {
  closeModal();
  
  // Calculate results locally first
  const net = values.importU - values.exportU;
  const direct = values.gross - values.importU;
  const currentBill = values.total - values.arrears;
  const unitRate = (currentBill - values.fixed) / net;
  const billWithoutSolar = (values.gross * unitRate) + values.fixed;
  const saving = billWithoutSolar - currentBill;
  const savingPercent = (saving / billWithoutSolar) * 100;
  
  let days = null;
  let savingPerDay = null;
  let annualProjection = null;
  
  if (values.billFrom && values.billTo) {
    const from = new Date(values.billFrom);
    const to = new Date(values.billTo);
    const diffMs = to - from;
    if (diffMs > 0) {
      days = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
      savingPerDay = saving / days;
      annualProjection = savingPerDay * 365;
    }
  }
  
  const results = {
    ...values,
    net,
    direct,
    currentBill,
    unitRate,
    billWithoutSolar,
    saving,
    savingPercent,
    days,
    savingPerDay,
    annualProjection
  };
  
  // Show loading
  const btn = document.getElementById('actionBtn');
  const originalBtnText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner" style="width: 24px; height: 24px; margin: 0 auto; border-width: 3px;"></div>';
  
  // If save mode, send to webhook
  if (currentMode === 'save') {
    const webhookData = {
      mode: 'save',
      billNumber: values.billNumber,
      meterNumber: values.meterNumber,
      accountNumber: values.accountNumber,
      billPeriod: {
        from: values.billFrom,
        to: values.billTo,
        days: days
      },
      consumption: {
        grossUnits: values.gross,
        importUnits: values.importU,
        exportUnits: values.exportU,
        directSolarUsed: direct
      },
      charges: {
        fixedCharges: values.fixed,
        totalBillAmount: values.total,
        arrears: values.arrears,
        perUnitRate: parseFloat(unitRate.toFixed(2))
      },
      calculation: {
        billWithSolar: currentBill,
        billWithoutSolar: parseFloat(billWithoutSolar.toFixed(2)),
        totalSaving: parseFloat(saving.toFixed(2)),
        savingPercentage: parseFloat(savingPercent.toFixed(2)),
        savingPerDay: savingPerDay ? parseFloat(savingPerDay.toFixed(2)) : null,
        annualSaving: annualProjection ? parseFloat(annualProjection.toFixed(2)) : null
      },
      timestamp: new Date().toISOString()
    };
    
    try {
      console.log('Sending to webhook:', webhookData);
      
      const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-saving', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        mode: 'cors',
        body: JSON.stringify(webhookData)
      });
      
      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);
      
      // First check if response is OK (status 200-299)
      if (!response.ok) {
        console.error('HTTP error:', response.status, response.statusText);
        throw new Error(`Server error: ${response.status}`);
      }
      
      // Get the response text
      const responseText = await response.text();
      console.log('Raw response:', responseText);
      
      // Try to parse as JSON
      let data;
      try {
        data = responseText ? JSON.parse(responseText) : {};
      } catch (parseError) {
        console.error('JSON parse error:', parseError);
        console.log('Response was not valid JSON');
        
        // If response is not JSON but status was OK, assume success
        if (response.ok) {
          console.log('Treating as success (empty/non-JSON response)');
          data = { status: 'success' };
        } else {
          throw new Error('Invalid response from server');
        }
      }
      
      console.log('Parsed response:', data);
      
      // Handle duplicate error
      if (data.status === 'error' && data.code === 'DUPLICATE_FOUND') {
        console.log('Duplicate detected');
        
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
        
        showModal('‚ö†Ô∏è', 'Duplicate Bill Detected', 
          `A bill with this combination already exists:<br><br>
          <strong>Bill #${data.existingBill?.billNumber || values.billNumber}</strong><br>
          ${data.existingBill?.entryDate ? `Entered on: ${new Date(data.existingBill.entryDate).toLocaleDateString('en-IN')}<br>` : ''}
          ${data.existingBill?.billAmount ? `Bill Amount: ‚Çπ${data.existingBill.billAmount}<br>` : ''}
          ${data.existingBill?.saving ? `Saving: ‚Çπ${data.existingBill.saving}<br>` : ''}
          <br>Would you like to view it or enter a different bill?`,
          [
            { text: 'View Details', type: 'secondary', action: 'closeModal()' },
            { text: 'Enter Different Bill', type: 'primary', action: 'closeModal(); resetCalculator();' }
          ]
        );
        return;
      }
      
      // Handle other errors
      if (data.status === 'error') {
        console.error('Error response:', data);
        throw new Error(data.message || 'Unknown error from server');
      }
      
      // SUCCESS - if we get here, it worked!
      // (status === 'success' OR response.ok with no error status)
      console.log('‚úÖ Save successful!');
      
      showSuccessModal(`
        ‚úÖ Bill Saved Successfully!<br><br>
        <strong>Bill Number:</strong> ${values.billNumber}<br>
        <strong>Solar Saving:</strong> ‚Çπ${saving.toFixed(0)}<br>
        <strong>Saving Percentage:</strong> ${savingPercent.toFixed(1)}%<br><br>
        Your data has been securely stored.
      `);
      
      setTimeout(() => {
        closeModal();
        displayResults(results);
      }, 2500);
      
    } catch (webhookError) {
      console.error('Webhook error:', webhookError);
      
      // Show user-friendly error message
      let errorMsg = '‚ùå Failed to Save Bill<br><br>';
      
      if (webhookError.message.includes('Failed to fetch')) {
        errorMsg += '<strong>Network Error</strong><br>';
        errorMsg += '‚Ä¢ Check your internet connection<br>';
        errorMsg += '‚Ä¢ The server may be temporarily unavailable<br><br>';
      } else if (webhookError.message.includes('CORS')) {
        errorMsg += '<strong>Connection Error</strong><br>';
        errorMsg += 'Unable to connect to the server.<br><br>';
      } else if (webhookError.message.includes('Server error')) {
        errorMsg += '<strong>Server Error</strong><br>';
        errorMsg += `${webhookError.message}<br><br>`;
      } else {
        errorMsg += `<strong>Error:</strong> ${webhookError.message}<br><br>`;
      }
      
      errorMsg += '<em>Your calculation is still available below.</em>';
      
      showErrorModal(errorMsg);
      
      // Still show results locally
      setTimeout(() => {
        closeModal();
        displayResults(results);
      }, 500);
      
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalBtnText;
    }
    
  } else {
    // Quick mode - just display results
    btn.disabled = false;
    btn.innerHTML = originalBtnText;
    displayResults(results);
  }
}

// Helper function for displaying results
function displayResults(results) {
  const resultDiv = document.getElementById('result');
  if (!resultDiv) return;
  
  resultDiv.innerHTML = `
    <div class="result-card">
      <h3 class="result-header">üí∞ Your Solar Savings</h3>
      <div class="stat-grid">
        <div class="stat-item">
          <span class="stat-label">Total Saving</span>
          <span class="stat-value">‚Çπ${results.saving.toFixed(0)}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Saving %</span>
          <span class="stat-value">${results.savingPercent.toFixed(1)}%</span>
        </div>
        ${results.savingPerDay ? `
        <div class="stat-item">
          <span class="stat-label">Per Day</span>
          <span class="stat-value">‚Çπ${results.savingPerDay.toFixed(0)}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Annual Projection</span>
          <span class="stat-value">‚Çπ${results.annualProjection.toFixed(0)}</span>
        </div>
        ` : ''}
      </div>
    </div>
  `;
  
  // Smooth scroll to results
  resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Reset calculator function
function resetCalculator() {
  document.querySelectorAll('input').forEach(input => input.value = '');
  document.getElementById('result').innerHTML = '';
}
function shareResult(gross, importU, exportU, direct, withSolar, withoutSolar, saving) {
  const msg = encodeURIComponent(
`‚òÄÔ∏è SolarSanchay ‚Äì Solar Saving Result

Gross Units: ${gross}
Import Units: ${importU}
Export Units: ${exportU}
Direct Solar Used: ${direct} units

Bill With Solar: ‚Çπ${withSolar}
Estimated Bill Without Solar: ‚Çπ${withoutSolar}

üí∞ Saving: ‚Çπ${saving}

Generated by SolarSanchay - Haryana`
  );
  window.open(`https://wa.me/?text=${msg}`);
}

// Initialize
document.getElementById("lastModified").innerText = new Date(document.lastModified).toLocaleString("en-IN");
</script>

</body>
</html>
