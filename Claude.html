<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SolarSanchay - Solar Savings Calculator</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 2rem;
}
.container {
  max-width: 800px;
  margin: 0 auto;
  background: white;
  border-radius: 20px;
  padding: 2rem;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.hidden { display: none !important; }
.header {
  text-align: center;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 3px solid #667eea;
}
.header h1 {
  color: #1e3a8a;
  font-size: 2rem;
  margin-bottom: 0.5rem;
}
.header p {
  color: #64748b;
  font-size: 0.9rem;
}
.intent-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin: 2rem 0;
}
.intent-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 2rem;
  border-radius: 12px;
  cursor: pointer;
  text-align: center;
  transition: transform 0.3s, box-shadow 0.3s;
}
.intent-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.intent-card h3 {
  font-size: 1.2rem;
  margin-bottom: 0.5rem;
}
.form-group {
  margin-bottom: 1.5rem;
}
.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  color: #1e3a8a;
  font-weight: 600;
}
.form-group input {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s;
}
.form-group input:focus {
  outline: none;
  border-color: #667eea;
}
.btn {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}
.btn:hover {
  transform: scale(1.02);
}
.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.result-card {
  margin-top: 2rem;
  padding: 2rem;
  background: #f8fafc;
  border-radius: 12px;
  border-left: 4px solid #667eea;
}
.stat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}
.stat-item {
  padding: 1.5rem;
  border-radius: 12px;
  text-align: center;
  color: white;
}
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.modal-content {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}
.modal-buttons {
  display: flex;
  gap: 1rem;
  margin-top: 1.5rem;
}
.modal-btn {
  flex: 1;
  padding: 0.75rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}
.modal-btn-primary {
  background: #667eea;
  color: white;
}
.modal-btn-secondary {
  background: #e2e8f0;
  color: #334155;
}
.spinner {
  border: 3px solid #f3f4f6;
  border-top: 3px solid #667eea;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üåû SolarSanchay</h1>
    <p>Government of Haryana Solar Savings Portal</p>
  </div>

  <!-- Intent Selection -->
  <div id="intentSelection">
    <h2 style="text-align: center; color: #1e3a8a; margin-bottom: 1.5rem;">Choose an Option</h2>
    <div class="intent-cards">
      <div class="intent-card" onclick="selectIntent('quick')">
        <h3>üßÆ Quick Calculator</h3>
        <p style="font-size: 0.85rem;">Instant calculation without saving</p>
      </div>
      <div class="intent-card" onclick="selectIntent('save')">
        <h3>üíæ Save & Track</h3>
        <p style="font-size: 0.85rem;">Save your bill for history</p>
      </div>
      <div class="intent-card" onclick="selectIntent('view')">
        <h3>üìä My Dashboard</h3>
        <p style="font-size: 0.85rem;">View saved bills</p>
      </div>
    </div>
  </div>

  <!-- Authentication Section -->
  <div id="authSection" class="hidden">
    <h2 style="color: #1e3a8a; margin-bottom: 1.5rem;">üîê Login to Dashboard</h2>
    <div class="form-group">
      <label>Meter Number</label>
      <input type="text" id="authMeter" placeholder="Enter meter number">
    </div>
    <div class="form-group">
      <label>Account Number</label>
      <input type="text" id="authAccount" placeholder="Enter account number">
    </div>
    <button class="btn" onclick="authenticateUser()">Login</button>
    <button class="btn" style="background: #64748b; margin-top: 1rem;" onclick="resetCalculator()">Back</button>
  </div>

  <!-- Calculator Section -->
  <div id="calculatorSection" class="hidden">
    <h2 style="color: #1e3a8a; margin-bottom: 1.5rem;" id="calcTitle">Solar Savings Calculator</h2>
    
    <!-- Auth Fields (for Save mode) -->
    <div class="auth-fields" style="display: none;">
      <div class="form-group">
        <label>Bill Number *</label>
        <input type="text" id="billNumber" placeholder="e.g., bill111234">
      </div>
      <div class="form-group">
        <label>Meter Number *</label>
        <input type="text" id="meterNumber" placeholder="e.g., 12345678">
      </div>
      <div class="form-group">
        <label>Account Number *</label>
        <input type="text" id="accountNumber" placeholder="e.g., ACC12345">
      </div>
    </div>

    <!-- Bill Period -->
    <div class="form-group">
      <label>Bill From Date</label>
      <input type="date" id="billFrom">
    </div>
    <div class="form-group">
      <label>Bill To Date</label>
      <input type="date" id="billTo">
    </div>

    <!-- Consumption -->
    <div class="form-group">
      <label>Gross Units *</label>
      <input type="number" id="grossUnits" placeholder="e.g., 1354">
    </div>
    <div class="form-group">
      <label>Import Units *</label>
      <input type="number" id="importUnits" placeholder="e.g., 1114">
    </div>
    <div class="form-group">
      <label>Export Units *</label>
      <input type="number" id="exportUnits" placeholder="e.g., 944">
    </div>

    <!-- Charges -->
    <div class="form-group">
      <label>Fixed Charges (‚Çπ) *</label>
      <input type="number" id="fixedCharges" placeholder="e.g., 1605">
    </div>
    <div class="form-group">
      <label>Total Bill Amount (‚Çπ) *</label>
      <input type="number" id="totalBill" placeholder="e.g., 2700">
    </div>
    <div class="form-group">
      <label>Arrears (‚Çπ)</label>
      <input type="number" id="arrears" placeholder="e.g., 0" value="0">
    </div>

    <button class="btn" id="actionBtn" onclick="initiateCalculation()">Calculate</button>
    <button class="btn" style="background: #64748b; margin-top: 1rem;" onclick="resetCalculator()">Back</button>

    <!-- Results -->
    <div id="result"></div>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboardSection" class="hidden">
    <h2 style="color: #1e3a8a; margin-bottom: 1.5rem;">üìä My Bills</h2>
    <div id="billsList"></div>
    <button class="btn" style="background: #64748b; margin-top: 1rem;" onclick="resetCalculator()">Back</button>
  </div>
</div>

<!-- Modal -->
<div id="customModal" class="modal hidden">
  <div class="modal-content">
    <div style="text-align: center; font-size: 3rem;" id="modalIcon">‚úÖ</div>
    <h2 style="text-align: center; margin: 1rem 0;" id="modalTitle">Success</h2>
    <div id="modalMessage" style="text-align: center; color: #64748b;"></div>
    <div class="modal-buttons" id="modalButtons"></div>
  </div>
</div>

<script>
// ==========================================
// GLOBAL VARIABLES
// ==========================================
let currentMode = 'quick';
let currentUser = null;
let userBills = [];

// ==========================================
// MODE SELECTION
// ==========================================
function selectIntent(mode) {
  currentMode = mode;
  
  document.getElementById('intentSelection').classList.add('hidden');
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('dashboardSection').classList.add('hidden');
  document.getElementById('calculatorSection').classList.add('hidden');
  
  if (mode === 'quick') {
    document.getElementById('calculatorSection').classList.remove('hidden');
    document.getElementById('calcTitle').textContent = 'üßÆ Quick Calculator';
    document.querySelector('.auth-fields').style.display = 'none';
    document.getElementById('actionBtn').textContent = 'Calculate';
  } else if (mode === 'save') {
    document.getElementById('calculatorSection').classList.remove('hidden');
    document.getElementById('calcTitle').textContent = 'üíæ Save & Track';
    document.querySelector('.auth-fields').style.display = 'block';
    document.getElementById('actionBtn').textContent = 'Save & Calculate';
  } else if (mode === 'view') {
    document.getElementById('authSection').classList.remove('hidden');
  }
}

// ==========================================
// INITIATE CALCULATION
// ==========================================
function initiateCalculation() {
  const values = {
    billNumber: document.getElementById('billNumber')?.value,
    meterNumber: document.getElementById('meterNumber')?.value,
    accountNumber: document.getElementById('accountNumber')?.value,
    billFrom: document.getElementById('billFrom')?.value,
    billTo: document.getElementById('billTo')?.value,
    gross: parseFloat(document.getElementById('grossUnits')?.value),
    importU: parseFloat(document.getElementById('importUnits')?.value),
    exportU: parseFloat(document.getElementById('exportUnits')?.value),
    fixed: parseFloat(document.getElementById('fixedCharges')?.value),
    total: parseFloat(document.getElementById('totalBill')?.value),
    arrears: parseFloat(document.getElementById('arrears')?.value || 0)
  };
  
  if (currentMode === 'save') {
    if (!values.billNumber || !values.meterNumber || !values.accountNumber) {
      showErrorModal('Please fill Bill Number, Meter Number, and Account Number');
      return;
    }
  }
  
  if (isNaN(values.gross) || isNaN(values.importU) || isNaN(values.exportU) || 
      isNaN(values.fixed) || isNaN(values.total)) {
    showErrorModal('Please fill all required fields');
    return;
  }
  
  processCalculation(values);
}

// ==========================================
// PROCESS CALCULATION
// ==========================================
async function processCalculation(values) {
  const net = values.importU - values.exportU;
  const direct = values.gross - values.importU;
  const currentBill = values.total - values.arrears;
  const unitRate = (currentBill - values.fixed) / net;
  const billWithoutSolar = (values.gross * unitRate) + values.fixed;
  const saving = billWithoutSolar - currentBill;
  const savingPercent = (saving / billWithoutSolar) * 100;
  
  let days = null;
  let savingPerDay = null;
  let annualProjection = null;
  
  if (values.billFrom && values.billTo) {
    const from = new Date(values.billFrom);
    const to = new Date(values.billTo);
    const diffMs = to - from;
    if (diffMs > 0) {
      days = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
      savingPerDay = saving / days;
      annualProjection = savingPerDay * 365;
    }
  }
  
  const results = {
    ...values,
    net, direct, currentBill, unitRate, billWithoutSolar,
    saving, savingPercent, days, savingPerDay, annualProjection
  };
  
  const btn = document.getElementById('actionBtn');
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div>';
  
  if (currentMode === 'save') {
    const webhookData = {
      billNumber: values.billNumber,
      meterNumber: values.meterNumber,
      accountNumber: values.accountNumber,
      billPeriod: { from: values.billFrom, to: values.billTo, days },
      consumption: { grossUnits: values.gross, importUnits: values.importU, exportUnits: values.exportU },
      charges: { fixedCharges: values.fixed, totalBillAmount: values.total, arrears: values.arrears },
      calculation: { totalSaving: saving, savingPercentage: savingPercent, savingPerDay, annualSaving: annualProjection }
    };
    
    try {
      const response = await fetch('https://n8n-workflow-test.duckdns.org/webhook/solar-saving', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(webhookData)
      });
      
      if (response.ok) {
        const data = await response.json().catch(() => ({ status: 'success' }));
        
        if (data.status === 'error' && data.code === 'DUPLICATE_FOUND') {
          showErrorModal('Duplicate bill found!');
        } else {
          showSuccessModal('Bill saved successfully!');
          setTimeout(() => {
            closeModal();
            displayResults(results);
          }, 2000);
        }
      } else {
        throw new Error('Server error');
      }
    } catch (error) {
      console.error(error);
      showErrorModal('Failed to save. Showing results anyway.');
      setTimeout(() => {
        closeModal();
        displayResults(results);
      }, 2000);
    }
  } else {
    displayResults(results);
  }
  
  btn.disabled = false;
  btn.textContent = originalText;
}

// ==========================================
// DISPLAY RESULTS
// ==========================================
function displayResults(results) {
  document.getElementById('result').innerHTML = `
    <div class="result-card">
      <h3 style="color: #1e3a8a; margin-bottom: 1rem;">üí∞ Your Solar Savings</h3>
      <div class="stat-grid">
        <div class="stat-item" style="background: linear-gradient(135deg, #10b981, #059669);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Total Saving</div>
          <div style="font-size: 2rem; font-weight: 700;">‚Çπ${results.saving.toFixed(0)}</div>
        </div>
        <div class="stat-item" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Saving %</div>
          <div style="font-size: 2rem; font-weight: 700;">${results.savingPercent.toFixed(1)}%</div>
        </div>
        ${results.savingPerDay ? `
        <div class="stat-item" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Per Day</div>
          <div style="font-size: 2rem; font-weight: 700;">‚Çπ${results.savingPerDay.toFixed(0)}</div>
        </div>
        <div class="stat-item" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
          <div style="font-size: 0.85rem; opacity: 0.9;">Annual</div>
          <div style="font-size: 2rem; font-weight: 700;">‚Çπ${results.annualProjection.toFixed(0)}</div>
        </div>
        ` : ''}
      </div>
    </div>
  `;
}

// ==========================================
// AUTHENTICATION
// ==========================================
async function authenticateUser() {
  const meter = document.getElementById('authMeter').value;
  const account = document.getElementById('authAccount').value;
  
  if (!meter || !account) {
    showErrorModal('Please enter both credentials');
    return;
  }
  
  showSuccessModal('Authentication feature coming soon!');
}

// ==========================================
// MODAL FUNCTIONS
// ==========================================
function showModal(icon, title, message, buttons) {
  document.getElementById('modalIcon').textContent = icon;
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalMessage').innerHTML = message;
  
  const btnContainer = document.getElementById('modalButtons');
  btnContainer.innerHTML = '';
  buttons.forEach(btn => {
    const button = document.createElement('button');
    button.className = `modal-btn modal-btn-${btn.type}`;
    button.textContent = btn.text;
    button.onclick = btn.action;
    btnContainer.appendChild(button);
  });
  
  document.getElementById('customModal').classList.remove('hidden');
}

function closeModal() {
  document.getElementById('customModal').classList.add('hidden');
}

function showSuccessModal(msg) {
  showModal('‚úÖ', 'Success', msg, [{ text: 'OK', type: 'primary', action: closeModal }]);
}

function showErrorModal(msg) {
  showModal('‚ùå', 'Error', msg, [{ text: 'OK', type: 'primary', action: closeModal }]);
}

// ==========================================
// RESET
// ==========================================
function resetCalculator() {
  document.querySelectorAll('input').forEach(i => i.value = '');
  document.getElementById('result').innerHTML = '';
  document.getElementById('calculatorSection').classList.add('hidden');
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('dashboardSection').classList.add('hidden');
  document.getElementById('intentSelection').classList.remove('hidden');
  currentMode = 'quick';
}
</script>

</body>
</html>
