<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bill Scanner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    body {
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      padding: 1.5rem;
      font-family: Arial, sans-serif;
    }
    
    .scanner-container {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: 0 auto;
    }
    
    .upload-zone {
      border: 3px dashed #86efac;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f0fdf4;
    }
    
    .upload-zone:hover {
      background: #dcfce7;
      border-color: #10b981;
    }
    
    .upload-zone.dragover {
      background: #d1fae5;
      border-color: #059669;
    }
    
    .btn-primary-custom {
      background: linear-gradient(135deg, #10b981, #059669);
      border: none;
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .extracted-field {
      background: #f0fdf4;
      padding: 0.75rem;
      border-radius: 8px;
      border-left: 4px solid #10b981;
      margin-bottom: 0.5rem;
    }
    
    .field-label {
      color: #166534;
      font-weight: 700;
      font-size: 0.85rem;
      display: block;
      margin-bottom: 0.25rem;
    }
    
    .field-value {
      color: #0f172a;
      font-weight: 600;
      font-size: 1rem;
    }
  .verification-modal {
  display: none;
  position: fixed;
  z-index: 10000;
  background: rgba(0,0,0,0.8);
  /* ... full CSS in document */
}
  </style>
</head>
<body>

<div class="scanner-container">
  <!-- Header -->
  <div style="text-align: center; margin-bottom: 2rem;">
    <span style="font-size: 3rem;">üì∏</span>
    <h4 style="color: #166534; font-weight: 700; margin: 0.5rem 0;">
      Smart Bill Scanner (AI Powered)
    </h4>
    <p style="color: #64748b;">
      Upload your electricity bill for automatic AI extraction
    </p>
  </div>
   <!-- ADD DISCLAIMER HERE -->
  <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 16px; border-radius: 8px;">
    <div style="display: flex; align-items: start; gap: 10px;">
      <span style="font-size: 20px;">‚ö†Ô∏è</span>
      <div>
        <strong style="color: #856404;">AI Assistance - Please Verify</strong>
        <p style="color: #856404; margin: 4px 0 0 0; font-size: 13px;">
          This scanner uses AI to extract data. Please verify all fields carefully before saving.
        </p>
      </div>
    </div>
  </div>
  <!-- Upload Zone -->
  <div id="uploadZone" class="upload-zone" onclick="document.getElementById('fileInput').click()">
    <input type="file" 
           id="fileInput" 
           accept="image/*" 
           style="display: none;"
           onchange="handleFileSelect(event)">
    
    <div id="uploadPrompt">
      <span style="font-size: 3rem; display: block; margin-bottom: 1rem;">üì§</span>
      <h5 style="color: #166534;">Click to Upload Bill Image</h5>
      <p style="color: #64748b; margin: 0.5rem 0;">or drag and drop here</p>
      <small style="color: #94a3b8;">JPG, PNG ‚Ä¢ Max 5MB</small>
    </div>
    
    <div id="uploadPreview" style="display: none;">
      <img id="previewImg" style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 1rem;">
    </div>
  </div>
  
  <!-- Tips -->
  <div style="background: #fffbeb; border: 1.5px solid #fbbf24; border-radius: 8px; padding: 1rem; margin-top: 1.5rem;">
    <div style="display: flex; gap: 0.75rem;">
      <span style="font-size: 1.5rem;">üí°</span>
      <div>
        <strong style="color: #92400e; display: block; margin-bottom: 0.5rem;">
          Tips for Best Results:
        </strong>
        <ul style="color: #78350f; margin: 0; padding-left: 1.25rem; line-height: 1.8;">
          <li>Use clear, well-lit photos</li>
          <li>Avoid shadows and glare</li>
          <li>Include full bill in frame</li>
          <li>Keep text sharp and readable</li>
        </ul>
      </div>
    </div>
  </div>
  
  <!-- Progress -->
  <div id="progressSection" style="display: none; margin-top: 2rem;">
    <div style="text-align: center; margin-bottom: 1rem;">
      <div class="spinner-border text-success" role="status"></div>
      <p id="progressText" style="color: #166534; font-weight: 600; margin-top: 0.75rem;">
        Scanning bill...
      </p>
    </div>
    <div style="background: #e5e7eb; border-radius: 10px; height: 12px; overflow: hidden;">
      <div id="progressBar" 
           style="width: 0%; 
                  height: 100%; 
                  background: linear-gradient(90deg, #10b981, #059669); 
                  transition: width 0.3s;">
      </div>
    </div>
  </div>
     <!-- Results -->
  <div id="resultsSection" style="display: none; margin-top: 2rem;">
    <h5 style="color: #166534; margin-bottom: 1rem;">
      ‚úÖ Extracted Data
    </h5>
    <div id="extractedFieldsContainer"></div>
    
    <!-- Action Buttons -->
    <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center; flex-wrap: wrap;">
      <button onclick="confirmData()" class="btn-primary-custom">
        ‚úì Use This Data
      </button>
      <button onclick="resetScanner()" 
              style="background: #6b7280; color: white; border: none; padding: 0.75rem 2rem; border-radius: 12px; font-weight: 600; cursor: pointer;">
        ‚Üª Scan Again
      </button>
      <button onclick="cancelScan()" 
              style="background: #dc2626; color: white; border: none; padding: 0.75rem 2rem; border-radius: 12px; font-weight: 600; cursor: pointer;">
        ‚úï Cancel
      </button>
    </div>
  </div>
  
</div>

<script>
// ==========================================
// CONFIGURATION
// ==========================================
const N8N_WEBHOOK_URL = 'https://n8n-workflow-test.duckdns.org/webhook/scan-bill';

let extractedData = {};

// ==========================================
// DRAG AND DROP SUPPORT
// ==========================================
const uploadZone = document.getElementById('uploadZone');

uploadZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
  uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');
  
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    handleFile(files[0]);
  }
});

// ==========================================
// FILE HANDLING
// ==========================================
function handleFileSelect(event) {
  const file = event.target.files[0];
  if (file) {
    handleFile(file);
  }
}

function handleFile(file) {
  // Validate file
  if (!file.type.match('image.*')) {
    alert('Please upload an image file (JPG, PNG)');
    return;
  }
  
  if (file.size > 5 * 1024 * 1024) {
    alert('File size must be less than 5MB');
    return;
  }
  
  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('previewImg').src = e.target.result;
    document.getElementById('uploadPrompt').style.display = 'none';
    document.getElementById('uploadPreview').style.display = 'block';
  };
  reader.readAsDataURL(file);
  
  // Start AI scanning
  runAIScan(file);
}
// ==========================================
// IMAGE CROPPING FUNCTION
// ==========================================
async function cropBillImage(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      const img = new Image();
      
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        const originalWidth = img.width;
        const originalHeight = img.height;
        
        // CROP SETTINGS - Based on UHBVN bill layout
       const cropTopPercent = 0.10;      // Increase from 0.08
const cropBottomPercent = 0.45;   // Increase from 0.40
const cropLeftPercent = 0.03;     // Increase from 0.02
const cropRightPercent = 0.03;    // Increase from 0.02
        
        const cropTop = Math.floor(originalHeight * cropTopPercent);
        const cropBottom = Math.floor(originalHeight * cropBottomPercent);
        const cropLeft = Math.floor(originalWidth * cropLeftPercent);
        const cropRight = Math.floor(originalWidth * cropRightPercent);

        const newWidth = originalWidth - cropLeft - cropRight;
        const newHeight = originalHeight - cropTop - cropBottom;
        
        canvas.width = newWidth;
        canvas.height = newHeight;
        
        // Draw cropped image
        ctx.drawImage(
          img,
          cropLeft, cropTop, newWidth, newHeight,
          0, 0, newWidth, newHeight
        );
        
        // Resize if still too large (max 1600px width)
        let finalCanvas = canvas;
        if (newWidth > 1600) {
          const scale = 1600 / newWidth;
          finalCanvas = document.createElement('canvas');
          finalCanvas.width = 1600;
          finalCanvas.height = Math.floor(newHeight * scale);
          
          const finalCtx = finalCanvas.getContext('2d');
          finalCtx.drawImage(canvas, 0, 0, finalCanvas.width, finalCanvas.height);
        }
        
        // Convert to blob with compression
        finalCanvas.toBlob(
          function(blob) {
            const croppedFile = new File([blob], file.name, { type: 'image/jpeg' });
            
            console.log('‚úÇÔ∏è Image Cropping:');
            console.log('  Original:', (file.size / 1024).toFixed(0), 'KB');
            console.log('  Cropped:', (croppedFile.size / 1024).toFixed(0), 'KB');
            console.log('  Reduction:', (((file.size - croppedFile.size) / file.size) * 100).toFixed(0), '%');
             // ===== ADD THIS NEW CODE =====
    // Show cropped preview
    const previewUrl = URL.createObjectURL(blob);
    const previewImg = document.getElementById('previewImg');
    if (previewImg) {
      previewImg.src = previewUrl;
      previewImg.style.border = '3px solid #10b981';
      previewImg.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';
      
      // Add label
      const existingLabel = document.getElementById('cropLabel');
      if (existingLabel) existingLabel.remove();
      
      const label = document.createElement('div');
      label.id = 'cropLabel';
      label.style.cssText = 'background: #10b981; color: white; padding: 8px; border-radius: 6px; margin-top: 10px; text-align: center; font-weight: 600;';
      label.innerHTML = `‚úÇÔ∏è Cropped: ${(file.size / 1024).toFixed(0)} KB ‚Üí ${(croppedFile.size / 1024).toFixed(0)} KB (${(((file.size - croppedFile.size) / file.size) * 100).toFixed(0)}% smaller)`;
      
      previewImg.parentElement.appendChild(label);
    }
            resolve(croppedFile);
          },
          'image/jpeg',
          0.85  // 85% quality
        );
      };
      
      img.onerror = () => reject(new Error('Failed to load image'));
      img.src = e.target.result;
    };
    
    reader.onerror = () => reject(new Error('Failed to read file'));
    reader.readAsDataURL(file);
  });
}

// ==========================================
// AI SCANNING WITH N8N
// ==========================================
async function runAIScan(imageFile) {
  console.log('=== STARTING AI SCAN ===');
  console.log('File:', imageFile.name, imageFile.size, 'bytes');
  
  document.getElementById('progressSection').style.display = 'block';
  document.getElementById('resultsSection').style.display = 'none';
  
  try {
    updateScanStatus('Cropping image...', 10);
    
    // CROP IMAGE FIRST
    const croppedFile = await cropBillImage(imageFile);
    
    updateScanStatus('Preparing image...', 20);
    
    // Create FormData with cropped image
    const formData = new FormData();
    formData.append('data', croppedFile);
    
    console.log('FormData created');
    console.log('Sending to:', N8N_WEBHOOK_URL);
    
    updateScanStatus('Sending to AI...', 30);
    
    // Send to n8n webhook
    const response = await fetch(N8N_WEBHOOK_URL, {
      method: 'POST',
      body: formData
    });
    
    console.log('Response status:', response.status);
    console.log('Response headers:', [...response.headers.entries()]);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('Server error:', response.status, errorText);
      throw new Error(`Server error: ${response.status} - ${errorText}`);
    }
    
    updateScanStatus('Processing response...', 70);
    
    const result = await response.json();
    
    console.log('=== AI RESPONSE ===');
    console.log(JSON.stringify(result, null, 2));
    
    if (result.success && result.data) {
      extractedData = result.data;
      
      console.log('=== EXTRACTED DATA ===');
      console.log(extractedData);
      
      updateScanStatus('Complete!', 100);
      
      // Display results
      setTimeout(() => {
        displayResults();
      }, 500);
    } else {
      console.error('Invalid response format:', result);
      throw new Error('No data extracted from AI');
    }
    
  } catch (error) {
    console.error('=== SCAN ERROR ===');
    console.error('Error:', error);
    console.error('Stack:', error.stack);
    
    alert('Failed to scan bill:\n' + error.message + '\n\nPlease check:\n1. n8n workflow is active\n2. Webhook URL is correct\n3. Network connection\n4. Browser console for details');
    
    resetScanner();
  }
}

function updateScanStatus(message, progress) {
  const statusEl = document.getElementById('progressText');
  const progressEl = document.getElementById('progressBar');
  
  if (statusEl) statusEl.textContent = message;
  if (progressEl) progressEl.style.width = progress + '%';
  
  console.log(`Progress: ${progress}% - ${message}`);
}

// ==========================================
// DISPLAY RESULTS
// ==========================================
function displayResults() {
  const container = document.getElementById('extractedFieldsContainer');
  
  if (Object.keys(extractedData).length === 0) {
    container.innerHTML = `
      <div style="color: #dc2626; text-align: center; padding: 1rem;">
        ‚ùå No data extracted. Please try with a clearer image.
      </div>
    `;
  } else {
    let html = '<div style="display: grid; grid-template-columns: 1fr; gap: 0.5rem;">';
        // ADD DISCLAIMER AT TOP OF RESULTS
    html += `
      <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px 12px; margin-bottom: 16px; border-radius: 6px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 18px;">‚ö†Ô∏è</span>
          <strong style="color: #856404; font-size: 13px;">Verify Before Using</strong>
        </div>
        <p style="color: #856404; margin: 6px 0 0 0; font-size: 12px;">
          AI can make mistakes. Please check all values against your bill.
        </p>
      </div>
    `;
    
    html += '<div style="display: grid; grid-template-columns: 1fr; gap: 0.5rem;">';
    const fieldLabels = {
      billNumber: 'üìÑ Bill Number',
      meterNumber: 'üìü Meter Number',
      accountNumber: 'üîë Account Number',
      solarGenerated: '‚òÄÔ∏è Solar Generated',
      exportUnits: 'üì§ Export Units',
      importUnits: 'üì• Import Units',
      grossUnits: '‚ö° Gross Units (Total Consumed)',
      totalBill: 'üí∞ Total Amount',
      billFrom: 'üìÖ From Date',
      billTo: 'üìÖ To Date',
      fixedCharges: '‚Çπ Fixed Charges',
      arrears: 'üìã Arrears'
    };
    
    // Show in specific order
    const fieldOrder = [
      'billNumber', 'accountNumber', 'meterNumber',
      'billFrom', 'billTo',
      'grossUnits', 'importUnits', 'exportUnits', 'solarGenerated',
      'totalBill', 'fixedCharges', 'arrears'
    ];
    
    for (let key of fieldOrder) {
      const value = extractedData[key];
      if (value) {
        html += `
          <div class="extracted-field">
            <span class="field-label">${fieldLabels[key]}</span>
            <span class="field-value">${value}</span>
          </div>
        `;
      }
    }
    
    html += '</div>';
    container.innerHTML = html;
  }
  
  document.getElementById('progressSection').style.display = 'none';
  document.getElementById('resultsSection').style.display = 'block';
}

// ==========================================
// ACTIONS
// ==========================================
function confirmData() {
  console.log('Sending data to parent:', extractedData);
  
  // Send data to parent window
  window.parent.postMessage({
    type: 'SCAN_COMPLETE',
    payload: extractedData
  }, '*');
}

function cancelScan() {
  console.log('Scan cancelled by user');
  
  window.parent.postMessage({
    type: 'SCAN_CANCELLED'
  }, '*');
}

function resetScanner() {
  console.log('Resetting scanner');
  
  extractedData = {};
  document.getElementById('fileInput').value = '';
  document.getElementById('uploadPrompt').style.display = 'block';
  document.getElementById('uploadPreview').style.display = 'none';
  document.getElementById('progressSection').style.display = 'none';
  document.getElementById('resultsSection').style.display = 'none';
}

// ==========================================
// DEBUG INFO
// ==========================================
console.log('=== BILL SCANNER INITIALIZED ===');
console.log('n8n Webhook URL:', N8N_WEBHOOK_URL);
console.log('Ready to scan!');
</script>

</body>
</html>
